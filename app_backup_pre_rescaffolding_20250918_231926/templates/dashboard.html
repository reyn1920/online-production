<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRAE.AI Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/build.css') }}" rel="stylesheet">
    <style>
        .pulse-dot { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .glass-effect { backdrop-filter: blur(10px); background: rgba(255, 255, 255, 0.9); }
        .lazy-load { opacity: 0; transition: opacity 0.3s ease-in-out; }
        .lazy-load.loaded { opacity: 1; }
        .skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: loading 1.5s infinite; }
        .skeleton-text { height: 1rem; border-radius: 4px; margin-bottom: 0.5rem; }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .gpu-accelerated { transform: translateZ(0); will-change: transform; }
        .optimized-scroll { -webkit-overflow-scrolling: touch; scroll-behavior: smooth; }
        .d-none { display: none !important; }
        
        /* Avatar Styles */
        .avatar-container {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 8px;
            backdrop-filter: blur(10px);
        }
        
        .avatar-display {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .avatar-preview-mini {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            overflow: hidden;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            border: 2px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }
        
        .avatar-preview-mini:hover {
            transform: scale(1.05);
            border-color: rgba(255, 255, 255, 0.6);
        }
        
        .avatar-preview-mini img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .avatar-placeholder {
            color: rgba(255, 255, 255, 0.8);
        }
        
        .avatar-controls {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .avatar-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 6px;
            padding: 6px;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 12px;
        }
        
        .avatar-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }
        
        .avatar-btn:active {
            transform: translateY(0);
        }
        
        .avatar-generating {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation Header -->
    <nav class="gradient-bg text-white shadow-xl">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <i class="fas fa-tachometer-alt text-2xl"></i>
                    <h1 class="text-2xl font-bold">TRAE.AI Dashboard</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <div class="pulse-dot w-3 h-3 bg-green-400 rounded-full"></div>
                        <span class="text-sm">Live</span>
                    </div>
                    <div id="user-info" class="hidden text-white">
                        <span id="user-name"></span>
                        <button id="logout-btn" class="ml-4 bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition-all duration-200">
                            <i class="fas fa-sign-out-alt mr-1"></i>Logout
                        </button>
                    </div>
                    <div class="text-sm">
                        <span id="currentTime"></span>
                    </div>
                </div>
                
                <!-- Avatar Component -->
                <div class="avatar-container ml-6">
                    <div class="avatar-display" id="dashboard-avatar">
                        <div class="avatar-preview-mini" id="avatar-preview-mini">
                            <div class="avatar-placeholder">
                                <i class="fas fa-user-circle text-3xl text-gray-400"></i>
                            </div>
                        </div>
                        <div class="avatar-controls">
                            <button class="avatar-btn" id="generate-dashboard-avatar" title="Generate Avatar">
                                <i class="fas fa-magic"></i>
                            </button>
                            <button class="avatar-btn" id="avatar-settings" title="Avatar Settings">
                                <i class="fas fa-cog"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Login Modal -->
    <div id="login-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
            <div class="text-center mb-6">
                <i class="fas fa-lock text-4xl text-blue-600 mb-4"></i>
                <h2 class="text-2xl font-bold text-gray-800">Login Required</h2>
                <p class="text-gray-600">Please sign in to access the dashboard</p>
            </div>
            
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                    <input type="text" id="username" name="username" required value="reyn1920"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="password" name="password" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <div class="flex items-center">
                    <input type="checkbox" id="remember-me" name="remember" 
                           class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <label for="remember-me" class="ml-2 block text-sm text-gray-700">
                        Remember me
                    </label>
                </div>
                
                <div id="login-error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                    <span id="login-error-message"></span>
                </div>
                
                <button type="submit" id="login-submit" 
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-all duration-200">
                    <i class="fas fa-sign-in-alt mr-2"></i>Sign In
                </button>
            </form>
            
            <div class="mt-6 text-center text-sm text-gray-600">
                <p>Default credentials:</p>
                <p class="font-mono bg-gray-100 p-2 rounded mt-2">
                    Username: reyn1920<br>
                    Password: $Vessel56
                </p>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-6 py-8">
        <!-- Tab Navigation -->
        <div class="mb-8">
            <div class="flex space-x-2 bg-white rounded-xl p-2 shadow-md">
                <div class="nav-tab active" data-tab="overview">
                    <i class="fas fa-chart-line mr-2"></i>Overview
                </div>
                <div class="nav-tab" data-tab="analytics">
                    <i class="fas fa-chart-bar mr-2"></i>Analytics
                </div>
                <div class="nav-tab" data-tab="services">
                    <i class="fas fa-cogs mr-2"></i>Services
                </div>
                <div class="nav-tab" data-tab="system">
                    <i class="fas fa-server mr-2"></i>System
                </div>
                <div class="nav-tab" data-tab="logs">
                    <i class="fas fa-file-alt mr-2"></i>Logs
                </div>
                <div class="nav-tab" data-tab="users">
                    <i class="fas fa-users mr-2"></i>Users
                </div>
            </div>
        </div>
        
        <!-- Tab Content -->
        <div id="overview-tab" class="tab-content">
            <!-- Enhanced Metrics Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8 lazy-load" data-chart-type="overview-metrics">
                <div class="metric-card gpu-accelerated">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-700">System Status</h3>
                        <i class="fas fa-heartbeat text-2xl text-green-500"></i>
                    </div>
                    <div class="status-healthy px-4 py-2 rounded-full text-sm font-medium inline-flex items-center">
                        <div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
                        Operational
                    </div>
                    <p class="text-xs text-gray-500 mt-2">All systems running normally</p>
                    <div class="skeleton skeleton-text d-none" id="system-status-skeleton"></div>
                </div>
                <div class="metric-card gpu-accelerated">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-700">Uptime</h3>
                        <i class="fas fa-clock text-2xl text-blue-500"></i>
                    </div>
                    <p class="text-3xl font-bold text-green-600" id="uptimeValue">99.9%</p>
                    <p class="text-xs text-gray-500 mt-2">Last 30 days</p>
                    <div class="skeleton skeleton-text d-none" id="uptime-skeleton"></div>
                </div>
                <div class="metric-card gpu-accelerated">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-700">Active Sessions</h3>
                        <i class="fas fa-users text-2xl text-purple-500"></i>
                    </div>
                    <p class="text-3xl font-bold text-blue-600" id="activeSessionsValue">45</p>
                    <p class="text-xs text-gray-500 mt-2">+12% from yesterday</p>
                    <div class="skeleton skeleton-text d-none" id="active-sessions-skeleton"></div>
                </div>
                <div class="metric-card gpu-accelerated">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-700">API Calls Today</h3>
                        <i class="fas fa-exchange-alt text-2xl text-orange-500"></i>
                    </div>
                    <p class="text-3xl font-bold text-purple-600" id="apiCallsValue">8,750</p>
                    <p class="text-xs text-gray-500 mt-2">+5.2% from yesterday</p>
                    <div class="skeleton skeleton-text d-none" id="api-calls-skeleton"></div>
                </div>
            </div>

            <!-- Real-time Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8 lazy-load" data-chart-type="realtime-charts">
                <div class="chart-container">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">API Usage (Last 24h)</h3>
                    <canvas id="apiUsageChart" width="400" height="200" data-chart-type="api-usage-chart"></canvas>
                    <div class="skeleton d-none" id="api-usage-chart-skeleton" style="height: 200px;"></div>
                </div>
                <div class="chart-container">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">System Performance</h3>
                    <canvas id="performanceChart" width="400" height="200" data-chart-type="performance-chart"></canvas>
                    <div class="skeleton d-none" id="performance-chart-skeleton" style="height: 200px;"></div>
                </div>
            </div>
        </div>
        
        <!-- Analytics Tab -->
        <div id="analytics-tab" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8 lazy-load" data-chart-type="analytics-dashboard">
                <div class="chart-container lg:col-span-2">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Revenue Analytics</h3>
                    <canvas id="revenueChart" width="600" height="300" data-chart-type="revenue-chart"></canvas>
                    <div class="skeleton d-none" id="revenue-chart-skeleton" style="height: 300px;"></div>
                </div>
                <div class="chart-container">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">User Growth</h3>
                    <canvas id="userGrowthChart" width="300" height="300" data-chart-type="user-growth-chart"></canvas>
                    <div class="skeleton d-none" id="user-growth-chart-skeleton" style="height: 300px;"></div>
                </div>
            </div>
        </div>

        <!-- Services Tab -->
        <div id="services-tab" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8 lazy-load" data-chart-type="services-status">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Services Status</h2>
                    <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors" onclick="refreshServices()">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 optimized-scroll" id="servicesGrid">
                    <!-- Services will be populated by JavaScript -->
                    <div class="d-none" id="services-skeleton">
                        <div class="skeleton skeleton-text"></div>
                        <div class="skeleton skeleton-text"></div>
                        <div class="skeleton skeleton-text"></div>
                        <div class="skeleton skeleton-text"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Tab -->
        <div id="system-tab" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 lazy-load" data-chart-type="system-metrics">
                <div class="bg-white rounded-xl shadow-lg p-6 gpu-accelerated">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">System Resources</h3>
                    <div id="systemInfo" class="space-y-4 optimized-scroll">
                        <!-- System info will be populated by JavaScript -->
                        <div class="d-none" id="system-info-skeleton">
                            <div class="skeleton skeleton-text"></div>
                            <div class="skeleton skeleton-text"></div>
                            <div class="skeleton skeleton-text"></div>
                            <div class="skeleton skeleton-text"></div>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Performance Metrics</h3>
                    <canvas id="systemMetricsChart" width="400" height="300" data-chart-type="system-metrics-chart"></canvas>
                    <div class="skeleton d-none" id="system-metrics-chart-skeleton" style="height: 300px;"></div>
                </div>
            </div>
        </div>

        <!-- Logs Tab -->
        <div id="logs-tab" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-6 lazy-load" data-chart-type="system-logs">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">System Logs</h2>
                    <div class="flex space-x-2">
                        <select class="border border-gray-300 rounded-lg px-3 py-2" id="logLevel">
                            <option value="all">All Levels</option>
                            <option value="error">Error</option>
                            <option value="warning">Warning</option>
                            <option value="info">Info</option>
                        </select>
                        <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors" onclick="refreshLogs()">
                            <i class="fas fa-sync-alt mr-2"></i>Refresh
                        </button>
                    </div>
                </div>
                <div class="bg-gray-900 text-green-400 p-4 rounded-lg font-mono text-sm h-96 overflow-y-auto optimized-scroll" id="logContainer">
                    <!-- Logs will be populated by JavaScript -->
                    <div class="d-none" id="logs-skeleton">
                        <div class="skeleton skeleton-text"></div>
                        <div class="skeleton skeleton-text"></div>
                        <div class="skeleton skeleton-text"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Users Tab -->
        <div id="users-tab" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold">User Management</h3>
                    <button id="add-user-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-all duration-200">
                        <i class="fas fa-plus mr-2"></i>Add User
                    </button>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full table-auto">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Username</th>
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Email</th>
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Role</th>
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Status</th>
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body" class="divide-y divide-gray-200">
                            <!-- Users will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Add/Edit User Modal -->
        <div id="user-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
                <div class="flex justify-between items-center mb-6">
                    <h3 id="user-modal-title" class="text-xl font-semibold">Add User</h3>
                    <button id="close-user-modal" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form id="user-form" class="space-y-4">
                    <input type="hidden" id="user-id" name="user_id">
                    
                    <div>
                        <label for="user-username" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                        <input type="text" id="user-username" name="username" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label for="user-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="user-email" name="email" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label for="user-full-name" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                        <input type="text" id="user-full-name" name="full_name" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label for="user-role" class="block text-sm font-medium text-gray-700 mb-1">Role</label>
                        <select id="user-role" name="role" required 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="VIEWER">Viewer</option>
                            <option value="EDITOR">Editor</option>
                            <option value="ADMIN">Admin</option>
                        </select>
                    </div>
                    
                    <div id="password-section">
                        <label for="user-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input type="password" id="user-password" name="password" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <p class="text-sm text-gray-500 mt-1">Leave blank to keep current password (edit mode)</p>
                    </div>
                    
                    <div id="user-form-error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                        <span id="user-form-error-message"></span>
                    </div>
                    
                    <div class="flex space-x-3">
                        <button type="button" id="cancel-user-form" 
                                class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 font-medium py-2 px-4 rounded-lg transition-all duration-200">
                            Cancel
                        </button>
                        <button type="submit" id="save-user" 
                                class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-all duration-200">
                            <i class="fas fa-save mr-2"></i>Save
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- File Manager Modal -->
        <div id="file-manager-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-4xl max-h-[90vh] overflow-hidden">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold">File Manager - Downloads Integration</h3>
                    <button id="close-file-manager" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 h-full">
                    <!-- File Upload Section -->
                    <div class="space-y-4">
                        <h4 class="text-lg font-medium text-gray-800">Upload Files</h4>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                            <input type="file" id="file-upload" class="hidden" multiple>
                            <div id="drop-zone" class="cursor-pointer">
                                <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                                <p class="text-gray-600">Click to select files or drag and drop</p>
                                <p class="text-sm text-gray-500 mt-2">Supported: txt, pdf, images, docs, code files</p>
                            </div>
                        </div>
                        <div id="upload-progress" class="hidden">
                            <div class="bg-gray-200 rounded-full h-2">
                                <div id="upload-progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                            </div>
                            <p id="upload-status" class="text-sm text-gray-600 mt-2">Uploading...</p>
                        </div>
                    </div>
                    
                    <!-- Files List Section -->
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <h4 class="text-lg font-medium text-gray-800">Downloads Files</h4>
                            <button id="refresh-files" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
                                <i class="fas fa-sync-alt mr-1"></i>Refresh
                            </button>
                        </div>
                        <div id="files-list" class="max-h-96 overflow-y-auto border rounded-lg">
                            <div class="p-4 text-center text-gray-500">
                                <i class="fas fa-spinner fa-spin mr-2"></i>Loading files...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Paste Integration Modal -->
        <div id="paste-integration-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-3xl max-h-[90vh] overflow-hidden">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold">Paste Integration & Avatar Generation</h3>
                    <button id="close-paste-integration" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="space-y-6">
                    <!-- Paste Content Section -->
                    <div>
                        <h4 class="text-lg font-medium text-gray-800 mb-3">Create Paste Content</h4>
                        <textarea id="paste-content" class="w-full h-32 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Enter your content here..."></textarea>
                        <div class="flex space-x-3 mt-3">
                            <button id="save-paste" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                                <i class="fas fa-save mr-2"></i>Save Paste
                            </button>
                            <button id="load-from-file" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">
                                <i class="fas fa-file-import mr-2"></i>Load from Downloads
                            </button>
                        </div>
                    </div>
                    
                    <!-- Avatar Generation Section -->
                    <div class="border-t pt-6">
                        <h4 class="text-lg font-medium text-gray-800 mb-3">Avatar Generation</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Avatar Type</label>
                                <select id="avatar-type" class="w-full p-2 border border-gray-300 rounded-lg">
                                    <option value="professional">Professional</option>
                                    <option value="casual">Casual</option>
                                    <option value="animated">Animated</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Voice Style</label>
                                <select id="voice-style" class="w-full p-2 border border-gray-300 rounded-lg">
                                    <option value="natural">Natural</option>
                                    <option value="energetic">Energetic</option>
                                    <option value="calm">Calm</option>
                                </select>
                            </div>
                        </div>
                        <button id="generate-avatar" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg">
                            <i class="fas fa-magic mr-2"></i>Generate Avatar
                        </button>
                        <div id="avatar-result" class="mt-4 hidden">
                            <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded">
                                <p id="avatar-message">Avatar generated successfully!</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Integration Status -->
                    <div class="border-t pt-6">
                        <h4 class="text-lg font-medium text-gray-800 mb-3">Integration Status</h4>
                        <div id="paste-service-status" class="flex items-center space-x-2">
                            <div id="paste-status-indicator" class="w-3 h-3 rounded-full bg-gray-400"></div>
                            <span id="paste-status-text" class="text-sm text-gray-600">Checking paste service...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Quick Actions Panel -->
        <div class="fixed bottom-6 right-6 z-50">
            <div class="bg-white rounded-xl shadow-xl p-4 glass-effect">
                <h3 class="text-lg font-bold text-gray-800 mb-3">Quick Actions</h3>
                <div class="flex flex-col space-y-2">
                    <button class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors text-sm" onclick="refreshAllData()">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh Data
                    </button>
                    <button class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition-colors text-sm" onclick="runHealthCheck()">
                        <i class="fas fa-heartbeat mr-2"></i>Health Check
                    </button>
                    <button class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded-lg transition-colors text-sm" onclick="exportData()">
                        <i class="fas fa-download mr-2"></i>Export Data
                    </button>
                    <button id="run-tests" class="bg-yellow-600 hover:bg-yellow-700 text-white font-medium py-2 px-4 rounded-lg transition-colors text-sm" onclick="runDashboardTests()">
                        <i class="fas fa-flask mr-2"></i>Run Tests
                    </button>
                    <button class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-lg transition-colors text-sm" onclick="showFileManager()">
                        <i class="fas fa-folder mr-2"></i>File Manager
                    </button>
                    <button class="bg-teal-600 hover:bg-teal-700 text-white font-medium py-2 px-4 rounded-lg transition-colors text-sm" onclick="showPasteIntegration()">
                        <i class="fas fa-clipboard mr-2"></i>Paste Integration
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="/static/js/dashboard.js?v=1.1"></script>
    <script src="/static/js/paste_avatar_ui.js"></script>
    <script>//Dashboard Personal Assistant Avatar
        class DashboardAvatar {
            constructor() {
                this.avatarUI = null;
                this.isListening = false;
                this.conversationHistory = [];
                this.userId = 'dashboard_user_' + Date.now();
                this.init();
            }
            
            async init() {//Initialize avatar UI when needed
                document.getElementById('generate-dashboard-avatar').addEventListener('click', () => {
                    this.generateAvatar();
                });
                
                document.getElementById('avatar-settings').addEventListener('click', () => {
                    this.showAvatarSettings();
                });//Add chat functionality
                this.initializeChat();//Load existing avatar if available
                this.loadExistingAvatar();
            }
            
            initializeChat() {//Add click handler to avatar for chat
                document.getElementById('avatar-preview-mini').addEventListener('click', () => {
                    this.toggleChat();
                });//Create chat interface
                this.createChatInterface();
            }
            
            createChatInterface() {
                const chatInterface = document.createElement('div');
                chatInterface.id = 'avatar-chat-interface';
                chatInterface.className = 'fixed bottom-20 right-4 w-80 bg-white rounded-lg shadow-xl border hidden z-50';
                chatInterface.innerHTML = `
                    <div class="bg-blue-600 text-white p-3 rounded-t-lg flex justify-between items-center">
                        <h4 class="font-semibold">Personal Assistant</h4>
                        <button onclick="dashboardAvatar.toggleChat()" class="text-white hover:text-gray-200">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="h-64 overflow-y-auto p-3 space-y-2" id="chat-messages"></div>
                    <div class="p-3 border-t">
                        <div class="flex space-x-2">
                            <input type="text" id="chat-input" placeholder="Ask me anything..." 
                                   class="flex-1 border border-gray-300 rounded px-3 py-2 text-sm" 
                                   onkeypress="if(event.key==='Enter') dashboardAvatar.sendMessage()">
                            <button onclick="dashboardAvatar.sendMessage()" 
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-sm">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                        <div class="mt-2 flex space-x-1">
                            <button onclick="dashboardAvatar.quickAction('status')" class="text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded">System Status</button>
                            <button onclick="dashboardAvatar.quickAction('help')" class="text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded">Help</button>
                            <button onclick="dashboardAvatar.quickAction('tasks')" class="text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded">Tasks</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(chatInterface);//Add welcome message
                this.addChatMessage('assistant', 'Hello! I\'m your personal assistant. I can help you with system status, tasks, and answer questions about your dashboard.');
            }
            
            toggleChat() {
                const chatInterface = document.getElementById('avatar-chat-interface');
                chatInterface.classList.toggle('hidden');
                
                if (!chatInterface.classList.contains('hidden')) {
                    document.getElementById('chat-input').focus();
                }
            }
            
            async sendMessage() {
                const input = document.getElementById('chat-input');
                const message = input.value.trim();
                
                if (!message) return;//Add user message to chat
                this.addChatMessage('user', message);
                input.value = '';//Show typing indicator
                this.showTypingIndicator();
                
                try { // Send to AI chat endpoint
                    const response = await fetch('/chat/ai', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: this.enhanceMessageWithContext(message),
                            context: {
                                user_id: this.userId,
                                dashboard_context: this.getDashboardContext(),
                                conversation_history: this.conversationHistory.slice(-5)
                            },
                            provider: 'openai'
                        })
                    });
                    
                    const result = await response.json();
                    
                    this.hideTypingIndicator();
                    
                    if (result.response) {
                        this.addChatMessage('assistant', result.response);
                        this.conversationHistory.push({user: message, assistant: result.response});
                    } else {
                        this.addChatMessage('assistant', 'I\'m sorry, I couldn\'t process your request right now.');
                    }
                } catch (error) {
                    this.hideTypingIndicator();
                    console.error('Chat error:', error);
                    this.addChatMessage('assistant', 'I encountered an error. Please try again.');
                }
            }
            
            enhanceMessageWithContext(message) {
                const context = this.getDashboardContext();
                return `As a personal assistant for the TRAE.AI dashboard, please help with: ${message}\n\nCurrent dashboard context: ${JSON.stringify(context)}`;
            }
            
            getDashboardContext() {//Gather current dashboard state
                const activeTab = document.querySelector('.tab-button.active')?.textContent || 'overview';
                const systemStatus = document.querySelector('.status-indicator')?.textContent || 'unknown';
                
                return {
                    active_tab: activeTab,
                    system_status: systemStatus,
                    timestamp: new Date().toISOString()
                };
            }
            
            async quickAction(action) {
                switch(action) {
                    case 'status':
                        this.addChatMessage('user', 'What is the current system status?');
                        this.sendSystemStatusUpdate();
                        break;
                    case 'help':
                        this.addChatMessage('assistant', 'I can help you with:\n• System monitoring and status\n• Task management\n• Dashboard navigation\n• General questions about your application\n\nJust ask me anything!');
                        break;
                    case 'tasks':
                        this.addChatMessage('user', 'Show me current tasks and system activities');
                        this.sendTasksUpdate();
                        break;
                }
            }
            
            async sendSystemStatusUpdate() {
                try {
                    const response = await fetch('/dashboard/api/status');
                    const status = await response.json();
                    
                    const statusMessage = `System Status:\n• Uptime: ${status.uptime || 'Unknown'}\n• Active Sessions: ${status.active_sessions || 0}\n• API Calls: ${status.api_calls || 0}\n• Status: ${status.status || 'Running'}`;
                    
                    this.addChatMessage('assistant', statusMessage);
                } catch (error) {
                    this.addChatMessage('assistant', 'Unable to fetch system status at the moment.');
                }
            }
            
            async sendTasksUpdate() {
                const tasksMessage = 'Current system activities:\n• Dashboard monitoring: Active\n• Content generation: Running\n• Avatar system: Operational\n• API services: Online\n\nAll systems are functioning normally.';
                this.addChatMessage('assistant', tasksMessage);
            }
            
            addChatMessage(sender, message) {
                const messagesContainer = document.getElementById('chat-messages');
                const messageDiv = document.createElement('div');
                messageDiv.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
                
                const messageBubble = document.createElement('div');
                messageBubble.className = `max-w-xs px-3 py-2 rounded-lg text-sm ${
                    sender === 'user' 
                        ? 'bg-blue-600 text-white' 
                        : 'bg-gray-100 text-gray-800'
                }`;
                messageBubble.style.whiteSpace = 'pre-wrap';
                messageBubble.textContent = message;
                
                messageDiv.appendChild(messageBubble);
                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
            
            showTypingIndicator() {
                const indicator = document.createElement('div');
                indicator.id = 'typing-indicator';
                indicator.className = 'flex justify-start';
                indicator.innerHTML = `
                    <div class="bg-gray-100 text-gray-600 px-3 py-2 rounded-lg text-sm">
                        <i class="fas fa-circle-notch fa-spin"></i> Thinking...
                    </div>
                `;
                document.getElementById('chat-messages').appendChild(indicator);
                document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;
            }
            
            hideTypingIndicator() {
                const indicator = document.getElementById('typing-indicator');
                if (indicator) {
                    indicator.remove();
                }
            }
            
            async generateAvatar() {
                const btn = document.getElementById('generate-dashboard-avatar');
                const preview = document.getElementById('avatar-preview-mini');
                
                try {
                    btn.disabled = true;
                    preview.classList.add('avatar-generating');//Get sample content for avatar generation
                    const sampleContent = "Welcome to the dashboard! I'm your AI assistant ready to help you manage your system.";
                    
                    const response = await fetch('/paste/avatar/generate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            content: sampleContent,
                            avatar_type: 'standard',
                            voice_style: 'professional',
                            quality: 'high',
                            template: 'professional_presenter'
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success && result.avatar_url) {
                        this.displayAvatar(result.avatar_url);
                        this.showNotification('Avatar generated successfully!', 'success');
                    } else {
                        this.showNotification('Failed to generate avatar', 'error');
                    }
                } catch (error) {
                    console.error('Avatar generation error:', error);
                    this.showNotification('Error generating avatar', 'error');
                } finally {
                    btn.disabled = false;
                    preview.classList.remove('avatar-generating');
                }
            }
            
            displayAvatar(avatarUrl) {
                const preview = document.getElementById('avatar-preview-mini');
                preview.innerHTML = `<img src="${avatarUrl}" alt="Dashboard Avatar"/>`;//Store avatar URL for persistence
                localStorage.setItem('dashboard_avatar_url', avatarUrl);
            }
            
            loadExistingAvatar() {
                const savedAvatarUrl = localStorage.getItem('dashboard_avatar_url');
                if (savedAvatarUrl) {
                    this.displayAvatar(savedAvatarUrl);
                }
            }
            
            showAvatarSettings() {//Create a simple settings modal
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">Avatar Settings</h3>
                            <button class="text-gray-500 hover:text-gray-700" onclick="this.closest('.fixed').remove()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Avatar Style</label>
                                <select class="w-full border border-gray-300 rounded-lg px-3 py-2" id="avatar-style-select">
                                    <option value="professional">Professional</option>
                                    <option value="casual">Casual</option>
                                    <option value="tech">Tech Expert</option>
                                    <option value="friendly">Friendly</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Voice Style</label>
                                <select class="w-full border border-gray-300 rounded-lg px-3 py-2" id="voice-style-select">
                                    <option value="professional">Professional</option>
                                    <option value="natural">Natural</option>
                                    <option value="casual">Casual</option>
                                    <option value="dramatic">Dramatic</option>
                                </select>
                            </div>
                            <div class="flex space-x-3 pt-4">
                                <button class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg" onclick="dashboardAvatar.applySettings(); this.closest('.fixed').remove();">
                                    Apply
                                </button>
                                <button class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-lg" onclick="this.closest('.fixed').remove()">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            applySettings() {
                const style = document.getElementById('avatar-style-select').value;
                const voice = document.getElementById('voice-style-select').value;//Store settings
                localStorage.setItem('avatar_style', style);
                localStorage.setItem('avatar_voice', voice);
                
                this.showNotification('Settings saved! Generate a new avatar to apply changes.', 'info');
            }
            
            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-lg text-white transition-all duration-300 ${
                    type === 'success' ? 'bg-green-500' : 
                    type === 'error' ? 'bg-red-500' : 'bg-blue-500'
                }`;
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.opacity = '0';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }
        }//Initialize dashboard avatar when page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.dashboardAvatar = new DashboardAvatar();
        });//Function to run dashboard tests
        function runDashboardTests() {
            if (window.dashboardTester) {
                console.clear();
                console.log('🔄 Running Dashboard Tests...');
                window.dashboardTester.runAllTests();
            } else {
                console.log('⚠️ Dashboard tester not available. Creating new instance...');
                const tester = new DashboardTester();
                window.dashboardTester = tester;
                tester.runAllTests();
            }
        }
    </script>
    
    <script>//Enhanced Dashboard Initialization
        document.addEventListener('DOMContentLoaded', function() {
            initializeDashboard();
        });

        function initializeDashboard() {
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            
            setupTabNavigation();
            initializeCharts();
            loadDashboardData();//Auto-refresh data every 30 seconds
            setInterval(loadDashboardData, 30000);
        }

        function updateCurrentTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleTimeString();
        }

        function setupTabNavigation() {
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.dataset.tab;
                    switchTab(tabName);
                });
            });
        }

        function switchTab(tabName) {//Update active tab
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');//Show/hide tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(`${tabName}-tab`).classList.remove('hidden');
        }

        async function loadDashboardData() {
            try {
                const [metrics, services, systemInfo] = await Promise.all([
                    fetch("/dashboard/api/metrics').then(r => r.json()),
                    fetch("/dashboard/api/services').then(r => r.json()),
                    fetch("/dashboard/api/system-info').then(r => r.json())
                ]);
                
                updateMetrics(metrics.metrics);
                updateServices(services.services);
                updateSystemInfo(systemInfo.system_info);
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        function updateMetrics(metrics) {
            document.getElementById('activeSessionsValue').textContent = metrics.active_sessions.toLocaleString();
            document.getElementById('apiCallsValue').textContent = metrics.api_calls_today.toLocaleString();
        }

        function updateServices(services) {
            const grid = document.getElementById('servicesGrid');
            if (!grid) return;
            
            grid.innerHTML = Object.entries(services).map(([key, service]) => `
                <div class="service-card">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-semibold text-gray-700 capitalize">${key.replace('_', ' ')}</h3>
                        <i class="fas fa-${getServiceIcon(key)} text-xl text-blue-500"></i>
                    </div>
                    <div class="status-healthy px-3 py-1 rounded-full text-sm font-medium inline-flex items-center mb-2">
                        <div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
                        ${service.status}
                    </div>
                    <p class="text-xs text-gray-500">Last run: ${new Date(service.last_run).toLocaleString()}</p>
                </div>
            `).join('');
        }

        function getServiceIcon(service) {
            const icons = {
                youtube_automation: 'video',
                content_pipeline: 'stream',
                marketing_agent: 'bullhorn',
                financial_tracking: 'chart-line'
            };
            return icons[service] || 'cog';
        }

        function updateSystemInfo(systemInfo) {
            const container = document.getElementById('systemInfo');
            if (!container || !systemInfo) return;
            
            container.innerHTML = `
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <span class="font-medium">Platform:</span>
                    <span>${systemInfo.platform || 'Unknown'}</span>
                </div>
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <span class="font-medium">CPU Usage:</span>
                    <span>${systemInfo.cpu_percent || 0}%</span>
                </div>
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <span class="font-medium">Memory Usage:</span>
                    <span>${systemInfo.memory?.percent || 0}%</span>
                </div>
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <span class="font-medium">Disk Usage:</span>
                    <span>${systemInfo.disk?.percent || 0}%</span>
                </div>
            `;
        }

        function initializeCharts() {//API Usage Chart
            const apiCtx = document.getElementById('apiUsageChart')?.getContext('2d');
            if (apiCtx) {
                new Chart(apiCtx, {
                    type: 'line',
                    data: {
                        labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                        datasets: [{
                            label: 'API Calls',
                            data: Array.from({length: 24}, () => Math.floor(Math.random() * 500) + 100),
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true } }
                    }
                });
            }//Performance Chart
            const perfCtx = document.getElementById('performanceChart')?.getContext('2d');
            if (perfCtx) {
                new Chart(perfCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['CPU', 'Memory', 'Disk', 'Network'],
                        datasets: [{
                            data: [65, 45, 30, 20],
                            backgroundColor: ['#ef4444', '#f59e0b', '#10b981', '#3b82f6']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { position: 'bottom' } }
                    }
                });
            }
        }//Quick Action Functions
        async function refreshAllData() {
            await loadDashboardData();
            showNotification('Data refreshed successfully', 'success');
        }

        async function runHealthCheck() {
            try {
                const response = await fetch("/dashboard/health');
                const result = await response.json();
                showNotification(`Health check: ${result.status}`, 'success');
            } catch (error) {
                showNotification('Health check failed', 'error');
            }
        }

        function exportData() {
            showNotification('Export feature coming soon', 'info');
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg text-white ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 'bg-blue-500'
            }`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }//File Manager Functions
        function showFileManager() {
            document.getElementById('file-manager-modal').classList.remove('hidden');
            loadDownloadsFiles();
            setupFileManagerEvents();
        }

        function setupFileManagerEvents() {//Close modal
            document.getElementById('close-file-manager').onclick = () => {
                document.getElementById('file-manager-modal').classList.add('hidden');
            };//File upload
            const fileInput = document.getElementById('file-upload');
            const dropZone = document.getElementById('drop-zone');

            dropZone.onclick = () => fileInput.click();

            fileInput.onchange = (e) => {
                handleFileUpload(e.target.files);
            };//Drag and drop
            dropZone.ondragover = (e) => {
                e.preventDefault();
                dropZone.classList.add('border-blue-500', 'bg-blue-50');
            };

            dropZone.ondragleave = () => {
                dropZone.classList.remove('border-blue-500', 'bg-blue-50');
            };

            dropZone.ondrop = (e) => {
                e.preventDefault();
                dropZone.classList.remove('border-blue-500', 'bg-blue-50');
                handleFileUpload(e.dataTransfer.files);
            };//Refresh files
            document.getElementById('refresh-files').onclick = loadDownloadsFiles;
        }

        async function handleFileUpload(files) {
            const progressDiv = document.getElementById('upload-progress');
            const progressBar = document.getElementById('upload-progress-bar');
            const statusText = document.getElementById('upload-status');

            progressDiv.classList.remove('hidden');

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const formData = new FormData();
                formData.append('file', file);

                try {
                    statusText.textContent = `Uploading ${file.name}...`;
                    progressBar.style.width = `${((i + 1)/files.length) * 100}%`;

                    const response = await fetch('http://localhost:5000/upload', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();
                    if (result.success) {
                        showNotification(`${file.name} uploaded successfully`, 'success');
                    } else {
                        showNotification(`Failed to upload ${file.name}: ${result.error}`, 'error');
                    }
                } catch (error) {
                    showNotification(`Upload error: ${error.message}`, 'error');
                }
            }

            progressDiv.classList.add('hidden');
            loadDownloadsFiles();
        }

        async function loadDownloadsFiles() {
            const filesList = document.getElementById('files-list');
            filesList.innerHTML = '<div class="p-4 text-center text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i>Loading files...</div>';

            try {
                const response = await fetch('http://localhost:5000/downloads/list');
                const result = await response.json();

                if (result.success && result.files.length > 0) {
                    filesList.innerHTML = result.files.map(file => `
                        <div class="flex items-center justify-between p-3 border-b hover:bg-gray-50">
                            <div class="flex items-center space-x-3">
                                <i class="fas fa-file${getFileIcon(file.extension)} text-blue-500"></i>
                                <div>
                                    <p class="font-medium text-gray-800">${file.name}</p>
                                    <p class="text-sm text-gray-500">${formatFileSize(file.size)} • ${new Date(file.modified * 1000).toLocaleDateString()}</p>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="processFile('${file.name}', 'read')" class="text-blue-600 hover:text-blue-800 text-sm">
                                    <i class="fas fa-eye mr-1"></i>View
                                </button>
                                <button onclick="processFile('${file.name}', 'download')" class="text-green-600 hover:text-green-800 text-sm">
                                    <i class="fas fa-download mr-1"></i>Download
                                </button>
                                <button onclick="processFile('${file.name}', 'delete')" class="text-red-600 hover:text-red-800 text-sm">
                                    <i class="fas fa-trash mr-1"></i>Delete
                                </button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    filesList.innerHTML = '<div class="p-4 text-center text-gray-500">No files found in Downloads folder</div>';
                }
            } catch (error) {
                filesList.innerHTML = '<div class="p-4 text-center text-red-500">Error loading files</div>';
                console.error('Error loading files:', error);
            }
        }

        async function processFile(filename, action) {
            try {
                const response = await fetch('http://localhost:5000/downloads/process', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename, action })
                });

                if (action === 'download') {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    a.click();
                    window.URL.revokeObjectURL(url);
                    return;
                }

                const result = await response.json();
                if (result.success) {
                    if (action === 'read') {
                        showFileContent(filename, result.content, result.is_binary);
                    } else if (action === 'delete') {
                        showNotification(`${filename} deleted successfully`, 'success');
                        loadDownloadsFiles();
                    }
                } else {
                    showNotification(`Error: ${result.error}`, 'error');
                }
            } catch (error) {
                showNotification(`Error processing file: ${error.message}`, 'error');
            }
        }

        function showFileContent(filename, content, isBinary) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-4xl max-h-[90vh] overflow-hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">${filename}</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div class="overflow-auto max-h-96">
                        <pre class="bg-gray-100 p-4 rounded text-sm">${isBinary ? content : content}</pre>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }//Paste Integration Functions
        function showPasteIntegration() {
            document.getElementById('paste-integration-modal').classList.remove('hidden');
            setupPasteIntegrationEvents();
            checkPasteServiceStatus();
        }

        function setupPasteIntegrationEvents() {//Close modal
            document.getElementById('close-paste-integration').onclick = () => {
                document.getElementById('paste-integration-modal').classList.add('hidden');
            };//Save paste
            document.getElementById('save-paste').onclick = savePasteContent;//Load from file
            document.getElementById('load-from-file').onclick = loadFromDownloadsFile;//Generate avatar
            document.getElementById('generate-avatar').onclick = generateAvatar;
        }

        async function savePasteContent() {
            const content = document.getElementById('paste-content').value.trim();
            if (!content) {
                showNotification('Please enter some content', 'error');
                return;
            }

            try {
                const response = await fetch('http://localhost:5000/paste', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content })
                });

                const result = await response.json();
                if (result.success) {
                    showNotification('Paste saved successfully', 'success');
                } else {
                    showNotification(`Error: ${result.error}`, 'error');
                }
            } catch (error) {
                showNotification(`Error saving paste: ${error.message}`, 'error');
            }
        }

        async function loadFromDownloadsFile() {
            try {
                const response = await fetch('http://localhost:5000/downloads/list');
                const result = await response.json();

                if (result.success && result.files.length > 0) {
                    const textFiles = result.files.filter(f => ['.txt', '.md', '.py', '.js', '.html', '.css', '.json'].includes(f.extension));
                    if (textFiles.length === 0) {
                        showNotification('No text files found in Downloads', 'error');
                        return;
                    }//For simplicity, load the first text file
                    const file = textFiles[0];
                    const fileResponse = await fetch('http://localhost:5000/downloads/process', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ filename: file.name, action: 'read' })
                    });

                    const fileResult = await fileResponse.json();
                    if (fileResult.success && !fileResult.is_binary) {
                        document.getElementById('paste-content').value = fileResult.content;
                        showNotification(`Loaded content from ${file.name}`, 'success');
                    }
                }
            } catch (error) {
                showNotification(`Error loading file: ${error.message}`, 'error');
            }
        }

        async function generateAvatar() {
            const content = document.getElementById('paste-content').value.trim();
            if (!content) {
                showNotification('Please enter content first', 'error');
                return;
            }

            const avatarType = document.getElementById('avatar-type').value;
            const voiceStyle = document.getElementById('voice-style').value;

            try {
                const response = await fetch('http://localhost:5000/paste/avatar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content,
                        avatar_type: avatarType,
                        voice_style: voiceStyle,
                        quality: 'high'
                    })
                });

                const result = await response.json();
                if (result.success) {
                    document.getElementById('avatar-result').classList.remove('hidden');
                    document.getElementById('avatar-message').textContent = `Avatar generated! Duration: ${result.avatar.duration}s`;
                    showNotification('Avatar generated successfully', 'success');
                } else {
                    showNotification(`Error: ${result.error}`, 'error');
                }
            } catch (error) {
                showNotification(`Error generating avatar: ${error.message}`, 'error');
            }
        }

        async function checkPasteServiceStatus() {
            const indicator = document.getElementById('paste-status-indicator');
            const text = document.getElementById('paste-status-text');

            try {
                const response = await fetch('http://localhost:5000/status');
                if (response.ok) {
                    indicator.className = 'w-3 h-3 rounded-full bg-green-500';
                    text.textContent = 'Paste service is running';
                } else {
                    throw new Error('Service not responding');
                }
            } catch (error) {
                indicator.className = 'w-3 h-3 rounded-full bg-red-500';
                text.textContent = 'Paste service is not available';
            }
        }//Utility functions
        function getFileIcon(extension) {
            const icons = {
                '.pdf': '-pdf',
                '.txt': '-alt',
                '.doc': '-word',
                '.docx': '-word',
                '.py': '-code',
                '.js': '-code',
                '.html': '-code',
                '.css': '-code',
                '.json': '-code',
                '.png': '-image',
                '.jpg': '-image',
                '.jpeg': '-image',
                '.gif': '-image',
                '.zip': '-archive'
            };
            return icons[extension] || '';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes)/Math.log(k));
            return parseFloat((bytes/Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
    </script>
    
    <!-- Dashboard Functionality Test Script -->
    <script src="/static/js/test_dashboard_functionality.js"></script>
</body>
</html>