<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Self Repair Agent Dashboard</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
    <style>
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f8f9fa;
      }
      .dashboard-container {
        padding: 20px;
      }
      .status-card {
        margin-bottom: 20px;
        border: none;
        box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.05);
        border-radius: 10px;
      }
      .card-header {
        background-color: #ffffff;
        border-bottom: 1px solid #e9ecef;
        padding: 15px 20px;
        font-weight: 600;
        border-radius: 10px 10px 0 0 !important;
      }
      .card-body {
        padding: 20px;
      }
      .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
      }
      .status-healthy {
        background-color: #28a745;
      }
      .status-warning {
        background-color: #ffc107;
      }
      .status-critical {
        background-color: #dc3545;
      }
      .metric-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 15px;
      }
      .metric-value {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 5px;
      }
      .metric-label {
        font-size: 0.9rem;
        opacity: 0.9;
      }
      .component-status {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #e9ecef;
      }
      .component-status:last-child {
        border-bottom: none;
      }
      .repair-log {
        max-height: 300px;
        overflow-y: auto;
      }
      .repair-entry {
        padding: 10px;
        margin-bottom: 10px;
        background-color: #f8f9fa;
        border-radius: 5px;
        border-left: 4px solid #28a745;
      }
      .repair-timestamp {
        font-size: 0.8rem;
        color: #6c757d;
      }
      .health-chart {
        width: 100%;
        height: 300px;
      }
      .btn-repair {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        border: none;
        color: white;
        padding: 8px 16px;
        border-radius: 5px;
        font-size: 0.9rem;
      }
      .btn-repair:hover {
        background: linear-gradient(135deg, #ee5a24 0%, #ff6b6b 100%);
        color: white;
      }
    </style>
  </head>
  <body>
    <div class="container-fluid dashboard-container">
      <div class="row">
        <div class="col-12">
          <h1 class="mb-4">
            <i class="fas fa-tools text-primary"></i>
            Self Repair Agent Dashboard
          </h1>
        </div>
      </div>

      <!-- System Health Overview -->
      <div class="row">
        <div class="col-md-3">
          <div class="metric-card">
            <div class="metric-value" id="overall-score">94.2%</div>
            <div class="metric-label">Overall Health Score</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="metric-card">
            <div class="metric-value" id="components-monitored">28</div>
            <div class="metric-label">Components Monitored</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="metric-card">
            <div class="metric-value" id="auto-repairs">147</div>
            <div class="metric-label">Auto Repairs Completed</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="metric-card">
            <div class="metric-value" id="uptime">99.7%</div>
            <div class="metric-label">System Uptime</div>
          </div>
        </div>
      </div>

      <div class="row">
        <!-- Component Status -->
        <div class="col-md-6">
          <div class="card status-card">
            <div class="card-header">
              <i class="fas fa-server"></i>
              Component Status
              <button class="btn btn-sm btn-outline-primary float-right" id="refresh-status">
                <i class="fas fa-sync-alt"></i>
                Refresh
              </button>
            </div>
            <div class="card-body">
              <div id="component-status-list">
                <!-- Component status will be loaded here -->
              </div>
            </div>
          </div>
        </div>

        <!-- System Health Chart -->
        <div class="col-md-6">
          <div class="card status-card">
            <div class="card-header">
              <i class="fas fa-chart-line"></i>
              Health Metrics
            </div>
            <div class="card-body">
              <canvas id="health-chart" class="health-chart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <!-- Recent Repairs -->
        <div class="col-md-8">
          <div class="card status-card">
            <div class="card-header">
              <i class="fas fa-history"></i>
              Recent Repairs
            </div>
            <div class="card-body">
              <div class="repair-log" id="repair-log">
                <!-- Repair entries will be loaded here -->
              </div>
            </div>
          </div>
        </div>

        <!-- Manual Actions -->
        <div class="col-md-4">
          <div class="card status-card">
            <div class="card-header">
              <i class="fas fa-wrench"></i>
              Manual Actions
            </div>
            <div class="card-body">
              <div class="mb-3">
                <label for="component-select" class="form-label">Component:</label>
                <select class="form-control" id="component-select">
                  <option value="database">Database</option>
                  <option value="api_services">API Services</option>
                  <option value="file_system">File System</option>
                  <option value="network">Network</option>
                  <option value="memory">Memory</option>
                  <option value="disk_space">Disk Space</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="action-select" class="form-label">Action:</label>
                <select class="form-control" id="action-select">
                  <option value="restart">Restart Service</option>
                  <option value="clear_cache">Clear Cache</option>
                  <option value="cleanup">Cleanup Temp Files</option>
                  <option value="optimize">Optimize Performance</option>
                </select>
              </div>
              <button class="btn btn-repair btn-block" id="execute-repair">
                <i class="fas fa-play"></i>
                Execute Repair
              </button>
              <div id="repair-result" class="mt-3"></div>
            </div>
          </div>

          <!-- Settings Panel -->
          <div class="card status-card">
            <div class="card-header">
              <i class="fas fa-cog"></i>
              Settings
            </div>
            <div class="card-body">
              <div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" id="auto-repair-enabled" checked/>
                <label class="form-check-label" for="auto-repair-enabled">Auto Repair Enabled</label>
              </div>
              <div class="form-group">
                <label for="monitoring-interval">Monitoring Interval (seconds):</label>
                <input type="number" class="form-control" id="monitoring-interval" value="30"/>
              </div>
              <button class="btn btn-secondary btn-sm" id="save-settings">
                <i class="fas fa-save"></i>
                Save Settings
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function () {//Load dashboard data
        loadDashboardData();
        loadComponentStatus();
        loadRecentRepairs();
        initializeHealthChart();//Event listeners
        document.getElementById('refresh-status').addEventListener('click', loadComponentStatus);
        document.getElementById('execute-repair').addEventListener('click', executeRepair);
        document.getElementById('save-settings').addEventListener('click', saveSettings);//Auto-refresh every 30 seconds
        setInterval(() => {
          loadDashboardData();
          loadComponentStatus();
        }, 30000);
      });

      function loadDashboardData() {
        fetch("/api/self-repair/dashboard')
          .then(response => response.json())
          .then(data => {
            if (data.system_health) {
              document.getElementById('overall-score').textContent = data.system_health.overall_score + '%';
              document.getElementById('components-monitored').textContent = data.system_health.components_monitored;
              document.getElementById('auto-repairs').textContent = data.system_health.auto_repairs_completed;
              document.getElementById('uptime').textContent = data.system_health.uptime_percentage + '%';
            }
          })
          .catch(error => console.error('Error loading dashboard data:', error));
      }

      function loadComponentStatus() {
        fetch("/api/self-repair/dashboard')
          .then(response => response.json())
          .then(data => {
            const statusList = document.getElementById('component-status-list');
            statusList.innerHTML = '';

            if (data.component_status) {
              Object.entries(data.component_status).forEach(([component, status]) => {
                const statusDiv = document.createElement('div');
                statusDiv.className = 'component-status';

                const statusClass =
                  status.status === 'healthy'
                    ? 'status-healthy'
                    : status.status === 'warning'
                      ? 'status-warning'
                      : 'status-critical';

                statusDiv.innerHTML = `
                                <div>
                                    <span class="status-indicator ${statusClass}"></span>
                                    <strong>${component.replace('_', ' ').toUpperCase()}</strong>
                                </div>
                                <div>
                                    <span class="badge badge-${status.status === 'healthy' ? 'success' : status.status === 'warning' ? 'warning' : 'danger'}">
                                        ${status.status.toUpperCase()}
                                    </span>
                                </div>
                            `;
                statusList.appendChild(statusDiv);
              });
            }
          })
          .catch(error => console.error('Error loading component status:', error));
      }

      function loadRecentRepairs() {
        fetch("/api/self-repair/dashboard')
          .then(response => response.json())
          .then(data => {
            const repairLog = document.getElementById('repair-log');
            repairLog.innerHTML = '';

            if (data.recent_repairs) {
              data.recent_repairs.forEach(repair => {
                const repairDiv = document.createElement('div');
                repairDiv.className = 'repair-entry';
                repairDiv.innerHTML = `
                                <div><strong>${repair.component}</strong>: ${repair.issue}</div>
                                <div>Action: ${repair.action}</div>
                                <div class="repair-timestamp">${new Date(repair.timestamp).toLocaleString()}</div>
                            `;
                repairLog.appendChild(repairDiv);
              });
            }
          })
          .catch(error => console.error('Error loading recent repairs:', error));
      }

      function initializeHealthChart() {
        const ctx = document.getElementById('health-chart').getContext('2d');
        new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: ['Healthy', 'Warning', 'Critical'],
            datasets: [
              {
                data: [85, 12, 3],
                backgroundColor: ['#28a745', '#ffc107', '#dc3545'],
                borderWidth: 0,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom',
              },
            },
          },
        });
      }

      function executeRepair() {
        const component = document.getElementById('component-select').value;
        const action = document.getElementById('action-select').value;
        const resultDiv = document.getElementById('repair-result');

        fetch("/api/self-repair/repair-action', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ component, action }),
        })
          .then(response => response.json())
          .then(data => {
            resultDiv.innerHTML = `
                    <div class="alert alert-success alert-sm">
                        <strong>Repair Initiated:</strong><br>
                        ${data.message}<br>
                        <small>Repair ID: ${data.repair_id}</small>
                    </div>
                `;//Refresh status after repair
            setTimeout(loadComponentStatus, 2000);
          })
          .catch(error => {
            resultDiv.innerHTML = `
                    <div class="alert alert-danger alert-sm">
                        <strong>Error:</strong> ${error.message}
                    </div>
                `;
          });
      }

      function saveSettings() {
        const settings = {
          auto_repair_enabled: document.getElementById('auto-repair-enabled').checked,
          monitoring_interval: parseInt(document.getElementById('monitoring-interval').value),
        };

        fetch("/api/self-repair/settings', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(settings),
        })
          .then(response => response.json())
          .then(data => {
            alert('Settings saved successfully!');
          })
          .catch(error => {
            alert('Error saving settings: ' + error.message);
          });
      }
    </script>
  </body>
</html>
