<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Total Access Command Center - TRAE.AI Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>

    <!-- Socket.IO Debug Logger for Hard Evidence -->
    <pre
      id="socketio-debug-log"
      style="
        background: #111;
        color: #0f0;
        padding: 8px;
        max-height: 40vh;
        overflow: auto;
        font:
          12px/1.4 Menlo,
          monospace;
        position: fixed;
        top: 10px;
        right: 10px;
        width: 400px;
        z-index: 9999;
        border: 1px solid #333;
        border-radius: 4px;
        display: none;
      "
    ></pre>
    <button
      id="toggle-debug-log"
      style="
        position: fixed;
        top: 10px;
        right: 420px;
        z-index: 10000;
        background: #333;
        color: #0f0;
        border: 1px solid #555;
        padding: 4px 8px;
        font: 12px monospace;
        cursor: pointer;
        border-radius: 4px;
      "
    >
      Show Debug
    </button>

    <script>
      // Socket.IO Debug Logger - Hard Evidence Collection
      (function () {
        const logEl = document.getElementById('socketio-debug-log');
        const toggleBtn = document.getElementById('toggle-debug-log');

        // Toggle debug log visibility
        toggleBtn.addEventListener('click', function () {
          if (logEl.style.display === 'none') {
            logEl.style.display = 'block';
            toggleBtn.textContent = 'Hide Debug';
          } else {
            logEl.style.display = 'none';
            toggleBtn.textContent = 'Show Debug';
          }
        });

        const debugLog = (...args) => {
          const timestamp = new Date().toISOString().substr(11, 12);
          const message = args.map(x => (typeof x === 'string' ? x : JSON.stringify(x, null, 2))).join(' ');
          console.log(`[${timestamp}]`, ...args);
          logEl.textContent += `[${timestamp}] ${message}\n`;
          logEl.scrollTop = logEl.scrollHeight;
        };

        // Enable verbose Socket.IO client logging
        try {
          localStorage.debug = 'socket.io-client:*,engine.io-client:*';
          debugLog('[DEBUG] Enabled verbose Socket.IO client logging');
        } catch (e) {
          debugLog('[DEBUG] Could not set localStorage.debug:', e.message);
        }

        // Global error handlers
        window.addEventListener('error', e => {
          debugLog('[WINDOW ERROR]', e.message, 'at', e.filename + ':' + e.lineno);
        });

        window.addEventListener('unhandledrejection', e => {
          debugLog('[UNHANDLED REJECTION]', String(e.reason || e));
        });

        // Store original io function to wrap it
        window._originalIo = window.io;

        // Wrap io() calls to add debug logging
        window.io = function (...args) {
          debugLog('[IO] Creating Socket.IO connection with args:', args);
          const socket = window._originalIo.apply(this, args);

          // Add comprehensive event logging
          socket.on('connect', () => {
            debugLog('[SOCKET] âœ… CONNECTED - ID:', socket.id, 'URL:', socket.io.uri);
            debugLog('[SOCKET] Transport:', socket.io.engine.transport.name);
            debugLog('[SOCKET] Ping interval:', socket.io.engine.pingInterval + 'ms');
          });

          socket.on('disconnect', reason => {
            debugLog('[SOCKET] âŒ DISCONNECTED - Reason:', reason);
          });

          socket.on('connect_error', error => {
            debugLog('[SOCKET] ðŸš« CONNECT_ERROR:', error.message || error);
            debugLog('[SOCKET] Error type:', error.type);
            debugLog('[SOCKET] Error description:', error.description);
          });

          socket.on('error', error => {
            debugLog('[SOCKET] âš ï¸ ERROR:', error);
          });

          socket.on('reconnect', attemptNumber => {
            debugLog('[SOCKET] ðŸ”„ RECONNECTED after', attemptNumber, 'attempts');
          });

          socket.on('reconnect_attempt', attemptNumber => {
            debugLog('[SOCKET] ðŸ”„ Reconnect attempt #' + attemptNumber);
          });

          socket.on('reconnect_error', error => {
            debugLog('[SOCKET] ðŸ”„âŒ Reconnect error:', error.message || error);
          });

          socket.on('reconnect_failed', () => {
            debugLog('[SOCKET] ðŸ”„ðŸ’€ Reconnect failed - giving up');
          });

          // Log all incoming events
          const originalOn = socket.on.bind(socket);
          socket.on = function (event, handler) {
            return originalOn(event, function (...args) {
              if (!['ping', 'pong'].includes(event)) {
                debugLog('[SOCKET] ðŸ“¨ Event received:', event, args.length > 0 ? args : '');
              }
              return handler.apply(this, args);
            });
          };

          // Log all outgoing events
          const originalEmit = socket.emit.bind(socket);
          socket.emit = function (event, ...args) {
            if (!['ping', 'pong'].includes(event)) {
              debugLog('[SOCKET] ðŸ“¤ Event sent:', event, args.length > 0 ? args : '');
            }
            return originalEmit.apply(this, [event, ...args]);
          };

          return socket;
        };

        debugLog('[DEBUG] Socket.IO debug wrapper initialized');
        debugLog('[DEBUG] Current origin:', window.location.origin);
        debugLog('[DEBUG] User agent:', navigator.userAgent);
      })();
    </script>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #333;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
        color: white;
      }

      .header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }

      .header p {
        font-size: 1.1rem;
        opacity: 0.9;
      }

      .module-tabs {
        display: flex;
        justify-content: center;
        margin-bottom: 20px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 5px;
      }

      .tab-button {
        background: transparent;
        border: none;
        color: white;
        padding: 12px 20px;
        margin: 0 5px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.9rem;
      }

      .tab-button:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      .tab-button.active {
        background: rgba(255, 255, 255, 0.3);
        font-weight: bold;
      }

      .module-content {
        display: none;
      }

      .module-content.active {
        display: block;
      }

      .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .panel {
        background: white;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .panel h2 {
        color: #4a5568;
        margin-bottom: 20px;
        font-size: 1.4rem;
        border-bottom: 2px solid #e2e8f0;
        padding-bottom: 10px;
      }

      .workflow-buttons {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 15px;
      }

      .btn {
        padding: 12px 20px;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      }

      .btn-success {
        background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        color: white;
      }

      .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(72, 187, 120, 0.4);
      }

      .btn-warning {
        background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
        color: white;
      }

      .btn-warning:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(237, 137, 54, 0.4);
      }

      .btn-info {
        background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
        color: white;
      }

      .btn-info:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(66, 153, 225, 0.4);
      }

      .toggle-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding: 15px;
        background: #f7fafc;
        border-radius: 8px;
        border-left: 4px solid #667eea;
      }

      .toggle-label {
        font-weight: 600;
        color: #4a5568;
      }

      .toggle-switch {
        position: relative;
        width: 60px;
        height: 30px;
      }

      .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.4s;
        border-radius: 30px;
      }

      .slider:before {
        position: absolute;
        content: '';
        height: 22px;
        width: 22px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
      }

      input:checked + .slider {
        background-color: #48bb78;
      }

      input:checked + .slider:before {
        transform: translateX(30px);
      }

      .status-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
      }

      .status-card {
        background: #f7fafc;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
        border-left: 4px solid #667eea;
      }

      .status-card h3 {
        color: #4a5568;
        margin-bottom: 10px;
        font-size: 1rem;
      }

      .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
      }

      .status-active {
        background-color: #48bb78;
      }

      .status-pending {
        background-color: #ed8936;
      }

      .status-inactive {
        background-color: #e53e3e;
      }

      .metrics {
        display: flex;
        justify-content: space-between;
        margin-top: 10px;
      }

      .metric {
        text-align: center;
      }

      .metric-value {
        font-size: 1.2rem;
        font-weight: bold;
        color: #667eea;
      }

      .metric-label {
        font-size: 0.8rem;
        color: #718096;
      }

      .task-queue {
        grid-column: 1 / -1;
      }

      .task-list {
        max-height: 300px;
        overflow-y: auto;
      }

      .task-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        margin-bottom: 8px;
        background: #f7fafc;
        border-radius: 6px;
        border-left: 4px solid #667eea;
      }

      .task-info {
        flex: 1;
      }

      .task-type {
        font-weight: 600;
        color: #4a5568;
      }

      .task-status {
        font-size: 0.9rem;
        color: #718096;
      }

      .task-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
      }

      .badge-pending {
        background: #fed7d7;
        color: #c53030;
      }

      .badge-running {
        background: #bee3f8;
        color: #2b6cb0;
      }

      .badge-completed {
        background: #c6f6d5;
        color: #276749;
      }

      .badge-failed {
        background: #fed7d7;
        color: #c53030;
      }

      .refresh-btn {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        transition: all 0.3s ease;
      }

      .refresh-btn:hover {
        transform: scale(1.1);
      }

      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 8px;
        color: white;
        font-weight: 600;
        z-index: 1000;
        transform: translateX(400px);
        transition: transform 0.3s ease;
      }

      .notification.show {
        transform: translateX(0);
      }

      .notification.success {
        background: #48bb78;
      }

      .notification.error {
        background: #e53e3e;
      }

      .notification.info {
        background: #4299e1;
      }

      /* Agent Command Center styles */
      .agent-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
      }

      .agent-card {
        background: #f7fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 20px;
        transition: all 0.3s ease;
      }

      .agent-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
      }

      .agent-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .agent-header h3 {
        margin: 0;
        color: #2d3748;
        font-size: 1.1rem;
      }

      .agent-metrics {
        display: flex;
        gap: 20px;
        margin-bottom: 15px;
      }

      .agent-controls {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
      }

      .status-active {
        background-color: #48bb78;
        box-shadow: 0 0 6px rgba(72, 187, 120, 0.6);
      }

      .status-idle {
        background-color: #a0aec0;
      }

      .status-warning {
        background-color: #ed8936;
        box-shadow: 0 0 6px rgba(237, 137, 54, 0.6);
      }

      .status-error {
        background-color: #e53e3e;
        box-shadow: 0 0 6px rgba(229, 62, 62, 0.6);
      }

      .error-message {
        background-color: #fed7d7;
        border: 1px solid #feb2b2;
        border-radius: 4px;
        padding: 8px;
        margin-top: 10px;
        font-size: 0.9em;
      }

      .btn-sm {
        padding: 6px 12px;
        font-size: 0.875rem;
      }

      /* Log viewer styles */
      .log-viewer {
        background: #1a202c;
        color: #e2e8f0;
        padding: 15px;
        border-radius: 8px;
        font-family: 'Courier New', monospace;
        max-height: 300px;
        overflow-y: auto;
      }

      .log-entry {
        display: flex;
        gap: 10px;
        margin-bottom: 8px;
        font-size: 0.875rem;
      }

      .log-timestamp {
        color: #a0aec0;
        min-width: 140px;
      }

      .log-level {
        min-width: 60px;
        font-weight: bold;
      }

      .log-info {
        color: #63b3ed;
      }
      .log-success {
        color: #68d391;
      }
      .log-warning {
        color: #f6e05e;
      }
      .log-error {
        color: #fc8181;
      }

      /* Intelligence Database styles */
      .table-list {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
      }

      .table-item {
        background: #f7fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .table-item:hover {
        background: #edf2f7;
        border-color: #667eea;
        transform: translateY(-2px);
      }

      .table-item h3 {
        margin: 0 0 8px 0;
        color: #2d3748;
      }

      .table-item p {
        margin: 0;
        color: #718096;
        font-size: 0.875rem;
      }

      .query-interface {
        margin-bottom: 20px;
      }

      .query-interface textarea {
        width: 100%;
        height: 120px;
        padding: 12px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        font-family: 'Courier New', monospace;
        resize: vertical;
        margin-bottom: 10px;
      }

      .query-results {
        background: #f7fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 15px;
        min-height: 100px;
        font-family: 'Courier New', monospace;
        font-size: 0.875rem;
      }

      /* Digital Product Studio styles */
      .project-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
      }

      .project-card {
        background: #f7fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 20px;
        transition: all 0.3s ease;
      }

      .project-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .project-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .project-header h3 {
        margin: 0;
        color: #2d3748;
      }

      .project-status {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
      }

      .project-progress {
        margin-bottom: 15px;
      }

      .progress-bar {
        width: 100%;
        height: 8px;
        background: #e2e8f0;
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 5px;
      }

      .progress-fill {
        height: 100%;
        background: #667eea;
        transition: width 0.3s ease;
      }

      .progress-text {
        font-size: 0.875rem;
        color: #718096;
      }

      .project-metrics {
        display: flex;
        gap: 20px;
        margin-bottom: 15px;
      }

      .project-controls {
        display: flex;
        gap: 8px;
      }

      .review-interface {
        background: #f7fafc;
        border-radius: 8px;
        padding: 15px;
      }

      .review-item {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
      }

      .review-item h4 {
        margin: 0 0 8px 0;
        color: #2d3748;
      }

      .review-status {
        margin: 0 0 10px 0;
        font-size: 0.875rem;
        color: #48bb78;
      }

      .review-actions {
        display: flex;
        gap: 8px;
      }

      /* Reporting Engine styles */
      .report-options {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
      }

      .report-type {
        background: #f7fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
      }

      .report-type:hover {
        background: #edf2f7;
        border-color: #667eea;
        transform: translateY(-2px);
      }

      .report-type h3 {
        margin: 0 0 8px 0;
        color: #2d3748;
      }

      .report-type p {
        margin: 0;
        color: #718096;
        font-size: 0.875rem;
      }

      .report-display {
        background: #f7fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 20px;
        min-height: 200px;
      }

      /* Code Backup & Export styles */
      .codebase-viewer-section {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .viewer-controls {
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
      }

      .control-row {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        flex-wrap: wrap;
        align-items: center;
      }

      .search-row {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        align-items: center;
      }

      .search-input {
        flex: 1;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        min-width: 200px;
      }

      .filter-select {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        background: white;
        min-width: 150px;
      }

      .stats {
        display: flex;
        gap: 15px;
        font-size: 12px;
        color: #666;
        margin-top: 10px;
      }

      .codebase-layout {
        display: grid;
        grid-template-columns: 300px 1fr;
        gap: 20px;
        height: 600px;
      }

      .file-tree-panel {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        overflow: hidden;
      }

      .file-tree-panel h3 {
        margin: 0;
        padding: 15px;
        background: #f8f9fa;
        border-bottom: 1px solid #e2e8f0;
        font-size: 0.875rem;
        font-weight: 600;
        color: #2d3748;
      }

      .file-tree {
        height: calc(100% - 50px);
        overflow-y: auto;
        padding: 10px;
      }

      .file-tree-item {
        display: flex;
        align-items: center;
        padding: 4px 8px;
        cursor: pointer;
        border-radius: 4px;
        font-size: 0.8rem;
        line-height: 1.4;
        user-select: none;
      }

      .file-tree-item:hover {
        background: #f1f5f9;
      }

      .file-tree-item.selected {
        background: #3182ce;
        color: white;
      }

      .file-tree-item.folder {
        font-weight: 500;
      }

      .file-tree-item .icon {
        margin-right: 6px;
        width: 16px;
        text-align: center;
      }

      .file-tree-item .indent {
        width: 20px;
        display: inline-block;
      }

      .code-viewer-panel {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      .file-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        background: #f8f9fa;
        border-bottom: 1px solid #e2e8f0;
      }

      .file-header #current-file-name {
        font-weight: 600;
        color: #2d3748;
        font-size: 0.875rem;
      }

      .file-actions {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .file-stats {
        font-size: 0.75rem;
        color: #718096;
      }

      .action-btn-sm {
        padding: 4px 8px;
        font-size: 0.75rem;
        background: #3182ce;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .action-btn-sm:hover {
        background: #2c5aa0;
      }

      .code-display {
        flex: 1;
        overflow: hidden;
      }

      .code-content {
        width: 100%;
        height: 100%;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.75rem;
        line-height: 1.4;
        padding: 15px;
        margin: 0;
        background: #f8f9fa;
        border: none;
        overflow: auto;
        white-space: pre;
        color: #2d3748;
      }

      .loading {
        padding: 20px;
        text-align: center;
        color: #718096;
        font-style: italic;
      }

      /* Legacy styles for backward compatibility */
      .code-viewer-section {
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .file-browser {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .file-browser label {
        font-weight: 600;
        color: #2d3748;
      }

      .file-browser select {
        padding: 8px 12px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        background: white;
        font-size: 0.875rem;
      }

      .file-info {
        font-size: 0.75rem;
        color: #718096;
        padding: 8px;
        background: #f7fafc;
        border-radius: 4px;
      }

      .copy-controls {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .backup-section {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .backup-option {
        background: #f7fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 20px;
      }

      .backup-option h3 {
        margin: 0 0 8px 0;
        color: #2d3748;
      }

      .backup-option p {
        margin: 0 0 15px 0;
        color: #718096;
        font-size: 0.875rem;
      }

      .backup-status {
        margin-top: 10px;
        padding: 8px;
        border-radius: 4px;
        font-size: 0.875rem;
      }

      .backup-status.success {
        background: #f0fff4;
        color: #22543d;
        border: 1px solid #9ae6b4;
      }

      .backup-status.error {
        background: #fed7d7;
        color: #742a2a;
        border: 1px solid #feb2b2;
      }

      .backup-status.loading {
        background: #ebf8ff;
        color: #2a4365;
        border: 1px solid #90cdf4;
      }

      .backup-history {
        background: #f7fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 20px;
      }

      .backup-history h3 {
        margin: 0 0 15px 0;
        color: #2d3748;
      }

      /* Configuration Styles */
      .config-section {
        max-width: 800px;
        margin: 0 auto;
      }

      .config-loading {
        text-align: center;
        padding: 40px;
        color: #718096;
      }

      .config-form {
        background: #f7fafc;
        border-radius: 8px;
        padding: 30px;
      }

      .config-group {
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid #e2e8f0;
      }

      .config-group:last-of-type {
        border-bottom: none;
      }

      .config-group h3 {
        margin: 0 0 15px 0;
        color: #2d3748;
        font-size: 1.1rem;
      }

      .config-item {
        margin-bottom: 15px;
      }

      .config-item label {
        display: flex;
        align-items: flex-start;
        cursor: pointer;
        padding: 12px;
        border-radius: 6px;
        transition: background-color 0.2s;
      }

      .config-item label:hover {
        background: #edf2f7;
      }

      .config-item input[type='checkbox'] {
        margin-right: 12px;
        margin-top: 2px;
        transform: scale(1.2);
      }

      .config-label {
        font-weight: 500;
        color: #2d3748;
        margin-bottom: 4px;
      }

      .config-item small {
        display: block;
        color: #718096;
        font-size: 0.875rem;
        line-height: 1.4;
      }

      .config-actions {
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #e2e8f0;
        display: flex;
        gap: 15px;
        justify-content: center;
      }

      .config-status {
        margin-top: 15px;
        padding: 10px;
        border-radius: 6px;
        text-align: center;
        font-size: 0.875rem;
      }

      .config-status.success {
        background: #f0fff4;
        color: #22543d;
        border: 1px solid #9ae6b4;
      }

      .config-status.error {
        background: #fed7d7;
        color: #742a2a;
        border: 1px solid #feb2b2;
      }

      .config-status.loading {
        background: #ebf8ff;
        color: #2a4365;
        border: 1px solid #90cdf4;
      }

      .download-link {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        margin-bottom: 8px;
      }

      .download-link:last-child {
        margin-bottom: 0;
      }

      .download-info {
        flex: 1;
      }

      .download-info .filename {
        font-weight: 600;
        color: #2d3748;
      }

      .download-info .filesize {
        font-size: 0.75rem;
        color: #718096;
      }

      .download-btn {
        background: #667eea;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.75rem;
        transition: background-color 0.2s;
      }

      .download-btn:hover {
        background: #5a67d8;
      }

      /* Affiliate Command Center styles */
      .affiliate-programs-table {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .affiliate-program-row {
        display: grid;
        grid-template-columns: auto 1fr auto auto;
        gap: 20px;
        align-items: center;
        background: #f7fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 15px;
        transition: all 0.3s ease;
      }

      .affiliate-program-row:hover {
        background: #edf2f7;
        border-color: #667eea;
      }

      .program-status {
        display: flex;
        align-items: center;
      }

      .program-info h4 {
        margin: 0 0 4px 0;
        color: #2d3748;
        font-size: 1rem;
      }

      .program-category {
        font-size: 0.875rem;
        color: #718096;
      }

      .program-metrics {
        display: flex;
        gap: 15px;
      }

      .program-metrics .metric {
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .program-metrics .metric-label {
        font-size: 0.75rem;
        color: #718096;
        margin-bottom: 2px;
      }

      .program-metrics .metric-value {
        font-weight: 600;
        color: #2d3748;
      }

      .program-actions {
        display: flex;
        gap: 8px;
      }

      .opportunity-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-bottom: 20px;
      }

      .opportunity-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #f7fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 15px;
        transition: all 0.3s ease;
      }

      .opportunity-item:hover {
        background: #edf2f7;
        border-color: #48bb78;
      }

      .opportunity-info h4 {
        margin: 0 0 4px 0;
        color: #2d3748;
      }

      .opportunity-info p {
        margin: 0 0 4px 0;
        color: #718096;
        font-size: 0.875rem;
      }

      .opportunity-potential {
        font-size: 0.75rem;
        color: #48bb78;
        font-weight: 600;
      }

      .api-status-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
      }

      .api-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .api-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #f7fafc;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        padding: 12px;
      }

      .api-info h4 {
        margin: 0;
        color: #2d3748;
        font-size: 0.9rem;
      }

      .api-status {
        font-size: 0.75rem;
        padding: 2px 6px;
        border-radius: 4px;
        background: #c6f6d5;
        color: #276749;
      }

      .api-usage-info {
        font-size: 0.875rem;
        color: #718096;
      }

      /* API Command Center styles */
      .api-controls {
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .control-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .control-group label {
        font-weight: 600;
        color: #2d3748;
        font-size: 0.875rem;
      }

      .status-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        background: #f7fafc;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
      }

      .status-light {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
      }

      .status-light.green {
        background-color: #48bb78;
        box-shadow: 0 0 6px rgba(72, 187, 120, 0.4);
      }

      .status-light.yellow {
        background-color: #ed8936;
        box-shadow: 0 0 6px rgba(237, 137, 54, 0.4);
      }

      .status-light.red {
        background-color: #f56565;
        box-shadow: 0 0 6px rgba(245, 101, 101, 0.4);
      }

      .opportunities-container {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .opportunity-card {
        background: #f7fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 15px;
        transition: all 0.3s ease;
      }

      .opportunity-card:hover {
        background: #edf2f7;
        border-color: #667eea;
      }

      .opportunity-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 8px;
      }

      .opportunity-header h4 {
        margin: 0;
        color: #2d3748;
        font-size: 1rem;
      }

      .match-score {
        background: #667eea;
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
      }

      .opportunity-description {
        color: #718096;
        font-size: 0.875rem;
        margin-bottom: 8px;
        line-height: 1.4;
      }

      .opportunity-details {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
      }

      .capability-tag {
        background: #e2e8f0;
        color: #4a5568;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 500;
      }

      .free-tier {
        color: #48bb78;
        font-size: 0.75rem;
        font-weight: 600;
      }

      .api-registry-row {
        display: grid;
        grid-template-columns: auto 1fr auto auto;
        gap: 20px;
        align-items: center;
        background: #f7fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 12px;
        transition: all 0.3s ease;
      }

      .api-registry-row:hover {
        background: #edf2f7;
        border-color: #667eea;
      }

      .api-status-col {
        display: flex;
        align-items: center;
      }

      .api-info-col h4 {
        margin: 0 0 4px 0;
        color: #2d3748;
        font-size: 1rem;
      }

      .api-category {
        font-size: 0.875rem;
        color: #718096;
      }

      .api-metrics-col {
        display: flex;
        gap: 15px;
      }

      .api-metrics-col .metric {
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .api-metrics-col .metric-label {
        font-size: 0.75rem;
        color: #718096;
        margin-bottom: 2px;
      }

      .api-metrics-col .metric-value {
        font-weight: 600;
        color: #2d3748;
      }

      .api-actions-col {
        display: flex;
        gap: 8px;
      }

      /* Actions Grid Styles */
      .actions-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 15px;
        margin-top: 15px;
      }

      .action-card {
        background: #f7fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 15px;
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .action-card:hover {
        background: #edf2f7;
        border-color: #667eea;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .action-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 8px;
      }

      .action-header h4 {
        margin: 0;
        color: #2d3748;
        font-size: 1rem;
      }

      .action-category {
        background: #667eea;
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
      }

      .action-description {
        color: #718096;
        font-size: 0.875rem;
        margin-bottom: 12px;
        line-height: 1.4;
      }

      .action-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.75rem;
        color: #a0aec0;
      }

      .action-agent {
        font-weight: 600;
      }

      .action-auth {
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .auth-required {
        color: #f56565;
      }

      .auth-not-required {
        color: #48bb78;
      }

      .continue-section {
        background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        border-radius: 12px;
        padding: 25px;
        text-align: center;
        margin: 30px 0;
        box-shadow: 0 8px 32px rgba(72, 187, 120, 0.2);
      }

      .continue-section h2 {
        color: white;
        margin-bottom: 15px;
        font-size: 1.5rem;
      }

      .continue-section p {
        color: rgba(255, 255, 255, 0.9);
        margin-bottom: 20px;
        font-size: 1.1rem;
      }

      .btn-continue {
        background: white;
        color: #38a169;
        padding: 15px 30px;
        border: none;
        border-radius: 8px;
        font-size: 1.1rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .btn-continue:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        background: #f7fafc;
      }

      @media (max-width: 768px) {
        .dashboard-grid {
          grid-template-columns: 1fr;
        }

        .workflow-buttons {
          grid-template-columns: 1fr;
        }

        .status-grid {
          grid-template-columns: 1fr;
        }

        .header h1 {
          font-size: 2rem;
        }

        .panel {
          padding: 15px;
        }

        .module-tabs {
          flex-wrap: wrap;
        }

        .tab-button {
          padding: 8px 12px;
          font-size: 0.8rem;
        }
      }

      @media (max-width: 480px) {
        .container {
          padding: 10px;
        }

        .dashboard-grid {
          gap: 10px;
        }

        .panel {
          padding: 10px;
        }

        .btn {
          padding: 10px 15px;
          font-size: 0.9rem;
        }
      }
      /* API Suggestions Styling */
      .suggestion-card {
        background: #2a2a2a;
        border: 1px solid #444;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        transition: all 0.3s ease;
      }

      .suggestion-card:hover {
        border-color: #007acc;
        transform: translateY(-2px);
      }

      .suggestion-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        flex-wrap: wrap;
        gap: 10px;
      }

      .suggestion-header h4 {
        margin: 0;
        color: #4a5568;
        font-size: 16px;
      }

      .suggestion-score {
        background: linear-gradient(135deg, #007acc, #0099ff);
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: bold;
      }

      .suggestion-status {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: bold;
        text-transform: capitalize;
      }

      .suggestion-status.status-pending {
        background: #ffa500;
        color: #000;
      }

      .suggestion-status.status-approved {
        background: #28a745;
        color: #fff;
      }

      .suggestion-status.status-rejected {
        background: #dc3545;
        color: #fff;
      }

      .suggestion-description {
        color: #718096;
        margin-bottom: 10px;
        font-size: 14px;
        line-height: 1.4;
      }

      .suggestion-details {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 15px;
      }

      .capability-tag,
      .source-tag,
      .cost-tag {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: bold;
      }

      .capability-tag {
        background: #6f42c1;
        color: white;
      }

      .source-tag {
        background: #17a2b8;
        color: white;
      }

      .cost-tag {
        background: #ffc107;
        color: #000;
      }

      .suggestion-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #718096;
      }

      .empty-state p {
        margin-bottom: 10px;
      }

      .btn-sm {
        padding: 6px 12px;
        font-size: 12px;
      }

      .btn-danger {
        background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
        color: white;
      }

      .btn-danger:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(229, 62, 62, 0.4);
      }

      .btn-info {
        background: linear-gradient(135deg, #3182ce 0%, #2c5282 100%);
        color: white;
      }

      .btn-info:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(49, 130, 206, 0.4);
      }

      /* Creative Sandbox Styles */
      .sandbox-panels {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      .sandbox-panel {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 20px;
        border: 2px solid #e2e8f0;
      }

      .sandbox-panel h3 {
        color: #2d3748;
        margin-bottom: 15px;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #4a5568;
      }

      .form-control {
        width: 100%;
        padding: 10px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.3s ease;
      }

      .form-control:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      textarea.form-control {
        resize: vertical;
        min-height: 100px;
      }

      .preview-window {
        width: 100%;
        height: 300px;
        background: #000;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #718096;
        font-size: 14px;
        margin-bottom: 15px;
      }

      .generation-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 15px;
      }

      .btn-sandbox {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .btn-voice {
        background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        color: white;
      }

      .btn-avatar {
        background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
        color: white;
      }

      .btn-scene {
        background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
        color: white;
      }

      .btn-production {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 12px 24px;
        font-size: 16px;
      }

      .btn-sandbox:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }

      .production-queue {
        grid-column: 1 / -1;
        background: #fff;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        padding: 20px;
      }

      .queue-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        background: #f7fafc;
        border-radius: 8px;
        margin-bottom: 10px;
        border-left: 4px solid #667eea;
      }

      .queue-info {
        flex: 1;
      }

      .queue-title {
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 4px;
      }

      .queue-details {
        font-size: 12px;
        color: #718096;
      }

      .queue-status {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
      }

      .status-queued {
        background: #fed7d7;
        color: #c53030;
      }

      .status-processing {
        background: #bee3f8;
        color: #2b6cb0;
      }

      .status-rendering {
        background: #fbb6ce;
        color: #97266d;
      }

      .production-queue-section {
        margin-top: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #e9ecef;
      }

      .production-queue-section h3 {
        margin: 0 0 15px 0;
        color: #495057;
        font-size: 16px;
        font-weight: 600;
      }

      .queue-list {
        min-height: 100px;
        max-height: 300px;
        overflow-y: auto;
      }

      /* Report Center Styles */
      .report-generation-section {
        background: #f8fafc;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
      }

      .generation-controls {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        align-items: end;
      }

      .control-group {
        display: flex;
        flex-direction: column;
      }

      .control-group label {
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 5px;
        font-size: 14px;
      }

      .generation-status {
        margin-top: 20px;
        padding: 15px;
        background: #e6fffa;
        border-radius: 8px;
        border-left: 4px solid #38b2ac;
      }

      .status-message {
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 10px;
      }

      .progress-bar {
        width: 100%;
        height: 8px;
        background: #e2e8f0;
        border-radius: 4px;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #38b2ac, #4fd1c7);
        border-radius: 4px;
        transition: width 0.3s ease;
        animation: progress-animation 2s infinite;
      }

      @keyframes progress-animation {
        0% {
          width: 0%;
        }
        50% {
          width: 70%;
        }
        100% {
          width: 100%;
        }
      }

      .archive-controls {
        margin-bottom: 20px;
      }

      .search-filter-section {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 15px;
        align-items: center;
      }

      .report-archive-table {
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .data-table {
        width: 100%;
        border-collapse: collapse;
      }

      .data-table th {
        background: #f7fafc;
        padding: 12px 15px;
        text-align: left;
        font-weight: 600;
        color: #2d3748;
        border-bottom: 2px solid #e2e8f0;
        cursor: pointer;
        user-select: none;
      }

      .data-table th:hover {
        background: #edf2f7;
      }

      .data-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #e2e8f0;
        color: #4a5568;
      }

      .data-table tr:hover {
        background: #f7fafc;
      }

      .report-type-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
        text-transform: capitalize;
      }

      .badge-daily {
        background: #fed7d7;
        color: #c53030;
      }

      .badge-weekly {
        background: #bee3f8;
        color: #2b6cb0;
      }

      .badge-quarterly {
        background: #c6f6d5;
        color: #276749;
      }

      .badge-affiliate {
        background: #fbb6ce;
        color: #97266d;
      }

      .badge-content {
        background: #faf089;
        color: #744210;
      }

      .badge-audience {
        background: #e9d8fd;
        color: #553c9a;
      }

      .report-actions {
        display: flex;
        gap: 8px;
      }

      .btn-sm {
        padding: 6px 12px;
        font-size: 12px;
        border-radius: 4px;
      }

      .report-viewer-controls {
        margin-bottom: 20px;
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .report-content {
        background: white;
        border-radius: 8px;
        padding: 30px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        line-height: 1.6;
      }

      .report-content h1 {
        color: #2d3748;
        border-bottom: 2px solid #e2e8f0;
        padding-bottom: 10px;
        margin-bottom: 20px;
      }

      .report-content h2 {
        color: #4a5568;
        margin-top: 30px;
        margin-bottom: 15px;
      }

      .report-content h3 {
        color: #718096;
        margin-top: 20px;
        margin-bottom: 10px;
      }

      .report-content ul,
      .report-content ol {
        margin-left: 20px;
        margin-bottom: 15px;
      }

      .report-content table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
      }

      .report-content table th,
      .report-content table td {
        padding: 10px;
        border: 1px solid #e2e8f0;
        text-align: left;
      }

      .report-content table th {
        background: #f7fafc;
        font-weight: 600;
      }

      .full-width {
        grid-column: 1 / -1;
      }

      /* Audience Management Styles */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
      }

      .stat-card {
        background: #f7fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        transition: all 0.3s ease;
      }

      .stat-card:hover {
        background: #edf2f7;
        transform: translateY(-2px);
      }

      .stat-card h3 {
        margin: 0 0 10px 0;
        color: #4a5568;
        font-size: 0.875rem;
        font-weight: 600;
      }

      .stat-number {
        font-size: 2rem;
        font-weight: bold;
        color: #667eea;
      }

      .contact-actions {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .contact-list {
        max-height: 400px;
        overflow-y: auto;
      }

      .contact-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #f7fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
      }

      .contact-info h4 {
        margin: 0 0 5px 0;
        color: #2d3748;
      }

      .contact-info p {
        margin: 0 0 5px 0;
        color: #718096;
        font-size: 0.875rem;
      }

      .contact-status {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
      }

      .contact-status.active {
        background: #c6f6d5;
        color: #22543d;
      }

      .contact-status.inactive {
        background: #fed7d7;
        color: #742a2a;
      }

      .contact-actions .btn-small {
        padding: 6px 12px;
        font-size: 0.75rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .btn-small {
        background: #667eea;
        color: white;
      }

      .btn-small:hover {
        background: #5a67d8;
      }

      .btn-small.btn-danger {
        background: #e53e3e;
      }

      .btn-small.btn-danger:hover {
        background: #c53030;
      }

      .campaign-form {
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .form-input,
      .form-select,
      .form-textarea {
        padding: 12px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        font-size: 0.875rem;
        transition: border-color 0.3s ease;
      }

      .form-input:focus,
      .form-select:focus,
      .form-textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .form-textarea {
        min-height: 100px;
        resize: vertical;
      }

      .segment-builder {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-bottom: 20px;
      }

      .segment-list {
        max-height: 300px;
        overflow-y: auto;
      }

      .segment-item {
        background: #f7fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
      }

      .segment-item h4 {
        margin: 0 0 8px 0;
        color: #2d3748;
      }

      .segment-item p {
        margin: 0 0 8px 0;
        color: #718096;
        font-size: 0.875rem;
      }

      .segment-count {
        background: #667eea;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
      }

      /* Smoke Test Styles */
      .smoke-test-section {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 25px;
        margin-top: 20px;
      }

      .test-controls {
        text-align: center;
        margin-bottom: 25px;
      }

      .btn-large {
        font-size: 1.2rem;
        padding: 15px 30px;
        border-radius: 8px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        transition: all 0.3s ease;
      }

      .btn-large:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
      }

      .test-status {
        background: white;
        border-radius: 8px;
        padding: 15px;
        border-left: 4px solid #e2e8f0;
      }

      .status-indicator {
        display: flex;
        align-items: center;
        font-weight: 500;
      }

      .status-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 10px;
        background-color: #cbd5e0;
        transition: all 0.3s ease;
      }

      .status-dot.ready {
        background-color: #68d391;
      }

      .status-dot.running {
        background-color: #4299e1;
        animation: pulse 2s infinite;
      }

      .status-dot.success {
        background-color: #48bb78;
      }

      .status-dot.error {
        background-color: #f56565;
      }

      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }

      .test-results-container {
        margin-top: 25px;
      }

      .test-results {
        background: #1a202c;
        color: #e2e8f0;
        border-radius: 8px;
        padding: 20px;
        font-family: 'Courier New', monospace;
        font-size: 0.9rem;
        line-height: 1.5;
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #2d3748;
      }

      .log-placeholder {
        color: #a0aec0;
        font-style: italic;
        text-align: center;
        padding: 40px 20px;
      }

      .log-entry {
        margin-bottom: 8px;
        padding: 5px 0;
        border-bottom: 1px solid #2d3748;
      }

      .log-timestamp {
        color: #9ca3af;
        margin-right: 10px;
      }

      .log-level {
        font-weight: bold;
        margin-right: 10px;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.8rem;
      }

      .log-info {
        background: #3182ce;
        color: white;
      }

      .log-success {
        background: #38a169;
        color: white;
      }

      .log-warning {
        background: #d69e2e;
        color: white;
      }

      .log-error {
        background: #e53e3e;
        color: white;
      }

      .test-summary {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        border: 2px solid #e2e8f0;
      }

      .test-summary.success {
        border-color: #48bb78;
        background: #f0fff4;
      }

      .test-summary.error {
        border-color: #f56565;
        background: #fed7d7;
      }

      .summary-content {
        font-size: 1.1rem;
        line-height: 1.6;
      }

      .summary-content .success-message {
        color: #38a169;
        font-weight: 600;
        font-size: 1.2rem;
        margin-bottom: 15px;
      }

      .summary-content .error-message {
        color: #e53e3e;
        font-weight: 600;
        font-size: 1.2rem;
        margin-bottom: 15px;
      }

      /* Runtime Review Audit Styles */
      .runtime-review-results {
        margin-top: 20px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid #007bff;
      }

      .audit-section {
        margin-bottom: 20px;
        padding: 15px;
        background: white;
        border-radius: 8px;
        border: 1px solid #e9ecef;
      }

      .audit-section h4 {
        margin-bottom: 10px;
        color: #495057;
        font-size: 1.1rem;
      }

      .audit-result {
        padding: 12px;
        border-radius: 6px;
        font-size: 0.95rem;
        line-height: 1.5;
      }

      .audit-result.success {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
      }

      .audit-result.warning {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        color: #856404;
      }

      .audit-result.error {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
      }

      .download-section {
        margin-top: 20px;
        padding: 15px;
        background: #e8f5e8;
        border-radius: 8px;
        text-align: center;
      }

      .download-section h4 {
        color: #28a745;
        margin-bottom: 10px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ðŸŽ¯ Total Access Command Center</h1>
        <p>Complete Control & Intelligence Dashboard for TRAE.AI</p>
      </div>

      <!-- Module Navigation Tabs -->
      <div class="module-tabs">
        <button class="tab-button active" onclick="switchModule('agent-center')">ðŸ¤– Agent Command Center</button>
        <button class="tab-button" onclick="switchModule('creative-sandbox')">ðŸŽ¬ Creative Sandbox</button>
        <button class="tab-button" onclick="switchModule('affiliate-center')">ðŸ’° Affiliate Command Center</button>
        <button class="tab-button" onclick="switchModule('api-center')">ðŸ”Œ API Command Center</button>
        <button class="tab-button" onclick="switchModule('intelligence-db')">ðŸ§  Intelligence Database</button>
        <button class="tab-button" onclick="switchModule('audience-center')">ðŸ‘¥ Audience Management</button>
        <button class="tab-button" onclick="switchModule('product-studio')">ðŸ“š Digital Product Studio</button>
        <button class="tab-button" onclick="switchModule('reporting-engine')">ðŸ“Š On-Demand Reports</button>
        <button class="tab-button" onclick="switchModule('report-center')">ðŸ“ˆ Report Center</button>
        <button class="tab-button" onclick="switchModule('code-backup')">ðŸ’¾ Code Backup & Export</button>
        <button class="tab-button" onclick="switchModule('configuration')">âš™ï¸ Configuration</button>
        <button class="tab-button" onclick="switchModule('system-integrity')">ðŸš€ System Integrity & Go-Live</button>
      </div>

      <!-- Module Content Areas -->
      <div id="agent-center" class="module-content active">
        <div class="dashboard-grid">
          <!-- Agent Status Grid -->
          <div class="panel">
            <h2>ðŸ¤– Active Agents</h2>
            <div class="agent-grid" id="agent-grid">
              <div class="agent-card">
                <div class="agent-header">
                  <h3>Content Evolution Agent</h3>
                  <span class="status-indicator status-active"></span>
                </div>
                <div class="agent-metrics">
                  <div class="metric">
                    <div class="metric-value">2h 15m</div>
                    <div class="metric-label">Uptime</div>
                  </div>
                  <div class="metric">
                    <div class="metric-value">12</div>
                    <div class="metric-label">Tasks</div>
                  </div>
                </div>
                <div class="agent-controls">
                  <button class="btn btn-sm btn-warning" onclick="controlAgent('content-evolution', 'pause')">
                    â¸ï¸ Pause
                  </button>
                  <button class="btn btn-sm btn-success" onclick="controlAgent('content-evolution', 'resume')">
                    â–¶ï¸ Resume
                  </button>
                  <button class="btn btn-sm btn-info" onclick="viewAgentLogs('content-evolution')">ðŸ“‹ Logs</button>
                </div>
              </div>
              <div class="agent-card">
                <div class="agent-header">
                  <h3>Financial Management Agent</h3>
                  <span class="status-indicator status-active"></span>
                </div>
                <div class="agent-metrics">
                  <div class="metric">
                    <div class="metric-value">1h 42m</div>
                    <div class="metric-label">Uptime</div>
                  </div>
                  <div class="metric">
                    <div class="metric-value">8</div>
                    <div class="metric-label">Tasks</div>
                  </div>
                </div>
                <div class="agent-controls">
                  <button class="btn btn-sm btn-warning" onclick="controlAgent('financial-management', 'pause')">
                    â¸ï¸ Pause
                  </button>
                  <button class="btn btn-sm btn-success" onclick="controlAgent('financial-management', 'resume')">
                    â–¶ï¸ Resume
                  </button>
                  <button class="btn btn-sm btn-info" onclick="viewAgentLogs('financial-management')">ðŸ“‹ Logs</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Available Actions Panel -->
          <div class="panel">
            <h2>âš¡ Available Actions</h2>
            <div class="actions-grid" id="actions-grid">
              <p style="text-align: center; color: #718096">Loading available actions...</p>
            </div>
          </div>

          <!-- Workflow Controls Panel -->
          <div class="panel">
            <h2>ðŸš€ Workflow Controls</h2>
            <div class="form-group">
              <label for="workflow-avatar-engine">Avatar Engine:</label>
              <select id="workflow-avatar-engine" class="form-control" onchange="onWorkflowAvatarEngineChange()">
                <option value="auto">Auto (Failsafe)</option>
                <option value="linly-talker">Linly-Talker Enhanced</option>
                <option value="talking-heads">Talking Heads Fallback</option>
              </select>
            </div>
            <div class="workflow-buttons">
              <button class="btn btn-primary" onclick="triggerWorkflow('create-video')">ðŸŽ¬ Create Video</button>
              <button class="btn btn-success" onclick="triggerWorkflow('research')">ðŸ” Research</button>
              <button class="btn btn-warning" onclick="triggerWorkflow('content-audit')">ðŸ“‹ Content Audit</button>
              <button class="btn btn-info" onclick="triggerWorkflow('marketing')">ðŸ“ˆ Marketing</button>
              <button class="btn btn-primary" onclick="triggerBasicVideo()">ðŸŽ¥ Basic Video Generator</button>
            </div>
          </div>

          <!-- Agent Logs Panel -->
          <div class="panel">
            <h2>ðŸ“‹ Agent Logs</h2>
            <div class="log-viewer" id="agent-logs">
              <div class="log-entry">
                <span class="log-timestamp">2024-01-15 14:30:22</span>
                <span class="log-level log-info">INFO</span>
                <span class="log-message">Content Evolution Agent initialized successfully</span>
              </div>
              <div class="log-entry">
                <span class="log-timestamp">2024-01-15 14:32:15</span>
                <span class="log-level log-success">SUCCESS</span>
                <span class="log-message">Video content analysis completed</span>
              </div>
            </div>
          </div>

          <!-- Mini Locator Panel -->
          <div class="panel">
            <h2>ðŸ—ºï¸ Mini Locator</h2>
            <div class="mini-locator-container">
              <iframe 
                src="/api/places/locator/mini" 
                width="100%" 
                height="400" 
                frameborder="0" 
                style="border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"
                title="Mini Places Locator">
              </iframe>
              <div class="locator-controls" style="margin-top: 10px; text-align: center;">
                <button class="btn btn-sm btn-info" onclick="openFullLocator()">ðŸ” Open Full Locator</button>
                <button class="btn btn-sm btn-success" onclick="refreshLocator()">ðŸ”„ Refresh</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="creative-sandbox" class="module-content">
        <div class="dashboard-grid">
          <!-- Script & Concept Panel -->
          <div class="panel">
            <h2>ðŸ“ Script & Concept</h2>
            <div class="script-section">
              <label for="script-input" class="form-label">Script Content:</label>
              <textarea
                id="script-input"
                class="form-textarea"
                rows="6"
                placeholder="Enter your script here or generate one using AI..."
              ></textarea>

              <div class="ai-generation-section">
                <label for="topic-input" class="form-label">Topic for AI Generation:</label>
                <input
                  type="text"
                  id="topic-input"
                  class="form-input"
                  placeholder="e.g., 'Latest AI developments in 2024'"
                />
                <button class="btn btn-primary" onclick="generateSampleScript()">ðŸ¤– Generate Sample Script</button>
              </div>
            </div>
          </div>

          <!-- Virtual Casting Panel -->
          <div class="panel">
            <h2>ðŸŽ­ Virtual Casting</h2>
            <div class="casting-controls">
              <div class="form-group">
                <label for="channel-select" class="form-label">Channel:</label>
                <select id="channel-select" class="form-select" onchange="onChannelChange()">
                  <option value="">Select Channel...</option>
                  <option value="next-gen-tech">Next Gen Tech Today</option>
                  <option value="ai-insights">AI Insights Weekly</option>
                  <option value="future-trends">Future Trends Report</option>
                </select>
              </div>

              <div class="form-group">
                <label for="avatar-engine-select" class="form-label">Avatar Engine:</label>
                <select id="avatar-engine-select" class="form-select" onchange="onAvatarEngineChange()">
                  <option value="">Auto (Failsafe)</option>
                  <option value="linly-talker-enhanced">Linly-Talker Enhanced</option>
                  <option value="talking-heads-fallback">Talking Heads Fallback</option>
                </select>
              </div>

              <div class="form-group">
                <label for="avatar-select" class="form-label">Avatar:</label>
                <select id="avatar-select" class="form-select" onchange="onAvatarChange()">
                  <option value="">Select Avatar...</option>
                </select>
              </div>

              <div class="form-group">
                <label for="voice-select" class="form-label">Voice:</label>
                <select id="voice-select" class="form-select">
                  <option value="">Select Voice...</option>
                </select>
              </div>

              <div class="form-group">
                <label for="wardrobe-input" class="form-label">Wardrobe Style:</label>
                <input
                  type="text"
                  id="wardrobe-input"
                  class="form-input"
                  placeholder="e.g., 'Professional business attire, navy blue suit'"
                />
              </div>
            </div>
          </div>

          <!-- Preview & Generation Panel -->
          <div class="panel preview-panel">
            <h2>ðŸŽ¬ Preview & Generation</h2>
            <div class="preview-container">
              <div class="preview-window" id="preview-window">
                <div class="preview-placeholder">
                  <div class="preview-icon">ðŸŽ¥</div>
                  <p>Preview will appear here</p>
                </div>
              </div>

              <div class="generation-controls">
                <button class="btn btn-info" onclick="generateVoicePreview()" id="voice-preview-btn">
                  ðŸŽ¤ Generate Voice Preview
                </button>
                <button class="btn btn-warning" onclick="generateAvatarPreview()" id="avatar-preview-btn" disabled>
                  ðŸ‘¤ Generate Avatar Preview
                </button>
                <button class="btn btn-primary" onclick="generateFullScenePreview()" id="full-preview-btn" disabled>
                  ðŸŽ¬ Generate Full Scene Preview
                </button>
              </div>

              <div class="preview-status" id="preview-status">
                <div class="status-indicator status-pending"></div>
                <span>Ready to generate</span>
              </div>
            </div>
          </div>

          <!-- Production Queue Panel -->
          <div class="panel production-panel">
            <h2>ðŸš€ Production Queue</h2>
            <div class="production-summary">
              <h3>Current Configuration:</h3>
              <div class="config-summary" id="config-summary">
                <div class="config-item">
                  <strong>Channel:</strong>
                  <span id="summary-channel">Not selected</span>
                </div>
                <div class="config-item">
                  <strong>Avatar:</strong>
                  <span id="summary-avatar">Not selected</span>
                </div>
                <div class="config-item">
                  <strong>Voice:</strong>
                  <span id="summary-voice">Not selected</span>
                </div>
                <div class="config-item">
                  <strong>Script Length:</strong>
                  <span id="summary-script">0 words</span>
                </div>
              </div>

              <div class="production-actions">
                <button class="btn btn-success btn-large" onclick="sendToProduction()" id="production-btn" disabled>
                  âœ… Send to Production Queue
                </button>
                <button class="btn btn-warning" onclick="resetSandbox()">ðŸ”„ Reset Sandbox</button>
              </div>

              <div class="production-status" id="production-status">
                <p class="status-text">Complete the configuration above to enable production queue.</p>
              </div>
            </div>

            <!-- Production Queue List -->
            <div class="production-queue-section">
              <h3>Queue Status</h3>
              <div id="production-queue-list" class="queue-list">
                <p style="text-align: center; color: #718096">Loading production queue...</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="affiliate-center" class="module-content">
        <div class="dashboard-grid">
          <!-- Affiliate KPIs Panel -->
          <div class="panel">
            <h2>ðŸ’° Affiliate Performance (Last 30 Days)</h2>
            <div class="status-grid">
              <div class="status-card">
                <h3>Total Revenue</h3>
                <div class="metric-value" id="total-affiliate-revenue">$2,847.32</div>
              </div>
              <div class="status-card">
                <h3>Top Program</h3>
                <div class="metric-value" id="top-program">Amazon Associates</div>
              </div>
              <div class="status-card">
                <h3>Best Converting Link</h3>
                <div class="metric-value" id="best-link">Tech Review #47</div>
              </div>
            </div>
          </div>

          <!-- Affiliate Programs Table -->
          <div class="panel" style="grid-column: 1 / -1">
            <h2>ðŸ”— Affiliate Programs</h2>
            <div class="affiliate-programs-table" id="affiliate-programs">
              <div class="affiliate-program-row">
                <div class="program-status">
                  <span class="status-indicator status-active" title="Active and performing above target"></span>
                </div>
                <div class="program-info">
                  <h4>Amazon Associates</h4>
                  <span class="program-category">Tech Gadgets</span>
                </div>
                <div class="program-metrics">
                  <div class="metric">
                    <span class="metric-label">Commission:</span>
                    <span class="metric-value">4.5%</span>
                  </div>
                  <div class="metric">
                    <span class="metric-label">Conversion:</span>
                    <span class="metric-value">3.2%</span>
                  </div>
                </div>
                <div class="program-actions">
                  <button class="btn btn-sm btn-info" onclick="viewAffiliateDetails(1)">ðŸ“Š View Details</button>
                  <button class="btn btn-sm btn-warning" onclick="updateLinkTemplate(1)">ðŸ”— Update Link</button>
                  <button class="btn btn-sm btn-success" onclick="toggleAffiliateStatus(1, 'pause')">â¸ï¸ Pause</button>
                </div>
              </div>
              <div class="affiliate-program-row">
                <div class="program-status">
                  <span class="status-indicator status-warning" title="Active but underperforming"></span>
                </div>
                <div class="program-info">
                  <h4>ClickBank</h4>
                  <span class="program-category">Digital Products</span>
                </div>
                <div class="program-metrics">
                  <div class="metric">
                    <span class="metric-label">Commission:</span>
                    <span class="metric-value">50%</span>
                  </div>
                  <div class="metric">
                    <span class="metric-label">Conversion:</span>
                    <span class="metric-value">0.8%</span>
                  </div>
                </div>
                <div class="program-actions">
                  <button class="btn btn-sm btn-info" onclick="viewAffiliateDetails(2)">ðŸ“Š View Details</button>
                  <button class="btn btn-sm btn-warning" onclick="updateLinkTemplate(2)">ðŸ”— Update Link</button>
                  <button class="btn btn-sm btn-success" onclick="toggleAffiliateStatus(2, 'pause')">â¸ï¸ Pause</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Affiliate Opportunity Finder -->
          <div class="panel">
            <h2>ðŸš€ Suggested New Affiliate Programs</h2>
            <div class="opportunity-list" id="affiliate-opportunities">
              <div class="opportunity-item">
                <div class="opportunity-info">
                  <h4>Shopify Partners</h4>
                  <p>E-commerce platform with recurring commissions</p>
                  <span class="opportunity-potential">High Potential: $200+ per signup</span>
                </div>
                <button class="btn btn-sm btn-success" onclick="signupForOpportunity(1)">
                  + Task Agent to Sign Up
                </button>
              </div>
              <div class="opportunity-item">
                <div class="opportunity-info">
                  <h4>ConvertKit</h4>
                  <p>Email marketing tools for creators</p>
                  <span class="opportunity-potential">Medium Potential: 30% recurring</span>
                </div>
                <button class="btn btn-sm btn-success" onclick="signupForOpportunity(2)">
                  + Task Agent to Sign Up
                </button>
              </div>
            </div>
            <button class="btn btn-primary" onclick="findNewOpportunities()">ðŸ” Find More Opportunities</button>
          </div>

          <!-- API Management Section -->
          <div class="panel">
            <h2>ðŸ”‘ API Management</h2>
            <div class="api-status-grid">
              <div class="status-card">
                <h3>Active APIs</h3>
                <div class="metric-value" id="active-apis">12</div>
              </div>
              <div class="status-card">
                <h3>Monthly Usage</h3>
                <div class="metric-value" id="api-usage">847/1000</div>
              </div>
              <div class="status-card">
                <h3>Cost This Month</h3>
                <div class="metric-value" id="api-cost">$23.45</div>
              </div>
            </div>
            <div class="api-list" id="api-list">
              <div class="api-item">
                <div class="api-info">
                  <h4>OpenAI GPT-4</h4>
                  <span class="api-status status-active">Active</span>
                </div>
                <div class="api-usage-info">
                  <span>245 calls today</span>
                </div>
              </div>
              <div class="api-item">
                <div class="api-info">
                  <h4>YouTube Data API</h4>
                  <span class="api-status status-active">Active</span>
                </div>
                <div class="api-usage-info">
                  <span>89 calls today</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Continue Section -->
          <div class="continue-section">
            <h2>ðŸš€ Ready to Take Your Business to the Next Level?</h2>
            <p>
              Your revenue streams are performing well! Continue your journey with advanced automation and growth
              strategies.
            </p>
            <button class="btn-continue" onclick="continueToNextPhase()">Continue to Phase 2</button>
          </div>
        </div>
      </div>

      <div id="api-center" class="module-content">
        <div class="dashboard-grid">
          <!-- API KPIs Panel -->
          <div class="panel">
            <h2>ðŸ”Œ API Performance (Last 30 Days)</h2>
            <div class="status-grid">
              <div class="status-card">
                <div class="status-value" id="total-apis">0</div>
                <div class="status-label">Total APIs Registered</div>
              </div>
              <div class="status-card">
                <div class="status-value" id="healthy-apis">0</div>
                <div class="status-label">APIs Currently Healthy</div>
              </div>
              <div class="status-card">
                <div class="status-value" id="most-used-api">N/A</div>
                <div class="status-label">Most Frequently Used API</div>
              </div>
              <div class="status-card">
                <div class="status-value" id="total-api-calls">0</div>
                <div class="status-label">Total API Calls (30 Days)</div>
              </div>
            </div>
          </div>

          <!-- API Registry Panel -->
          <div class="panel">
            <h2>ðŸ—‚ï¸ API Registry</h2>
            <div class="table-container">
              <table class="data-table" id="api-registry-table">
                <thead>
                  <tr>
                    <th>Status</th>
                    <th>API Name</th>
                    <th>Capability</th>
                    <th>Key Status</th>
                    <th>30-Day Calls</th>
                    <th>Error Rate (%)</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="api-registry-body">
                  <tr>
                    <td colspan="7" class="loading-message">Loading API registry...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- API Opportunities Panel -->
          <div class="panel">
            <h2>ðŸ’¡ Suggested New APIs</h2>
            <div class="opportunities-container" id="api-opportunities">
              <div class="loading-message">Loading API opportunities...</div>
            </div>
          </div>

          <!-- API Management Panel -->
          <div class="panel">
            <h2>âš™ï¸ API Management</h2>
            <div class="api-controls">
              <div class="control-group">
                <label>API Health Check Status:</label>
                <div class="status-indicator" id="health-check-status">
                  <span class="status-light green"></span>
                  <span>System monitoring active</span>
                </div>
              </div>
              <div class="control-group">
                <button class="btn btn-primary" onclick="refreshAPIStatus()">ðŸ”„ Refresh All Status</button>
                <button class="btn btn-secondary" onclick="runHealthCheck()">ðŸ¥ Run Health Check</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="intelligence-db" class="module-content">
        <div class="dashboard-grid">
          <!-- Database Tables Panel -->
          <div class="panel">
            <h2>ðŸ—„ï¸ Database Tables</h2>
            <div class="table-list">
              <div class="table-item" onclick="loadTable('evidence')">
                <h3>ðŸ“„ Evidence</h3>
                <p>Research evidence and source materials</p>
              </div>
              <div class="table-item" onclick="loadTable('hypocrisy_tracker')">
                <h3>ðŸŽ­ Hypocrisy Tracker</h3>
                <p>Political inconsistency monitoring</p>
              </div>
              <div class="table-item" onclick="loadTable('video_performance')">
                <h3>ðŸ“Š Video Performance</h3>
                <p>Content analytics and metrics</p>
              </div>
              <div class="table-item" onclick="loadTable('affiliate_programs')">
                <h3>ðŸ’° Affiliate Programs</h3>
                <p>Monetization tracking</p>
              </div>
            </div>
          </div>

          <!-- Query Interface Panel -->
          <div class="panel">
            <h2>ðŸ” SQL Query Interface</h2>
            <div class="query-interface">
              <textarea
                id="sql-query"
                placeholder="SELECT * FROM evidence WHERE topic LIKE '%climate%' LIMIT 10;"
              ></textarea>
              <button class="btn btn-primary" onclick="executeQuery()">ðŸš€ Execute Query</button>
            </div>
            <div class="query-results" id="query-results">
              <p>Query results will appear here...</p>
            </div>
          </div>
        </div>
      </div>

      <div id="audience-center" class="module-content">
        <div class="dashboard-grid">
          <!-- Audience Overview Panel -->
          <div class="panel">
            <h2>ðŸ‘¥ Audience Overview</h2>
            <div class="stats-grid">
              <div class="stat-card">
                <h3>Total Contacts</h3>
                <div class="stat-number" id="total-contacts">0</div>
              </div>
              <div class="stat-card">
                <h3>Active Campaigns</h3>
                <div class="stat-number" id="active-campaigns">0</div>
              </div>
              <div class="stat-card">
                <h3>Email Open Rate</h3>
                <div class="stat-number" id="open-rate">0%</div>
              </div>
              <div class="stat-card">
                <h3>Conversion Rate</h3>
                <div class="stat-number" id="conversion-rate">0%</div>
              </div>
            </div>
          </div>

          <!-- Contact Management Panel -->
          <div class="panel">
            <h2>ðŸ“‹ Contact Management</h2>
            <div class="contact-actions">
              <button class="btn btn-primary" onclick="showAddContactForm()">âž• Add Contact</button>
              <button class="btn btn-secondary" onclick="importContacts()">ðŸ“¥ Import Contacts</button>
              <button class="btn btn-secondary" onclick="exportContacts()">ðŸ“¤ Export Contacts</button>
            </div>
            <div class="contact-list" id="contact-list">
              <p>Loading contacts...</p>
            </div>
          </div>

          <!-- Campaign Builder Panel -->
          <div class="panel">
            <h2>ðŸ“§ Campaign Builder</h2>
            <div class="campaign-form">
              <input type="text" id="campaign-name" placeholder="Campaign Name" class="form-input" />
              <select id="campaign-type" class="form-select">
                <option value="email">Email Campaign</option>
                <option value="sms">SMS Campaign</option>
                <option value="automation">Automation Sequence</option>
              </select>
              <textarea id="campaign-content" placeholder="Campaign content..." class="form-textarea"></textarea>
              <button class="btn btn-primary" onclick="createCampaign()">ðŸš€ Create Campaign</button>
            </div>
          </div>

          <!-- Audience Segments Panel -->
          <div class="panel">
            <h2>ðŸŽ¯ Audience Segments</h2>
            <div class="segment-builder">
              <input type="text" id="segment-name" placeholder="Segment Name" class="form-input" />
              <textarea
                id="segment-criteria"
                placeholder="SQL WHERE clause (e.g., engagement_score > 0.7)"
                class="form-textarea"
              ></textarea>
              <button class="btn btn-primary" onclick="createSegment()">âž• Create Segment</button>
            </div>
            <div class="segment-list" id="segment-list">
              <p>Loading segments...</p>
            </div>
          </div>
        </div>
      </div>

      <div id="product-studio" class="module-content">
        <div class="dashboard-grid">
          <!-- Active Projects Panel -->
          <div class="panel">
            <h2>ðŸ“š Active Projects</h2>
            <div class="project-grid" id="project-grid">
              <div class="project-card">
                <div class="project-header">
                  <h3>"The Right Perspective" Book</h3>
                  <span class="project-status status-active">In Progress</span>
                </div>
                <div class="project-progress">
                  <div class="progress-bar">
                    <div class="progress-fill" style="width: 65%"></div>
                  </div>
                  <span class="progress-text">65% Complete</span>
                </div>
                <div class="project-metrics">
                  <div class="metric">
                    <div class="metric-value">12/18</div>
                    <div class="metric-label">Chapters</div>
                  </div>
                  <div class="metric">
                    <div class="metric-value">45,230</div>
                    <div class="metric-label">Words</div>
                  </div>
                </div>
                <div class="project-controls">
                  <button class="btn btn-sm btn-info" onclick="reviewProject('book-1')">ðŸ“– Review</button>
                  <button class="btn btn-sm btn-success" onclick="updateProject('book-1')">âœï¸ Edit</button>
                  <button class="btn btn-sm btn-primary" onclick="generateMarketingPackage('book-1')">
                    ðŸš€ Generate Marketing Package
                  </button>
                </div>
              </div>
            </div>
            <button class="btn btn-primary" onclick="createNewProject()">âž• New Project</button>
          </div>

          <!-- Content Review Panel -->
          <div class="panel">
            <h2>ðŸ“ Content Review</h2>
            <div class="review-interface" id="content-review">
              <div class="review-item">
                <h4>Chapter 5: Climate Change Evidence</h4>
                <p class="review-status">âœ… Ready for Review</p>
                <div class="review-actions">
                  <button class="btn btn-sm btn-success">âœ… Approve</button>
                  <button class="btn btn-sm btn-warning">ðŸ“ Request Changes</button>
                  <button class="btn btn-sm btn-info">ðŸ‘ï¸ Preview</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="reporting-engine" class="module-content">
        <div class="dashboard-grid">
          <!-- Report Generation Panel -->
          <div class="panel">
            <h2>ðŸ“Š Generate Reports</h2>
            <div class="report-options">
              <div class="report-type" onclick="generateReport('performance')">
                <h3>ðŸ“ˆ Performance Report</h3>
                <p>Channel metrics and growth analysis</p>
              </div>
              <div class="report-type" onclick="generateReport('content')">
                <h3>ðŸ“„ Content Report</h3>
                <p>Video performance and engagement</p>
              </div>
              <div class="report-type" onclick="generateReport('financial')">
                <h3>ðŸ’° Financial Report</h3>
                <p>Revenue and monetization analysis</p>
              </div>
              <div class="report-type" onclick="generateReport('daily')">
                <h3>ðŸ“… Daily Summary</h3>
                <p>24-hour activity overview</p>
              </div>
            </div>
          </div>

          <!-- Report Display Panel -->
          <div class="panel">
            <h2>ðŸ“‹ Report Results</h2>
            <div class="report-display" id="report-display">
              <p>Select a report type to generate and view results...</p>
            </div>
          </div>
        </div>
      </div>

      <div id="report-center" class="module-content">
        <div class="dashboard-grid">
          <!-- On-Demand Report Generation Panel -->
          <div class="panel">
            <h2>ðŸš€ Generate New Report</h2>
            <div class="report-generation-section">
              <div class="generation-controls">
                <div class="control-group">
                  <label for="report-type-select">Report Type:</label>
                  <select id="report-type-select" class="form-control">
                    <option value="daily-performance">Daily Performance</option>
                    <option value="weekly-growth">Weekly Growth</option>
                    <option value="quarterly-strategic">Quarterly Strategic Brief</option>
                    <option value="affiliate-performance">Affiliate Performance</option>
                    <option value="content-analysis">Content Analysis</option>
                    <option value="audience-insights">Audience Insights</option>
                  </select>
                </div>
                <div class="control-group">
                  <label for="date-range-start">Start Date:</label>
                  <input type="date" id="date-range-start" class="form-control" />
                </div>
                <div class="control-group">
                  <label for="date-range-end">End Date:</label>
                  <input type="date" id="date-range-end" class="form-control" />
                </div>
                <div class="control-group">
                  <button class="btn btn-primary" onclick="generateReport()">ðŸ“Š Generate Report Now</button>
                </div>
              </div>
              <div id="generation-status" class="generation-status" style="display: none">
                <div class="status-message">Generating report...</div>
                <div class="progress-bar">
                  <div class="progress-fill" id="progress-fill"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Report Archive Panel -->
          <div class="panel full-width">
            <h2>ðŸ“š Report Archive</h2>
            <div class="archive-controls">
              <div class="search-filter-section">
                <input
                  type="text"
                  id="report-search"
                  class="form-control"
                  placeholder="Search reports..."
                  onkeyup="filterReports()"
                />
                <select id="report-type-filter" class="form-control" onchange="filterReports()">
                  <option value="">All Report Types</option>
                  <option value="daily-performance">Daily Performance</option>
                  <option value="weekly-growth">Weekly Growth</option>
                  <option value="quarterly-strategic">Quarterly Strategic</option>
                  <option value="affiliate-performance">Affiliate Performance</option>
                  <option value="content-analysis">Content Analysis</option>
                  <option value="audience-insights">Audience Insights</option>
                </select>
              </div>
            </div>
            <div class="report-archive-table">
              <table class="data-table" id="reports-table">
                <thead>
                  <tr>
                    <th onclick="sortReports('created_at')">Date Generated â†•ï¸</th>
                    <th onclick="sortReports('report_type')">Report Type â†•ï¸</th>
                    <th onclick="sortReports('date_range_start')">Date Range â†•ï¸</th>
                    <th>Key Headline</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="reports-table-body">
                  <!-- Reports will be loaded here -->
                </tbody>
              </table>
            </div>
          </div>

          <!-- Report Viewer Panel -->
          <div class="panel full-width" id="report-viewer-panel" style="display: none">
            <h2>ðŸ“„ Report Viewer</h2>
            <div class="report-viewer-controls">
              <button class="btn btn-secondary" onclick="closeReportViewer()">â† Back to Archive</button>
              <button class="btn btn-info" onclick="downloadCurrentReport()">ðŸ’¾ Download</button>
            </div>
            <div class="report-content" id="report-content">
              <!-- Report content will be rendered here -->
            </div>
          </div>
        </div>
      </div>

      <div id="code-backup" class="module-content">
        <div class="dashboard-grid">
          <!-- Complete Codebase Viewer Panel -->
          <div class="panel" style="grid-column: 1 / -1">
            <h2>ðŸ“ Complete Codebase Viewer</h2>
            <div class="codebase-viewer-section">
              <div class="viewer-controls">
                <div class="control-row">
                  <button onclick="loadProjectStructure()" class="action-btn">ðŸ”„ Refresh Project Structure</button>
                  <button onclick="copyAllCodeToClipboard()" class="action-btn primary">
                    ðŸ“„ Copy All Code to Clipboard
                  </button>
                  <button onclick="copyProjectStructure()" class="action-btn">ðŸŒ³ Copy Project Structure</button>
                  <button onclick="downloadCodebaseZip()" class="action-btn">ðŸ“¦ Download ZIP</button>
                  <button onclick="toggleExpandAll()" class="action-btn" id="expand-toggle">ðŸ“‚ Expand All</button>
                </div>
                <div class="search-row">
                  <input
                    type="text"
                    id="file-search"
                    placeholder="ðŸ” Search files..."
                    oninput="filterFiles()"
                    class="search-input"
                  />
                  <select id="file-type-filter" onchange="filterFiles()" class="filter-select">
                    <option value="">All Files</option>
                    <option value=".py">Python (.py)</option>
                    <option value=".js">JavaScript (.js)</option>
                    <option value=".html">HTML (.html)</option>
                    <option value=".css">CSS (.css)</option>
                    <option value=".json">JSON (.json)</option>
                    <option value=".md">Markdown (.md)</option>
                    <option value=".sql">SQL (.sql)</option>
                    <option value=".sh">Shell (.sh)</option>
                  </select>
                  <button onclick="clearFilters()" class="action-btn-sm">âœ– Clear</button>
                </div>
                <div class="stats"></div>
              </div>

              <div class="codebase-layout">
                <div class="file-tree-panel">
                  <h3>ðŸ“‚ Project Structure</h3>
                  <div id="file-tree" class="file-tree">
                    <div class="loading">Loading project structure...</div>
                  </div>
                </div>

                <div class="code-viewer-panel">
                  <div class="file-header">
                    <span id="current-file-name">Select a file to view</span>
                    <div class="file-actions">
                      <button onclick="copyCurrentFile()" class="action-btn-sm">ðŸ“‹ Copy</button>
                      <span id="file-info" class="file-stats"></span>
                    </div>
                  </div>
                  <div class="code-display">
                    <pre id="code-content" class="code-content">
Select a file from the project structure to view its content...</pre
                    >
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- One-Click Backup Panel -->
          <div class="panel">
            <h2>ðŸ’¾ One-Click Backup Generation</h2>
            <div class="backup-section">
              <div class="backup-option">
                <h3>ðŸ—‚ï¸ Code Snapshot (.zip)</h3>
                <p>Clean archive of entire codebase using Git</p>
                <button onclick="generateCodeBackup()" class="action-btn primary">Generate Code Snapshot</button>
                <div id="code-backup-status" class="backup-status"></div>
              </div>

              <div class="backup-option">
                <h3>ðŸ—„ï¸ Full Data Backup (.tar.gz)</h3>
                <p>Complete backup including databases and configs</p>
                <button onclick="generateDataBackup()" class="action-btn primary">Create Data Backup</button>
                <div id="data-backup-status" class="backup-status"></div>
              </div>

              <div class="backup-history">
                <h3>ðŸ“¥ Download Links</h3>
                <div id="download-links">No backups generated yet...</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Configuration Module -->
      <div id="configuration" class="module-content">
        <div class="dashboard-grid">
          <div class="panel" style="grid-column: 1 / -1">
            <h2>âš™ï¸ System Configuration & Toggles</h2>
            <div class="config-section">
              <div class="config-loading" id="config-loading">
                <p>Loading configuration...</p>
              </div>
              <div class="config-form" id="config-form" style="display: none">
                <form id="configuration-form">
                  <!-- Autonomous Mode Section -->
                  <div class="config-group">
                    <h3>ðŸ¤– Autonomous Mode</h3>
                    <div class="config-item">
                      <label>
                        <input type="checkbox" id="autonomous_mode" name="autonomous_mode" />
                        <span class="config-label">Enable Autonomous Mode</span>
                        <small>Allow AI to make decisions and execute tasks automatically</small>
                      </label>
                    </div>
                  </div>

                  <!-- Monetization Features Section -->
                  <div class="config-group">
                    <h3>ðŸ’° Monetization Features</h3>
                    <div class="config-item">
                      <label>
                        <input type="checkbox" id="affiliate_tracking" name="affiliate_tracking" />
                        <span class="config-label">Affiliate Tracking</span>
                        <small>Enable affiliate link tracking and commission management</small>
                      </label>
                    </div>
                    <div class="config-item">
                      <label>
                        <input type="checkbox" id="payment_processing" name="payment_processing" />
                        <span class="config-label">Payment Processing</span>
                        <small>Enable payment gateway integration</small>
                      </label>
                    </div>
                    <div class="config-item">
                      <label>
                        <input type="checkbox" id="subscription_management" name="subscription_management" />
                        <span class="config-label">Subscription Management</span>
                        <small>Enable recurring subscription billing</small>
                      </label>
                    </div>
                  </div>

                  <!-- Content Generation Section -->
                  <div class="config-group">
                    <h3>ðŸ“ Content Generation</h3>
                    <div class="config-item">
                      <label>
                        <input type="checkbox" id="auto_posting" name="auto_posting" />
                        <span class="config-label">Auto-Posting</span>
                        <small>Automatically post generated content to social media</small>
                      </label>
                    </div>
                    <div class="config-item">
                      <label>
                        <input type="checkbox" id="content_optimization" name="content_optimization" />
                        <span class="config-label">Content Optimization</span>
                        <small>Optimize content for engagement and conversion</small>
                      </label>
                    </div>
                    <div class="config-item">
                      <label>
                        <input type="checkbox" id="seo_enhancement" name="seo_enhancement" />
                        <span class="config-label">SEO Enhancement</span>
                        <small>Automatically optimize content for search engines</small>
                      </label>
                    </div>
                  </div>

                  <!-- System Settings Section -->
                  <div class="config-group">
                    <h3>ðŸ”§ System Settings</h3>
                    <div class="config-item">
                      <label>
                        <input type="checkbox" id="debug_mode" name="debug_mode" />
                        <span class="config-label">Debug Mode</span>
                        <small>Enable detailed logging and debugging information</small>
                      </label>
                    </div>
                    <div class="config-item">
                      <label>
                        <input type="checkbox" id="performance_monitoring" name="performance_monitoring" />
                        <span class="config-label">Performance Monitoring</span>
                        <small>Monitor system performance and resource usage</small>
                      </label>
                    </div>
                    <div class="config-item">
                      <label>
                        <input type="checkbox" id="auto_backup" name="auto_backup" />
                        <span class="config-label">Auto Backup</span>
                        <small>Automatically backup system data and configurations</small>
                      </label>
                    </div>
                  </div>

                  <div class="config-actions">
                    <button type="button" onclick="saveConfiguration()" class="action-btn primary">
                      ðŸ’¾ Save Changes
                    </button>
                    <button type="button" onclick="resetConfiguration()" class="action-btn">
                      ðŸ”„ Reset to Defaults
                    </button>
                  </div>
                </form>
              </div>
              <div class="config-status" id="config-status"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- System Integrity & Go-Live Module -->
      <div id="system-integrity" class="module-content">
        <div class="dashboard-grid">
          <div class="panel" style="grid-column: 1 / -1">
            <h2>ðŸš€ System Integrity & Go-Live</h2>
            <p style="margin-bottom: 20px; color: #666">
              Automated system-wide smoke test for production readiness verification
            </p>

            <div class="smoke-test-section">
              <div class="test-controls">
                <button
                  id="run-smoke-test-btn"
                  class="btn btn-primary btn-large"
                  onclick="runSmokeTest()"
                  style="font-size: 1.2rem; padding: 15px 30px; margin-bottom: 20px"
                >
                  ðŸš€ Run Full System Smoke Test
                </button>
                <button
                  id="stop-smoke-test-btn"
                  class="btn btn-danger"
                  onclick="stopSmokeTest()"
                  style="display: none; margin-left: 10px"
                >
                  â¹ï¸ Stop Test
                </button>
                <button
                  id="runtime-review-archive-btn"
                  class="btn btn-info btn-large"
                  onclick="runRuntimeReviewArchive()"
                  style="font-size: 1.2rem; padding: 15px 30px; margin-bottom: 20px; margin-left: 20px"
                >
                  ðŸ“‹ Run Runtime Review + Archive
                </button>
              </div>

              <div class="test-status" id="test-status" style="margin-bottom: 20px">
                <div class="status-indicator" id="status-indicator">
                  <span class="status-dot" id="status-dot"></span>
                  <span id="status-text">Ready to run smoke test</span>
                </div>
              </div>

              <div class="test-results-container">
                <h3>Test Results & Live Logs</h3>
                <div class="test-results" id="test-results">
                  <div class="log-placeholder">
                    Click "Run Full System Smoke Test" to begin automated verification...
                  </div>
                </div>
              </div>

              <div class="test-summary" id="test-summary" style="display: none">
                <h3>Test Summary</h3>
                <div class="summary-content" id="summary-content"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Refresh Button -->
    <button class="refresh-btn" onclick="refreshDashboard()" title="Refresh Dashboard">ðŸ”„</button>

    <!-- Notification Container -->
    <div id="notification" class="notification"></div>

    <script>
      // Dashboard JavaScript functionality
      let refreshInterval;

      // Initialize dashboard
      document.addEventListener('DOMContentLoaded', function () {
        refreshDashboard();
        startAutoRefresh();
      });

      // Workflow functions
      async function triggerWorkflow(workflowType) {
        try {
          showNotification('Triggering ' + workflowType + ' workflow...', 'info');

          const response = await fetch(`/api/workflows/${workflowType}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              triggered_by: 'dashboard',
              timestamp: new Date().toISOString(),
            }),
          });

          const result = await response.json();

          if (response.ok) {
            showNotification(`${workflowType} workflow started (Task ID: ${result.task_id})`, 'success');
            refreshTasks();
          } else {
            showNotification(`Failed to start ${workflowType}: ${result.error}`, 'error');
          }
        } catch (error) {
          showNotification(`Error: ${error.message}`, 'error');
        }
      }

      // Basic Video Generator function
      async function triggerBasicVideo() {
        try {
          showNotification('Starting basic video generation...', 'info');

          const response = await fetch('/api/basic-video/generate', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              triggered_by: 'dashboard',
              timestamp: new Date().toISOString(),
              title: 'Test Video',
              audio_text: 'This is a test video generated by the basic video generator.',
            }),
          });

          const result = await response.json();

          if (response.ok) {
            showNotification(`Basic video generation started: ${result.video_path}`, 'success');
          } else {
            showNotification(`Failed to generate video: ${result.error}`, 'error');
          }
        } catch (error) {
          showNotification(`Error: ${error.message}`, 'error');
        }
      }

      // Monetization functions
      async function toggleMonetization(feature, enabled) {
        try {
          const response = await fetch('/api/monetization/toggle', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              feature: feature,
              enabled: enabled,
            }),
          });

          const result = await response.json();

          if (response.ok) {
            showNotification(`${feature} ${enabled ? 'enabled' : 'disabled'}`, 'success');
          } else {
            showNotification(`Failed to toggle ${feature}: ${result.error}`, 'error');
            // Revert toggle state
            document.getElementById(`${feature}-toggle`).checked = !enabled;
          }
        } catch (error) {
          showNotification(`Error: ${error.message}`, 'error');
          // Revert toggle state
          document.getElementById(`${feature}-toggle`).checked = !enabled;
        }
      }

      // Dashboard refresh functions - Updated for modular interface
      async function refreshDashboard() {
        // Only refresh if elements exist in current module
        const activeModule = document.querySelector('.module-content.active');
        if (!activeModule) return;

        const moduleId = activeModule.id;

        switch (moduleId) {
          case 'agent-center':
            await refreshAgentStatus();
            break;
          case 'intelligence-db':
            await refreshDatabaseStats();
            break;
          case 'product-studio':
            await refreshProjectStatus();
            break;
          case 'reporting-engine':
            await refreshReportStatus();
            break;
        }
      }

      async function refreshAgentStatus() {
        try {
          const response = await fetch('/api/agents/status');

          // Check if response is actually JSON
          const contentType = response.headers.get('content-type');
          if (!contentType || !contentType.includes('application/json')) {
            console.warn('Agent API returned non-JSON response:', contentType);
            showNotification('Agent API service may not be running', 'warning');
            return;
          }

          const data = await response.json();

          if (response.ok && data.agents) {
            updateAgentGrid(data.agents);
          } else {
            showNotification(`Failed to refresh agent status: ${data.error || 'Unknown error'}`, 'error');
          }
        } catch (error) {
          console.error('Failed to refresh agent status:', error);
          if (error.message.includes('Unexpected token')) {
            showNotification('Agent API returned invalid response format', 'error');
          } else {
            showNotification('Failed to connect to agent API', 'error');
          }
        }
      }

      async function refreshDatabaseStats() {
        try {
          const response = await fetch('/api/database/stats');

          // Check if response is actually JSON
          const contentType = response.headers.get('content-type');
          if (!contentType || !contentType.includes('application/json')) {
            console.warn('Database API returned non-JSON response:', contentType);
            showNotification('Database API service may not be running', 'warning');
            return;
          }

          const data = await response.json();

          if (response.ok) {
            updateDatabaseStats(data);
          } else {
            showNotification(`Failed to refresh database stats: ${data.error || 'Unknown error'}`, 'error');
          }
        } catch (error) {
          console.error('Failed to refresh database stats:', error);
          if (error.message.includes('Unexpected token')) {
            showNotification('Database API returned invalid response format', 'error');
          } else {
            showNotification('Failed to connect to database API', 'error');
          }
        }
      }

      async function refreshProjectStatus() {
        try {
          const response = await fetch('/api/projects/status');

          // Check if response is actually JSON
          const contentType = response.headers.get('content-type');
          if (!contentType || !contentType.includes('application/json')) {
            console.warn('API returned non-JSON response:', contentType);
            showNotification('API service may not be running properly', 'warning');
            return;
          }

          const data = await response.json();

          if (response.ok) {
            updateProjectGrid(data.projects);
          } else {
            showNotification(`Failed to refresh project status: ${data.error || 'Unknown error'}`, 'error');
          }
        } catch (error) {
          console.error('Failed to refresh project status:', error);
          if (error.message.includes('Unexpected token')) {
            showNotification('API returned invalid response format', 'error');
          } else {
            showNotification('Failed to connect to project API', 'error');
          }
        }
      }

      async function refreshReportStatus() {
        try {
          const response = await fetch('/api/reports/status');
          const data = await response.json();

          if (response.ok) {
            updateReportStatus(data);
          }
        } catch (error) {
          console.error('Failed to refresh report status:', error);
        }
      }

      async function checkHealth() {
        try {
          const response = await fetch('/api/health');
          const data = await response.json();

          // Only update if health indicators exist in current view
          const indicator = document.getElementById('health-indicator');
          const status = document.getElementById('health-status');

          if (indicator && status) {
            if (response.ok && data.status === 'healthy') {
              indicator.className = 'status-indicator status-active';
              status.textContent = 'Healthy';
            } else {
              indicator.className = 'status-indicator status-inactive';
              status.textContent = 'Unhealthy';
            }
          }
        } catch (error) {
          const indicator = document.getElementById('health-indicator');
          const status = document.getElementById('health-status');
          if (indicator && status) {
            indicator.className = 'status-indicator status-inactive';
            status.textContent = 'Offline';
          }
        }
      }

      // Legacy update functions - Updated with null checks
      function updateTaskList(tasks) {
        const taskList = document.getElementById('task-list');
        if (!taskList) return; // Element doesn't exist in new modular structure

        if (tasks.length === 0) {
          taskList.innerHTML =
            '<div class="task-item"><div class="task-info"><div class="task-type">No tasks</div><div class="task-status">Queue is empty</div></div><span class="task-badge badge-completed">Ready</span></div>';
          return;
        }

        taskList.innerHTML = tasks
          .map(task => {
            const badgeClass = `badge-${task.status.toLowerCase()}`;
            return `
                    <div class="task-item">
                        <div class="task-info">
                            <div class="task-type">${task.type}</div>
                            <div class="task-status">ID: ${task.id} | Priority: ${task.priority}</div>
                        </div>
                        <span class="task-badge ${badgeClass}">${task.status}</span>
                    </div>
                `;
          })
          .join('');
      }

      function updateStats(data) {
        if (data.queue_stats) {
          const stats = data.queue_stats;
          const pendingEl = document.getElementById('pending-tasks');
          const runningEl = document.getElementById('running-tasks');

          if (pendingEl) pendingEl.textContent = stats.pending || 0;
          if (runningEl) runningEl.textContent = stats.running || 0;
        }

        if (data.system_info && data.system_info.uptime) {
          const uptimeEl = document.getElementById('uptime');
          if (uptimeEl) uptimeEl.textContent = data.system_info.uptime;
        }
      }

      function updateChannelStatus(channels) {
        if (channels.youtube) {
          const subsEl = document.getElementById('youtube-subs');
          const videosEl = document.getElementById('youtube-videos');
          if (subsEl) subsEl.textContent = formatNumber(channels.youtube.subscribers);
          if (videosEl) videosEl.textContent = channels.youtube.videos;
        }

        if (channels.tiktok) {
          const followersEl = document.getElementById('tiktok-followers');
          const videosEl = document.getElementById('tiktok-videos');
          if (followersEl) followersEl.textContent = formatNumber(channels.tiktok.followers);
          if (videosEl) videosEl.textContent = channels.tiktok.videos;
        }

        if (channels.instagram) {
          const followersEl = document.getElementById('instagram-followers');
          const postsEl = document.getElementById('instagram-posts');
          if (followersEl) followersEl.textContent = formatNumber(channels.instagram.followers);
          if (postsEl) postsEl.textContent = channels.instagram.posts;
        }
      }

      // Utility functions
      function formatNumber(num) {
        if (num >= 1000000) {
          return (num / 1000000).toFixed(1) + 'M';
        } else if (num >= 1000) {
          return (num / 1000).toFixed(1) + 'K';
        }
        return num.toString();
      }

      function showNotification(message, type = 'info') {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.className = `notification ${type} show`;

        setTimeout(() => {
          notification.classList.remove('show');
        }, 3000);
      }

      function startAutoRefresh() {
        refreshInterval = setInterval(refreshDashboard, 5000); // Refresh every 5 seconds
      }

      function stopAutoRefresh() {
        if (refreshInterval) {
          clearInterval(refreshInterval);
        }
      }

      // Module tab switching
      function switchModule(moduleId) {
        // Hide all module content
        const modules = document.querySelectorAll('.module-content');
        modules.forEach(module => {
          module.classList.remove('active');
        });

        // Remove active class from all tabs
        const tabs = document.querySelectorAll('.tab-button');
        tabs.forEach(tab => {
          tab.classList.remove('active');
        });

        // Show selected module and activate tab
        document.getElementById(moduleId).classList.add('active');
        document.querySelector(`[onclick="switchModule('${moduleId}')"]`).classList.add('active');

        // Load module-specific data
        if (moduleId === 'affiliate-center') {
          loadAffiliateStatus();
          loadAffiliatePrograms();
          loadAffiliateOpportunities();
          loadAPIStatus();
        } else if (moduleId === 'api-center') {
          loadAPIKPIs();
          loadAPIRegistry();
          loadAPIOpportunities();
        } else if (moduleId === 'creative-sandbox') {
          loadChannels();
          loadProductionQueue();
        } else if (moduleId === 'code-backup') {
          loadProjectStructure();
        } else if (moduleId === 'audience-center') {
          loadAudienceStats();
          loadContacts();
          loadCampaigns();
          loadSegments();
        }
      }

      // Agent Command Center functions
      async function controlAgent(agentId, action) {
        try {
          const response = await fetch('/api/agents/control', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              agent_id: agentId,
              action: action,
            }),
          });

          const data = await response.json();

          if (response.ok) {
            showNotification(`Agent ${agentId} ${action} successful`, 'success');
            // Refresh agent status
            refreshAgentStatus();
          } else {
            showNotification(`Failed to ${action} agent: ${data.error}`, 'error');
          }
        } catch (error) {
          showNotification(`Error controlling agent: ${error.message}`, 'error');
        }
      }

      async function viewAgentLogs(agentId) {
        try {
          const response = await fetch(`/api/agents/${agentId}/logs`);
          const data = await response.json();

          if (response.ok) {
            const logViewer = document.getElementById('agent-logs');
            logViewer.innerHTML = data.logs
              .map(
                log => `
                        <div class="log-entry">
                            <span class="log-timestamp">${log.timestamp}</span>
                            <span class="log-level log-${log.level.toLowerCase()}">${log.level}</span>
                            <span class="log-message">${log.message}</span>
                        </div>
                    `
              )
              .join('');
          } else {
            showNotification(`Failed to load logs: ${data.error}`, 'error');
          }
        } catch (error) {
          showNotification(`Error loading logs: ${error.message}`, 'error');
        }
      }

      function updateAgentGrid(agents) {
        // Update agent status display in the Agent Command Center
        const agentGrid = document.getElementById('agent-grid');

        if (!agents || agents.length === 0) {
          console.warn('No agents data received');
          agentGrid.innerHTML =
            '<div class="agent-card"><div class="agent-header"><h3>No Active Agents</h3><span class="status-indicator status-idle"></span></div><div class="agent-metrics"><p>No agents are currently running. Start the orchestrator to see agent status.</p></div></div>';
          return;
        }

        // Clear existing agent cards
        agentGrid.innerHTML = '';

        // Create agent cards dynamically
        agents.forEach(agent => {
          const agentCard = document.createElement('div');
          agentCard.className = 'agent-card';

          // Map status to appropriate CSS classes
          let statusClass = 'status-idle';
          let statusText = 'Idle';

          if (agent.status === 'running' || agent.status === 'busy') {
            statusClass = 'status-active';
            statusText = 'Active';
          } else if (agent.status === 'error' || agent.status === 'failed') {
            statusClass = 'status-error';
            statusText = 'Error';
          } else if (agent.status === 'paused' || agent.status === 'stopped') {
            statusClass = 'status-warning';
            statusText = 'Paused';
          }

          // Format agent name
          const agentName = agent.name || agent.id || 'Unknown Agent';
          const displayName = agentName.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());

          // Calculate task count
          const taskCount = agent.tasks_completed || 0;

          agentCard.innerHTML = `
                    <div class="agent-header">
                        <h3>${displayName}</h3>
                        <span class="status-indicator ${statusClass}" title="${statusText}"></span>
                    </div>
                    <div class="agent-metrics">
                        <div class="metric">
                            <div class="metric-value">${agent.uptime || '0h 0m'}</div>
                            <div class="metric-label">Uptime</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">${taskCount}</div>
                            <div class="metric-label">Tasks</div>
                        </div>
                    </div>
                    <div class="agent-controls">
                        <button class="btn btn-sm btn-warning" onclick="controlAgent('${agent.id}', 'pause')" ${agent.status === 'paused' ? 'disabled' : ''}>â¸ï¸ Pause</button>
                        <button class="btn btn-sm btn-success" onclick="controlAgent('${agent.id}', 'restart')" ${agent.status === 'running' ? 'disabled' : ''}>â–¶ï¸ Restart</button>
                        <button class="btn btn-sm btn-info" onclick="viewAgentLogs('${agent.id}')">ðŸ“‹ Logs</button>
                    </div>
                    ${agent.current_task ? `<div class="current-task" style="margin-top: 10px; padding: 8px; background: #f7fafc; border-radius: 4px; font-size: 0.9em;"><strong>Current:</strong> ${agent.current_task}</div>` : ''}
                    ${agent.error_message ? `<div class="error-message" style="color: #e53e3e; margin-top: 10px; font-size: 0.9em; padding: 8px; background: #fed7d7; border-radius: 4px;">${agent.error_message}</div>` : ''}
                `;

          agentGrid.appendChild(agentCard);
        });

        console.log(`Updated agent grid with ${agents.length} agents`);
      }

      function updateDatabaseStats(stats) {
        // Update database statistics in the Intelligence Database
        if (stats.tables) {
          const tableItems = document.querySelectorAll('.table-item');
          // Update table counts if available
          Object.keys(stats.tables).forEach(tableName => {
            const tableItem = Array.from(tableItems).find(item => item.getAttribute('onclick')?.includes(tableName));
            if (tableItem) {
              const countElement = tableItem.querySelector('.table-count');
              if (countElement) {
                countElement.textContent = `${stats.tables[tableName]} records`;
              }
            }
          });
        }
      }

      // Audience Management functions
      async function loadAudienceStats() {
        try {
          const response = await fetch('/api/audience/stats');
          const data = await response.json();

          if (response.ok) {
            document.getElementById('total-contacts').textContent = data.total_contacts || 0;
            document.getElementById('active-campaigns').textContent = data.active_campaigns || 0;
            document.getElementById('open-rate').textContent = (data.open_rate || 0) + '%';
            document.getElementById('conversion-rate').textContent = (data.conversion_rate || 0) + '%';
          } else {
            console.error('Failed to load audience stats:', data.error);
          }
        } catch (error) {
          console.error('Error loading audience stats:', error);
        }
      }

      async function loadContacts() {
        try {
          const response = await fetch('/api/audience/contacts');
          const data = await response.json();

          if (response.ok) {
            const contactList = document.getElementById('contact-list');
            if (data.contacts && data.contacts.length > 0) {
              contactList.innerHTML = data.contacts
                .map(
                  contact => `
                            <div class="contact-item">
                                <div class="contact-info">
                                    <h4>${contact.name || 'Unknown'}</h4>
                                    <p>${contact.email}</p>
                                    <span class="contact-status ${contact.status}">${contact.status}</span>
                                </div>
                                <div class="contact-actions">
                                    <button onclick="editContact('${contact.id}')" class="btn-small">Edit</button>
                                    <button onclick="deleteContact('${contact.id}')" class="btn-small btn-danger">Delete</button>
                                </div>
                            </div>
                        `
                )
                .join('');
            } else {
              contactList.innerHTML = '<p>No contacts found. Add your first contact!</p>';
            }
          } else {
            console.error('Failed to load contacts:', data.error);
          }
        } catch (error) {
          console.error('Error loading contacts:', error);
        }
      }

      async function loadCampaigns() {
        // Campaign loading will be implemented when needed
        console.log('Loading campaigns...');
      }

      async function loadSegments() {
        try {
          const response = await fetch('/api/audience/segments');
          const data = await response.json();

          if (response.ok) {
            const segmentList = document.getElementById('segment-list');
            if (data.segments && data.segments.length > 0) {
              segmentList.innerHTML = data.segments
                .map(
                  segment => `
                            <div class="segment-item">
                                <h4>${segment.name}</h4>
                                <p>Criteria: ${segment.criteria}</p>
                                <span class="segment-count">${segment.contact_count || 0} contacts</span>
                            </div>
                        `
                )
                .join('');
            } else {
              segmentList.innerHTML = '<p>No segments created yet.</p>';
            }
          } else {
            console.error('Failed to load segments:', data.error);
          }
        } catch (error) {
          console.error('Error loading segments:', error);
        }
      }

      async function showAddContactForm() {
        const name = prompt('Contact Name:');
        const email = prompt('Contact Email:');

        if (name && email) {
          await addContact(name, email);
        }
      }

      async function addContact(name, email) {
        try {
          const response = await fetch('/api/audience/contacts', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ name, email }),
          });

          const data = await response.json();

          if (response.ok) {
            showNotification('Contact added successfully!', 'success');
            loadContacts(); // Refresh the contact list
            loadAudienceStats(); // Refresh stats
          } else {
            showNotification(`Failed to add contact: ${data.error}`, 'error');
          }
        } catch (error) {
          showNotification(`Error adding contact: ${error.message}`, 'error');
        }
      }

      async function createCampaign() {
        const name = document.getElementById('campaign-name').value;
        const type = document.getElementById('campaign-type').value;
        const content = document.getElementById('campaign-content').value;

        if (!name || !content) {
          showNotification('Please fill in campaign name and content', 'error');
          return;
        }

        try {
          const response = await fetch('/api/audience/campaigns', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ name, type, content }),
          });

          const data = await response.json();

          if (response.ok) {
            showNotification('Campaign created successfully!', 'success');
            // Clear form
            document.getElementById('campaign-name').value = '';
            document.getElementById('campaign-content').value = '';
            loadAudienceStats(); // Refresh stats
          } else {
            showNotification(`Failed to create campaign: ${data.error}`, 'error');
          }
        } catch (error) {
          showNotification(`Error creating campaign: ${error.message}`, 'error');
        }
      }

      async function createSegment() {
        const name = document.getElementById('segment-name').value;
        const criteria = document.getElementById('segment-criteria').value;

        if (!name || !criteria) {
          showNotification('Please fill in segment name and criteria', 'error');
          return;
        }

        try {
          const response = await fetch('/api/audience/segments', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ name, criteria }),
          });

          const data = await response.json();

          if (response.ok) {
            showNotification('Segment created successfully!', 'success');
            // Clear form
            document.getElementById('segment-name').value = '';
            document.getElementById('segment-criteria').value = '';
            loadSegments(); // Refresh segments
          } else {
            showNotification(`Failed to create segment: ${data.error}`, 'error');
          }
        } catch (error) {
          showNotification(`Error creating segment: ${error.message}`, 'error');
        }
      }

      async function importContacts() {
        showNotification('Contact import feature coming soon!', 'info');
      }

      async function exportContacts() {
        showNotification('Contact export feature coming soon!', 'info');
      }

      // Intelligence Database functions
      async function loadTable(tableName) {
        try {
          const response = await fetch(`/api/database/query`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ query: `SELECT * FROM ${tableName} LIMIT 50` }),
          });

          const data = await response.json();

          if (response.ok) {
            displayQueryResults(data.results);
            document.getElementById('sql-query').value = `SELECT * FROM ${tableName} LIMIT 50;`;
          } else {
            showNotification(`Failed to load table: ${data.error}`, 'error');
          }
        } catch (error) {
          showNotification(`Error loading table: ${error.message}`, 'error');
        }
      }

      async function executeQuery() {
        const query = document.getElementById('sql-query').value.trim();

        if (!query) {
          showNotification('Please enter a SQL query', 'error');
          return;
        }

        try {
          const response = await fetch('/api/database/query', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ query: query }),
          });

          const data = await response.json();

          if (response.ok) {
            displayQueryResults(data.results);
            showNotification('Query executed successfully', 'success');
          } else {
            showNotification(`Query failed: ${data.error}`, 'error');
          }
        } catch (error) {
          showNotification(`Error executing query: ${error.message}`, 'error');
        }
      }

      function displayQueryResults(results) {
        const resultsDiv = document.getElementById('query-results');

        if (!results || results.length === 0) {
          resultsDiv.innerHTML = '<p>No results found.</p>';
          return;
        }

        // Create table from results
        const headers = Object.keys(results[0]);
        const table = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr>
                            ${headers.map(h => `<th style="border: 1px solid #e2e8f0; padding: 8px; background: #f7fafc;">${h}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        ${results
                          .map(
                            row => `
                            <tr>
                                ${headers.map(h => `<td style="border: 1px solid #e2e8f0; padding: 8px;">${row[h] || ''}</td>`).join('')}
                            </tr>
                        `
                          )
                          .join('')}
                    </tbody>
                </table>
            `;

        resultsDiv.innerHTML = table;
      }

      // Digital Product Studio functions
      async function loadProjects() {
        try {
          const response = await fetch('/api/projects');
          const data = await response.json();

          if (response.ok) {
            displayProjects(data.projects);
          }
        } catch (error) {
          console.error('Failed to load projects:', error);
        }
      }

      function displayProjects(projects) {
        const projectGrid = document.getElementById('project-grid');

        if (!projects || projects.length === 0) {
          projectGrid.innerHTML =
            '<p class="no-projects">No projects found. Create your first project to get started!</p>';
          return;
        }

        projectGrid.innerHTML = projects
          .map(project => {
            const progressPercent = (project.progress * 100).toFixed(2);
            const statusClass = `status-${project.status}`;

            return `
                    <div class="project-card">
                        <div class="project-header">
                            <h3>${project.name}</h3>
                            <span class="project-status ${statusClass}">${project.status}</span>
                        </div>
                        <div class="project-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progressPercent}%"></div>
                            </div>
                            <span class="progress-text">${progressPercent}% Complete</span>
                        </div>
                        <div class="project-metrics">
                            <div class="metric">
                                <div class="metric-value">${project.chapters_completed}</div>
                                <div class="metric-label">Chapters</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value">${project.total_chapters}</div>
                                <div class="metric-label">Total</div>
                            </div>
                        </div>
                        <div class="project-controls">
                            <button class="btn btn-sm btn-info" onclick="reviewProject('${project.id}')">ðŸ“– Review</button>
                            <button class="btn btn-sm btn-success" onclick="updateProject('${project.id}')">âœï¸ Edit</button>
                            <button class="btn btn-sm btn-primary" onclick="generateMarketingPackage('${project.id}')">ðŸš€ Generate Marketing Package</button>
                        </div>
                    </div>
                `;
          })
          .join('');
      }

      // Missing Product Studio functions
      async function reviewProject(projectId) {
        try {
          const response = await fetch(`/api/projects/${projectId}/review`);
          const data = await response.json();

          if (response.ok) {
            showNotification(`Opening review for project ${projectId}`, 'info');
            // Open review interface
            displayProjectReview(data);
          } else {
            showNotification(`Failed to load project review: ${data.error}`, 'error');
          }
        } catch (error) {
          showNotification(`Error loading project review: ${error.message}`, 'error');
        }
      }

      async function updateProject(projectId) {
        try {
          showNotification(`Opening editor for project ${projectId}`, 'info');
          // Open project editor interface
          const response = await fetch(`/api/projects/${projectId}`);
          const data = await response.json();

          if (response.ok) {
            displayProjectEditor(data);
          } else {
            showNotification(`Failed to load project: ${data.error}`, 'error');
          }
        } catch (error) {
          showNotification(`Error loading project: ${error.message}`, 'error');
        }
      }

      async function createNewProject() {
        try {
          showNotification('Creating new project...', 'info');
          const response = await fetch('/api/projects/create', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              name: 'New Project',
              type: 'book',
              status: 'draft',
            }),
          });

          const data = await response.json();

          if (response.ok) {
            showNotification('New project created successfully', 'success');
            refreshProjectStatus();
          } else {
            showNotification(`Failed to create project: ${data.error}`, 'error');
          }
        } catch (error) {
          showNotification(`Error creating project: ${error.message}`, 'error');
        }
      }

      async function generateMarketingPackage(projectId) {
        try {
          showNotification('Generating marketing package...', 'info');
          const response = await fetch(`/api/projects/${projectId}/generate-marketing`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              triggered_by: 'dashboard',
              timestamp: new Date().toISOString(),
            }),
          });

          const data = await response.json();

          if (response.ok) {
            showNotification(`Marketing package generation started! Task ID: ${data.task_id}`, 'success');
            // Optionally refresh the dashboard to show the new task
            refreshDashboard();
          } else {
            showNotification(`Failed to generate marketing package: ${data.error}`, 'error');
          }
        } catch (error) {
          showNotification(`Error generating marketing package: ${error.message}`, 'error');
        }
      }

      function displayProjectReview(reviewData) {
        const reviewPanel = document.getElementById('content-review');
        if (reviewPanel) {
          reviewPanel.innerHTML = `
                    <div class="review-item">
                        <h4>${reviewData.title || 'Project Review'}</h4>
                        <p class="review-status">ðŸ“ Review in Progress</p>
                        <div class="review-content">
                            <p>${reviewData.content || 'Review content will appear here...'}</p>
                        </div>
                        <div class="review-actions">
                            <button class="btn btn-sm btn-success">âœ… Approve</button>
                            <button class="btn btn-sm btn-warning">ðŸ“ Request Changes</button>
                            <button class="btn btn-sm btn-info">ðŸ‘ï¸ Preview</button>
                        </div>
                    </div>
                `;
        }
      }

      function displayProjectEditor(projectData) {
        showNotification(`Editor for ${projectData.name || 'project'} would open here`, 'info');
        // Project editor interface would be implemented here
      }

      function updateProjectGrid(projects) {
        const projectGrid = document.getElementById('project-grid');
        if (!projectGrid) return;

        if (!projects || projects.length === 0) {
          projectGrid.innerHTML = `
                    <div class="project-card">
                        <div class="project-header">
                            <h3>No Projects Found</h3>
                            <span class="project-status status-inactive">Empty</span>
                        </div>
                        <p>Create your first project to get started.</p>
                    </div>
                `;
          return;
        }

        projectGrid.innerHTML = projects
          .map(
            project => `
                <div class="project-card">
                    <div class="project-header">
                        <h3>${project.name || 'Untitled Project'}</h3>
                        <span class="project-status status-${project.status || 'inactive'}">${project.status || 'Unknown'}</span>
                    </div>
                    <div class="project-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${project.progress || 0}%"></div>
                        </div>
                        <span class="progress-text">${project.progress || 0}% Complete</span>
                    </div>
                    <div class="project-metrics">
                        <div class="metric">
                            <div class="metric-value">${project.chapters || 0}</div>
                            <div class="metric-label">Chapters</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">${project.words || 0}</div>
                            <div class="metric-label">Words</div>
                        </div>
                    </div>
                    <div class="project-controls">
                        <button class="btn btn-sm btn-info" onclick="reviewProject('${project.id}')">ðŸ“– Review</button>
                        <button class="btn btn-sm btn-success" onclick="updateProject('${project.id}')">âœï¸ Edit</button>
                    </div>
                </div>
            `
          )
          .join('');
      }

      // Reporting Engine functions
      async function generateReport(reportType) {
        try {
          const response = await fetch('/api/reports/generate', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ type: reportType }),
          });

          const data = await response.json();

          if (response.ok) {
            displayReport(data.report);
            showNotification(`${reportType} report generated successfully`, 'success');
          } else {
            showNotification(`Failed to generate report: ${data.error}`, 'error');
          }
        } catch (error) {
          showNotification(`Error generating report: ${error.message}`, 'error');
        }
      }

      function displayReport(report) {
        const reportDisplay = document.getElementById('report-display');
        reportDisplay.innerHTML = `
                <h3>${report.title}</h3>
                <p><strong>Generated:</strong> ${report.timestamp}</p>
                <div>${report.content}</div>
            `;
      }

      // Affiliate Command Center functions
      async function loadAffiliateStatus() {
        try {
          const response = await fetch('/api/affiliates/status');
          const data = await response.json();

          if (response.ok) {
            updateAffiliateKPIs(data);
          } else {
            showNotification(`Failed to load affiliate status: ${data.error}`, 'error');
          }
        } catch (error) {
          showNotification(`Error loading affiliate status: ${error.message}`, 'error');
        }
      }

      function updateAffiliateKPIs(data) {
        document.getElementById('total-revenue').textContent = `$${data.total_revenue || '0.00'}`;
        document.getElementById('top-program').textContent = data.top_program || 'None';
        document.getElementById('best-link').textContent = data.best_link || 'None';
      }

      async function loadAffiliatePrograms() {
        try {
          const response = await fetch('/api/affiliates/programs');
          const data = await response.json();

          if (response.ok) {
            displayAffiliatePrograms(data);
          } else {
            showNotification(`Failed to load affiliate programs: ${data.error}`, 'error');
          }
        } catch (error) {
          showNotification(`Error loading affiliate programs: ${error.message}`, 'error');
        }
      }

      function displayAffiliatePrograms(data) {
        const programsBody = document.getElementById('affiliate-programs-body');

        // Handle nested programs structure - API returns {programs: {programs: [...]}}
        const programsList = data?.programs?.programs || data?.programs || data || [];

        if (!programsList || !Array.isArray(programsList) || programsList.length === 0) {
          programsBody.innerHTML =
            '<tr><td colspan="7" class="loading-message">No affiliate programs found. Add your first program to get started.</td></tr>';
          return;
        }

        programsBody.innerHTML = programsList
          .map(program => {
            const statusColor = getStatusColor(program.last_health_status || 'unknown');
            const linkStatus = program.signup_url ? 'Configured' : 'Missing';

            return `
                    <tr>
                        <td>
                            <span class="status-light ${statusColor}"></span>
                            ${(program.last_health_status || 'unknown').charAt(0).toUpperCase() + (program.last_health_status || 'unknown').slice(1)}
                        </td>
                        <td><strong>${program.name || 'Unnamed Program'}</strong></td>
                        <td>${program.capability || 'Uncategorized'}</td>
                        <td>
                            <span class="${linkStatus === 'Configured' ? 'text-success' : 'text-danger'}">
                                ${linkStatus}
                            </span>
                        </td>
                        <td>${program.commission_rate || '0'}%</td>
                        <td>${program.conversion_rate_30_days || '0.0'}%</td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="viewProgramDetails('${program.id}')" title="View Details">ðŸ“Š</button>
                            <button class="btn btn-sm btn-warning" onclick="updateServiceSecret('${program.id}', '${program.name}')" title="Update Link">ðŸ”—</button>
                            <button class="btn btn-sm ${program.is_active ? 'btn-danger' : 'btn-success'}" onclick="toggleServiceActive('${program.id}', ${program.is_active})" title="${program.is_active ? 'Deactivate' : 'Activate'}">
                                ${program.is_active ? 'â¸ï¸' : 'â–¶ï¸'}
                            </button>
                        </td>
                    </tr>
                `;
          })
          .join('');
      }

      async function loadAffiliateOpportunities() {
        try {
          const response = await fetch('/api/affiliates/opportunities');
          const data = await response.json();

          if (response.ok) {
            displayAffiliateOpportunities(data.opportunities);
          } else {
            showNotification(`Failed to load opportunities: ${data.error}`, 'error');
          }
        } catch (error) {
          showNotification(`Error loading opportunities: ${error.message}`, 'error');
        }
      }

      function displayAffiliateOpportunities(opportunities) {
        const opportunityList = document.getElementById('opportunity-list');

        if (!opportunities || opportunities.length === 0) {
          opportunityList.innerHTML =
            '<p>No new opportunities found. The Research Agent will continue searching for relevant programs.</p>';
          return;
        }

        opportunityList.innerHTML = opportunities
          .map(
            opp => `
                <div class="opportunity-item">
                    <div class="opportunity-info">
                        <h4>${opp.name || 'Unnamed Opportunity'}</h4>
                        <p>${opp.description || 'No description available'}</p>
                        <div class="opportunity-potential">ðŸ’° Potential: ${opp.potential || 'Unknown'}</div>
                    </div>
                    <button class="btn btn-sm btn-success" onclick="signupForOpportunity(${opp.id})">
                        ðŸ¤– Task Agent to Sign Up
                    </button>
                </div>
            `
          )
          .join('');
      }

      async function loadAPIStatus() {
        try {
          const response = await fetch('/api/apis/status');
          const data = await response.json();

          if (response.ok) {
            displayAPIStatus(data);
          } else {
            showNotification(`Failed to load API status: ${data.error}`, 'error');
          }
        } catch (error) {
          showNotification(`Error loading API status: ${error.message}`, 'error');
        }
      }

      function displayAPIStatus(data) {
        const apiList = document.getElementById('api-list');

        if (!data.apis || data.apis.length === 0) {
          apiList.innerHTML = '<p>No APIs configured.</p>';
          return;
        }

        apiList.innerHTML = data.apis
          .map(
            api => `
                <div class="api-item">
                    <div class="api-info">
                        <h4>${api.name || 'Unnamed API'}</h4>
                        <div class="api-usage-info">${api.usage || '0'} requests today</div>
                    </div>
                    <div class="api-status ${api.status || 'unknown'}">${api.status || 'Unknown'}</div>
                </div>
            `
          )
          .join('');
      }

      async function viewProgramDetails(programId) {
        try {
          const response = await fetch(`/api/affiliates/programs/${programId}`);
          const data = await response.json();

          if (response.ok) {
            showNotification(`Opening detailed view for ${data.name}`, 'info');
            // Detailed view would be implemented here
          } else {
            showNotification(`Failed to load program details: ${data.error}`, 'error');
          }
        } catch (error) {
          showNotification(`Error loading program details: ${error.message}`, 'error');
        }
      }

      async function updateLinkTemplate(programId) {
        showNotification('Link template update interface would open here', 'info');
        // Link template update interface would be implemented here
      }

      async function toggleProgram(programId, currentStatus) {
        try {
          const response = await fetch(`/api/affiliates/programs/${programId}/control`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ action: currentStatus ? 'pause' : 'activate' }),
          });

          const data = await response.json();

          if (response.ok) {
            showNotification(`Program ${currentStatus ? 'paused' : 'activated'} successfully`, 'success');
            loadAffiliatePrograms(); // Refresh the list
          } else {
            showNotification(`Failed to toggle program: ${data.error}`, 'error');
          }
        } catch (error) {
          showNotification(`Error toggling program: ${error.message}`, 'error');
        }
      }

      async function signupForOpportunity(opportunityId) {
        try {
          const response = await fetch(`/api/affiliates/opportunities/${opportunityId}/signup`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
          });

          const data = await response.json();

          if (response.ok) {
            showNotification('Stealth Automation Agent has been tasked with signup', 'success');
            loadAffiliateOpportunities(); // Refresh the list
          } else {
            showNotification(`Failed to initiate signup: ${data.error}`, 'error');
          }
        } catch (error) {
          showNotification(`Error initiating signup: ${error.message}`, 'error');
        }
      }

      // API Command Center functions
      async function loadAPIKPIs() {
        try {
          const response = await fetch('/api/apis/status');
          const data = await response.json();

          if (response.ok) {
            updateAPIKPIs(data);
          } else {
            showNotification(`Failed to load API KPIs: ${data.error}`, 'error');
          }
        } catch (error) {
          showNotification(`Error loading API KPIs: ${error.message}`, 'error');
        }
      }

      function updateAPIKPIs(data) {
        document.getElementById('total-apis').textContent = data.total_apis || '0';
        document.getElementById('active-apis').textContent = data.active_apis || '0';
        document.getElementById('total-calls').textContent = data.total_calls || '0';
        document.getElementById('avg-response').textContent = `${data.avg_response_time || '0'}ms`;
      }

      async function loadAPIRegistry() {
        try {
          const response = await fetch('/api/apis/registry');
          const data = await response.json();

          if (response.ok) {
            displayAPIRegistry(data.apis);
          } else {
            showNotification(`Failed to load API registry: ${data.error}`, 'error');
          }
        } catch (error) {
          showNotification(`Error loading API registry: ${error.message}`, 'error');
        }
      }

      function displayAPIRegistry(apis) {
        const registryBody = document.getElementById('api-registry-body');

        if (!apis || apis.length === 0) {
          registryBody.innerHTML =
            '<tr><td colspan="7" class="loading-message">No APIs registered. Add your first API to get started.</td></tr>';
          return;
        }

        registryBody.innerHTML = apis
          .map(api => {
            const statusColor = getStatusColor(api.last_health_status || 'unknown');
            const keyStatus = api.api_key ? 'Configured' : 'Missing';

            return `
                    <tr>
                        <td>
                            <span class="status-light ${statusColor}"></span>
                            ${(api.last_health_status || 'unknown').charAt(0).toUpperCase() + (api.last_health_status || 'unknown').slice(1)}
                        </td>
                        <td><strong>${api.name || 'Unnamed API'}</strong></td>
                        <td>${api.capability || 'Uncategorized'}</td>
                        <td>
                            <span class="${keyStatus === 'Configured' ? 'text-success' : 'text-danger'}">
                                ${keyStatus}
                            </span>
                        </td>
                        <td>${api.call_count_30_days || '0'}</td>
                        <td>${api.error_rate_30_days || '0.0'}%</td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="viewAPIDetails('${api.id}')" title="View Details">ðŸ“Š</button>
                            <button class="btn btn-sm btn-warning" onclick="updateServiceSecret('${api.id}', '${api.name}')" title="Update API Key">ðŸ”‘</button>
                            <button class="btn btn-sm ${api.is_active ? 'btn-danger' : 'btn-success'}" onclick="toggleServiceActive('${api.id}', ${api.is_active})" title="${api.is_active ? 'Deactivate' : 'Activate'}">
                                ${api.is_active ? 'â¸ï¸' : 'â–¶ï¸'}
                            </button>
                        </td>
                    </tr>
                `;
          })
          .join('');
      }

      function getStatusColor(status) {
        switch (status?.toLowerCase()) {
          case 'healthy':
          case 'active':
            return 'green';
          case 'warning':
          case 'degraded':
            return 'yellow';
          case 'error':
          case 'down':
            return 'red';
          default:
            return 'yellow';
        }
      }

      async function loadAPIOpportunities() {
        try {
          const response = await fetch('/api/suggestions');
          const data = await response.json();

          if (response.ok) {
            displayAPIOpportunities(data.suggestions || data);
          } else {
            showNotification(`Failed to load API suggestions: ${data.error}`, 'error');
          }
        } catch (error) {
          showNotification(`Error loading API suggestions: ${error.message}`, 'error');
        }
      }

      function displayAPIOpportunities(suggestions) {
        const opportunitiesContainer = document.getElementById('api-opportunities');

        if (!suggestions || suggestions.length === 0) {
          opportunitiesContainer.innerHTML = `
                    <div class="empty-state">
                        <p>ðŸ” No new API suggestions found.</p>
                        <p>The Research Agent will continue searching for relevant APIs.</p>
                        <button class="btn btn-primary" onclick="triggerAPIDiscovery()">ðŸš€ Trigger Discovery</button>
                    </div>
                `;
          return;
        }

        opportunitiesContainer.innerHTML = suggestions
          .map(
            suggestion => `
                <div class="suggestion-card" data-suggestion-id="${suggestion.id}">
                    <div class="suggestion-header">
                        <h4>${suggestion.api_name || 'Unnamed API'}</h4>
                        <div class="suggestion-score">${Math.round(suggestion.confidence_score || 0)}% Match</div>
                        <div class="suggestion-status status-${suggestion.status}">${suggestion.status}</div>
                    </div>
                    <div class="suggestion-description">${suggestion.description || 'No description available'}</div>
                    <div class="suggestion-details">
                        <div class="capability-tag">${suggestion.capability || 'General'}</div>
                        <div class="source-tag">Found via: ${suggestion.discovery_source || 'Research Agent'}</div>
                        ${suggestion.estimated_cost ? `<div class="cost-tag">ðŸ’° ~$${suggestion.estimated_cost}/month</div>` : ''}
                    </div>
                    <div class="suggestion-actions">
                        <button class="btn btn-sm btn-success" onclick="approveSuggestion('${suggestion.id}')">
                            âœ… Approve & Add
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="rejectSuggestion('${suggestion.id}')">
                            âŒ Reject
                        </button>
                        <button class="btn btn-sm btn-info" onclick="viewSuggestionDetails('${suggestion.id}')">
                            ðŸ“‹ Details
                        </button>
                    </div>
                </div>
            `
          )
          .join('');
      }

      async function viewAPIDetails(apiId) {
        try {
          const response = await fetch(`/api/apis/${apiId}`);
          const data = await response.json();

          if (response.ok) {
            showNotification(`Opening detailed view for ${data.name}`, 'info');
            // Detailed view would be implemented here
          } else {
            showNotification(`Failed to load API details: ${data.error}`, 'error');
          }
        } catch (error) {
          showNotification(`Error loading API details: ${error.message}`, 'error');
        }
      }

      async function updateAPIKey(apiId) {
        showNotification('API key update interface would open here', 'info');
        // API key update interface would be implemented here
      }

      async function toggleAPI(apiId, currentStatus) {
        try {
          const response = await fetch(`/api/apis/${apiId}/control`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ action: currentStatus ? 'pause' : 'activate' }),
          });

          const data = await response.json();

          if (response.ok) {
            showNotification(`API ${currentStatus ? 'paused' : 'activated'} successfully`, 'success');
            loadAPIRegistry(); // Refresh the registry
          } else {
            showNotification(`Failed to toggle API: ${data.error}`, 'error');
          }
        } catch (error) {
          showNotification(`Error toggling API: ${error.message}`, 'error');
        }
      }

      async function approveSuggestion(suggestionId) {
        try {
          const response = await fetch(`/api/suggestions/${suggestionId}/approve`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
          });

          const data = await response.json();

          if (response.ok) {
            showNotification('âœ… API suggestion approved and added to registry!', 'success');
            loadAPIOpportunities(); // Refresh suggestions
            loadAPIRegistry(); // Refresh registry
          } else {
            showNotification(`Failed to approve suggestion: ${data.error}`, 'error');
          }
        } catch (error) {
          showNotification(`Error approving suggestion: ${error.message}`, 'error');
        }
      }

      async function rejectSuggestion(suggestionId) {
        try {
          const response = await fetch(`/api/suggestions/${suggestionId}/reject`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
          });

          const data = await response.json();

          if (response.ok) {
            showNotification('âŒ API suggestion rejected', 'info');
            loadAPIOpportunities(); // Refresh suggestions
          } else {
            showNotification(`Failed to reject suggestion: ${data.error}`, 'error');
          }
        } catch (error) {
          showNotification(`Error rejecting suggestion: ${error.message}`, 'error');
        }
      }

      async function triggerAPIDiscovery() {
        try {
          const response = await fetch('/api/discovery/trigger', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
          });

          const data = await response.json();

          if (response.ok) {
            showNotification('ðŸš€ API discovery process initiated!', 'success');
            // Refresh after a delay to allow discovery to run
            setTimeout(() => {
              loadAPIOpportunities();
            }, 3000);
          } else {
            showNotification(`Failed to trigger discovery: ${data.error}`, 'error');
          }
        } catch (error) {
          showNotification(`Error triggering discovery: ${error.message}`, 'error');
        }
      }

      async function viewSuggestionDetails(suggestionId) {
        try {
          const response = await fetch(`/api/suggestions/${suggestionId}`);
          const data = await response.json();

          if (response.ok) {
            // Create a modal or detailed view
            const details = `
                        API Name: ${data.api_name}\n
                        Description: ${data.description}\n
                        Capability: ${data.capability}\n
                        Confidence Score: ${data.confidence_score}%\n
                        Discovery Source: ${data.discovery_source}\n
                        Reasoning: ${data.reasoning || 'Not provided'}
                    `;
            alert(details); // Simple implementation - could be enhanced with a modal
          } else {
            showNotification(`Failed to load suggestion details: ${data.error}`, 'error');
          }
        } catch (error) {
          showNotification(`Error loading suggestion details: ${error.message}`, 'error');
        }
      }

      // Creative Sandbox Functions
      async function loadChannels() {
        try {
          const response = await fetch('/api/sandbox/channels');
          const data = await response.json();

          if (response.ok) {
            populateChannelDropdown(data.channels);
          } else {
            showNotification(`Failed to load channels: ${data.error}`, 'error');
          }
        } catch (error) {
          showNotification(`Error loading channels: ${error.message}`, 'error');
        }
      }

      function populateChannelDropdown(channels) {
        const channelSelect = document.getElementById('channel-select');
        channelSelect.innerHTML = '<option value="">Select Channel...</option>';

        channels.forEach(channel => {
          const option = document.createElement('option');
          option.value = channel.id;
          option.textContent = channel.name;
          channelSelect.appendChild(option);
        });
      }

      async function onChannelChange() {
        const channelId = document.getElementById('channel-select').value;
        if (!channelId) return;

        try {
          const response = await fetch(`/api/sandbox/channels/${channelId}/avatars`);
          const data = await response.json();

          if (response.ok) {
            populateAvatarDropdown(data.avatars);
          } else {
            showNotification(`Failed to load avatars: ${data.error}`, 'error');
          }
        } catch (error) {
          showNotification(`Error loading avatars: ${error.message}`, 'error');
        }
      }

      function populateAvatarDropdown(avatars) {
        const avatarSelect = document.getElementById('avatar-select');
        avatarSelect.innerHTML = '<option value="">Select Avatar...</option>';

        avatars.forEach(avatar => {
          const option = document.createElement('option');
          option.value = avatar.id;
          option.textContent = avatar.name;
          avatarSelect.appendChild(option);
        });
      }

      function onAvatarEngineChange() {
        const engineSelect = document.getElementById('avatar-engine-select');
        const selectedEngine = engineSelect.value;

        // Update UI to show selected engine
        const engineStatus = document.createElement('div');
        engineStatus.className = 'engine-status';
        engineStatus.innerHTML = `
                <small style="color: #666; font-style: italic;">
                    ${selectedEngine ? `Using: ${engineSelect.options[engineSelect.selectedIndex].text}` : 'Auto-failsafe enabled'}
                </small>
            `;

        // Remove existing status if any
        const existingStatus = engineSelect.parentNode.querySelector('.engine-status');
        if (existingStatus) {
          existingStatus.remove();
        }

        // Add new status
        engineSelect.parentNode.appendChild(engineStatus);

        // Store selection for later use in avatar generation
        window.selectedAvatarEngine = selectedEngine;

        showNotification(
          selectedEngine
            ? `Avatar engine set to: ${engineSelect.options[engineSelect.selectedIndex].text}`
            : 'Auto-failsafe mode enabled - will use best available engine',
          'info'
        );
      }

      function onWorkflowAvatarEngineChange() {
        const engineSelect = document.getElementById('workflow-avatar-engine');
        const selectedEngine = engineSelect.value;

        // Update UI to show selected engine
        const engineStatus = document.createElement('div');
        engineStatus.className = 'engine-status';
        engineStatus.innerHTML = `
                <small style="color: #666; font-style: italic;">
                    ${selectedEngine ? `Using: ${engineSelect.options[engineSelect.selectedIndex].text}` : 'Auto-failsafe enabled'}
                </small>
            `;

        // Remove existing status if any
        const existingStatus = engineSelect.parentNode.querySelector('.engine-status');
        if (existingStatus) {
          existingStatus.remove();
        }

        // Add new status
        engineSelect.parentNode.appendChild(engineStatus);

        // Store selection for later use in workflow operations
        window.selectedWorkflowAvatarEngine = selectedEngine;

        showNotification(
          selectedEngine
            ? `Workflow avatar engine set to: ${engineSelect.options[engineSelect.selectedIndex].text}`
            : 'Auto-failsafe mode enabled for workflows - will use best available engine',
          'info'
        );
      }

      async function onAvatarChange() {
        const avatarId = document.getElementById('avatar-select').value;
        if (!avatarId) return;

        try {
          const response = await fetch(`/api/sandbox/avatars/${avatarId}/voices`);
          const data = await response.json();

          if (response.ok) {
            populateVoiceDropdown(data.voices);
          } else {
            showNotification(`Failed to load voices: ${data.error}`, 'error');
          }
        } catch (error) {
          showNotification(`Error loading voices: ${error.message}`, 'error');
        }
      }

      function populateVoiceDropdown(voices) {
        const voiceSelect = document.getElementById('voice-select');
        voiceSelect.innerHTML = '<option value="">Select Voice...</option>';

        voices.forEach(voice => {
          const option = document.createElement('option');
          option.value = voice.id;
          option.textContent = voice.name;
          voiceSelect.appendChild(option);
        });
      }

      async function generateSampleScript() {
        // Create a modal dialog instead of using prompt()
        const topic = await showInputDialog('Enter a topic for script generation:', 'Script Topic');
        if (!topic) return;

        try {
          showNotification('Generating sample script...', 'info');
          const response = await fetch('/api/sandbox/generate-script', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ topic: topic }),
          });

          const data = await response.json();

          if (response.ok) {
            document.getElementById('script-input').value = data.script;
            showNotification('Sample script generated!', 'success');
          } else {
            showNotification(`Failed to generate script: ${data.error}`, 'error');
          }
        } catch (error) {
          showNotification(`Error generating script: ${error.message}`, 'error');
        }
      }

      async function generateVoicePreview() {
        const script = document.getElementById('script-input').value;
        const voiceId = document.getElementById('voice-select').value;

        if (!script || !voiceId) {
          showNotification('Please enter script text and select a voice', 'error');
          return;
        }

        try {
          showNotification('Generating voice preview...', 'info');
          const response = await fetch('/api/sandbox/generate-voice', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              script: script,
              voice_id: voiceId,
            }),
          });

          const data = await response.json();

          if (response.ok) {
            const previewWindow = document.getElementById('preview-window');
            previewWindow.innerHTML = `
                        <audio controls style="width: 100%;">
                            <source src="${data.audio_url}" type="audio/mpeg">
                            Your browser does not support the audio element.
                        </audio>
                    `;
            showNotification('Voice preview generated!', 'success');
          } else {
            showNotification(`Failed to generate voice: ${data.error}`, 'error');
          }
        } catch (error) {
          showNotification(`Error generating voice: ${error.message}`, 'error');
        }
      }

      async function generateAvatarPreview() {
        const script = document.getElementById('script-input').value;
        const avatarId = document.getElementById('avatar-select').value;
        const voiceId = document.getElementById('voice-select').value;

        if (!script || !avatarId || !voiceId) {
          showNotification('Please complete script, avatar, and voice selection', 'error');
          return;
        }

        try {
          showNotification('Generating avatar preview...', 'info');
          const response = await fetch('/api/sandbox/generate-avatar', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              script: script,
              avatar_id: avatarId,
              voice_id: voiceId,
            }),
          });

          const data = await response.json();

          if (response.ok) {
            const previewWindow = document.getElementById('preview-window');
            previewWindow.innerHTML = `
                        <video controls style="width: 100%; height: 100%;">
                            <source src="${data.video_url}" type="video/mp4">
                            Your browser does not support the video element.
                        </video>
                    `;
            showNotification('Avatar preview generated!', 'success');
          } else {
            showNotification(`Failed to generate avatar: ${data.error}`, 'error');
          }
        } catch (error) {
          showNotification(`Error generating avatar: ${error.message}`, 'error');
        }
      }

      async function generateFullScenePreview() {
        const script = document.getElementById('script-input').value;
        const avatarId = document.getElementById('avatar-select').value;
        const voiceId = document.getElementById('voice-select').value;
        const wardrobe = document.getElementById('wardrobe-prompt').value;

        if (!script || !avatarId || !voiceId) {
          showNotification('Please complete script, avatar, and voice selection', 'error');
          return;
        }

        try {
          showNotification('Generating full scene preview...', 'info');
          const response = await fetch('/api/sandbox/generate-scene', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              script: script,
              avatar_id: avatarId,
              voice_id: voiceId,
              wardrobe: wardrobe,
            }),
          });

          const data = await response.json();

          if (response.ok) {
            const previewWindow = document.getElementById('preview-window');
            previewWindow.innerHTML = `
                        <video controls style="width: 100%; height: 100%;">
                            <source src="${data.video_url}" type="video/mp4">
                            Your browser does not support the video element.
                        </video>
                    `;
            showNotification('Full scene preview generated!', 'success');
          } else {
            showNotification(`Failed to generate scene: ${data.error}`, 'error');
          }
        } catch (error) {
          showNotification(`Error generating scene: ${error.message}`, 'error');
        }
      }

      async function sendToProduction() {
        const script = document.getElementById('script-input').value;
        const channelId = document.getElementById('channel-select').value;
        const avatarId = document.getElementById('avatar-select').value;
        const voiceId = document.getElementById('voice-select').value;
        const wardrobe = document.getElementById('wardrobe-prompt').value;

        if (!script || !channelId || !avatarId || !voiceId) {
          showNotification('Please complete all required fields', 'error');
          return;
        }

        try {
          showNotification('Sending to production queue...', 'info');
          const response = await fetch('/api/sandbox/send-to-production', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              script: script,
              channel_id: channelId,
              avatar_id: avatarId,
              voice_id: voiceId,
              wardrobe: wardrobe,
            }),
          });

          const data = await response.json();

          if (response.ok) {
            showNotification('Successfully added to production queue!', 'success');
            loadProductionQueue();
          } else {
            showNotification(`Failed to send to production: ${data.error}`, 'error');
          }
        } catch (error) {
          showNotification(`Error sending to production: ${error.message}`, 'error');
        }
      }

      async function loadProductionQueue() {
        try {
          const response = await fetch('/api/sandbox/production-queue');
          const data = await response.json();

          if (response.ok) {
            displayProductionQueue(data.queue);
          } else {
            showNotification(`Failed to load production queue: ${data.error}`, 'error');
          }
        } catch (error) {
          showNotification(`Error loading production queue: ${error.message}`, 'error');
        }
      }

      function displayProductionQueue(queue) {
        const queueContainer = document.getElementById('production-queue-list');

        if (!queue || queue.length === 0) {
          queueContainer.innerHTML = '<p style="text-align: center; color: #718096;">No items in production queue</p>';
          return;
        }

        queueContainer.innerHTML = queue
          .map(
            item => `
                <div class="queue-item">
                    <div class="queue-info">
                        <div class="queue-title">${item.title || 'Untitled Project'}</div>
                        <div class="queue-details">
                            Channel: ${item.channel_name} | Avatar: ${item.avatar_name} | Voice: ${item.voice_name}
                        </div>
                    </div>
                    <div class="queue-status status-${item.status}">${item.status}</div>
                </div>
            `
          )
          .join('');
      }

      // Code Backup & Export functions
      async function loadSystemFiles() {
        try {
          const response = await fetch('/api/backup/files');
          const data = await response.json();

          if (response.ok) {
            populateFileSelector(data.files);
          } else {
            showNotification(`Failed to load system files: ${data.error}`, 'error');
          }
        } catch (error) {
          showNotification(`Error loading system files: ${error.message}`, 'error');
        }
      }

      function populateFileSelector(files) {
        const fileSelector = document.getElementById('file-selector');
        fileSelector.innerHTML = '<option value="">Select a file...</option>';

        // Group files by category
        const categories = {};
        files.forEach(file => {
          if (!categories[file.category]) {
            categories[file.category] = [];
          }
          categories[file.category].push(file);
        });

        // Add options grouped by category
        Object.keys(categories).forEach(category => {
          const optgroup = document.createElement('optgroup');
          optgroup.label = category;

          categories[category].forEach(file => {
            const option = document.createElement('option');
            option.value = file.path;
            option.textContent = file.name;
            optgroup.appendChild(option);
          });

          fileSelector.appendChild(optgroup);
        });
      }

      async function loadFileContent() {
        const fileSelector = document.getElementById('file-selector');
        const filePath = fileSelector.value;

        if (!filePath) {
          document.getElementById('code-content').value = '';
          document.getElementById('file-info').textContent = 'No file selected';
          return;
        }

        try {
          const response = await fetch(`/api/backup/file-content?path=${encodeURIComponent(filePath)}`);
          const data = await response.json();

          if (response.ok) {
            document.getElementById('code-content').value = data.content;
            document.getElementById('file-info').textContent = `${data.lines} lines, ${data.size} bytes`;
          } else {
            showNotification(`Failed to load file content: ${data.error}`, 'error');
          }
        } catch (error) {
          showNotification(`Error loading file content: ${error.message}`, 'error');
        }
      }

      async function copyFileToClipboard() {
        const content = document.getElementById('code-content').value;
        if (!content) {
          showNotification('No file content to copy', 'error');
          return;
        }

        try {
          await navigator.clipboard.writeText(content);
          showNotification('File content copied to clipboard', 'success');
        } catch (error) {
          showNotification('Failed to copy to clipboard', 'error');
        }
      }

      // Enhanced Codebase Viewer Functions
      let projectStructure = null;
      let expandedFolders = new Set();
      let selectedFile = null;

      async function loadProjectStructure() {
        try {
          const response = await fetch('/api/backup/project-structure');
          const data = await response.json();

          if (response.ok) {
            projectStructure = data;
            renderFileTree();

            // Update stats display
            if (data.statistics) {
              updateProjectStats(data.statistics);
            }
          } else {
            showNotification(`Failed to load project structure: ${data.error}`, 'error');
          }
        } catch (error) {
          showNotification(`Error loading project structure: ${error.message}`, 'error');
        }
      }

      function buildFileTree(files) {
        const tree = {};

        files.forEach(file => {
          const parts = file.path.split('/');
          let current = tree;

          for (let i = 0; i < parts.length; i++) {
            const part = parts[i];
            if (!current[part]) {
              current[part] = {
                type: i === parts.length - 1 ? 'file' : 'folder',
                path: parts.slice(0, i + 1).join('/'),
                children: {},
                fileInfo: i === parts.length - 1 ? file : null,
              };
            }
            current = current[part].children;
          }
        });

        return tree;
      }

      function renderFileTree() {
        const treeContainer = document.getElementById('file-tree');
        if (!projectStructure) {
          treeContainer.innerHTML = '<div class="loading">No project structure loaded</div>';
          return;
        }

        treeContainer.innerHTML = renderTreeNode(projectStructure, 0);
      }

      function renderTreeNode(node, depth) {
        let html = '';

        Object.keys(node)
          .sort((a, b) => {
            // Folders first, then files
            if (node[a].type !== node[b].type) {
              return node[a].type === 'folder' ? -1 : 1;
            }
            return a.localeCompare(b);
          })
          .forEach(key => {
            const item = node[key];
            const indent = '  '.repeat(depth);
            const isExpanded = expandedFolders.has(item.path);
            const isSelected = selectedFile === item.path;

            if (item.type === 'folder') {
              const icon = isExpanded ? 'ðŸ“‚' : 'ðŸ“';
              html += `
                        <div class="file-tree-item folder ${isSelected ? 'selected' : ''}" 
                             onclick="toggleFolder('${item.path}')" 
                             style="padding-left: ${depth * 20}px">
                            <span class="icon">${icon}</span>
                            ${key}
                        </div>
                    `;

              if (isExpanded && Object.keys(item.children).length > 0) {
                html += renderTreeNode(item.children, depth + 1);
              }
            } else {
              const icon = getFileIcon(key);
              html += `
                        <div class="file-tree-item file ${isSelected ? 'selected' : ''}" 
                             onclick="selectFile('${item.path}', '${key}')" 
                             style="padding-left: ${depth * 20}px">
                            <span class="icon">${icon}</span>
                            ${key}
                        </div>
                    `;
            }
          });

        return html;
      }

      function getFileIcon(filename) {
        const ext = filename.split('.').pop().toLowerCase();
        const iconMap = {
          py: 'ðŸ',
          js: 'ðŸ“œ',
          html: 'ðŸŒ',
          css: 'ðŸŽ¨',
          json: 'ðŸ“‹',
          md: 'ðŸ“',
          txt: 'ðŸ“„',
          yml: 'âš™ï¸',
          yaml: 'âš™ï¸',
          xml: 'ðŸ“°',
          sql: 'ðŸ—ƒï¸',
        };
        return iconMap[ext] || 'ðŸ“„';
      }

      function toggleFolder(path) {
        if (expandedFolders.has(path)) {
          expandedFolders.delete(path);
        } else {
          expandedFolders.add(path);
        }
        renderFileTree();
      }

      async function selectFile(path, filename) {
        selectedFile = path;
        document.getElementById('current-file-name').textContent = filename;

        try {
          const response = await fetch(`/api/backup/file/${encodeURIComponent(path)}`);
          const data = await response.json();

          if (response.ok) {
            document.getElementById('code-content').textContent = data.content;
            document.getElementById('file-info').textContent =
              `${data.lines || 0} lines, ${formatFileSize(data.size || 0)}`;
          } else {
            showNotification(`Failed to load file content: ${data.error}`, 'error');
          }
        } catch (error) {
          showNotification(`Error loading file content: ${error.message}`, 'error');
        }

        renderFileTree(); // Re-render to update selection
      }

      function toggleExpandAll() {
        const button = document.getElementById('expand-toggle');
        if (expandedFolders.size === 0) {
          // Expand all folders
          expandAllFolders(projectStructure, '');
          button.textContent = 'ðŸ“ Collapse All';
        } else {
          // Collapse all folders
          expandedFolders.clear();
          button.textContent = 'ðŸ“‚ Expand All';
        }
        renderFileTree();
      }

      function expandAllFolders(node, basePath) {
        Object.keys(node).forEach(key => {
          const item = node[key];
          if (item.type === 'folder') {
            const fullPath = basePath ? `${basePath}/${key}` : key;
            expandedFolders.add(item.path);
            expandAllFolders(item.children, fullPath);
          }
        });
      }

      function updateProjectStats(statistics) {
        const statsContainer = document.querySelector('.viewer-controls .stats');
        if (statsContainer && statistics) {
          statsContainer.innerHTML = `
                    <span>ðŸ“ ${statistics.total_directories || 0} directories</span>
                    <span>ðŸ“„ ${statistics.total_files || 0} files</span>
                    <span>ðŸ’¾ ${formatFileSize(statistics.total_size || 0)}</span>
                `;
        }
      }

      function formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
      }

      function filterFiles() {
        const searchTerm = document.getElementById('file-search').value.toLowerCase();
        const fileTypeFilter = document.getElementById('file-type-filter').value;

        // Store original structure if not already stored
        if (!window.originalProjectStructure) {
          window.originalProjectStructure = JSON.parse(JSON.stringify(projectStructure));
        }

        // Apply filters
        const filteredStructure = applyFilters(window.originalProjectStructure, searchTerm, fileTypeFilter);

        // Update the displayed structure
        projectStructure = filteredStructure;
        renderFileTree();
      }

      function applyFilters(node, searchTerm, fileTypeFilter) {
        const filtered = {};

        Object.keys(node).forEach(key => {
          const item = node[key];

          if (item.type === 'folder') {
            // Recursively filter folder contents
            const filteredChildren = applyFilters(item.children, searchTerm, fileTypeFilter);

            // Include folder if it has matching children or matches search term
            if (Object.keys(filteredChildren).length > 0 || key.toLowerCase().includes(searchTerm)) {
              filtered[key] = {
                ...item,
                children: filteredChildren,
              };
            }
          } else {
            // Filter files based on search term and file type
            const matchesSearch =
              key.toLowerCase().includes(searchTerm) || item.path.toLowerCase().includes(searchTerm);
            const matchesType = !fileTypeFilter || key.endsWith(fileTypeFilter);

            if (matchesSearch && matchesType) {
              filtered[key] = item;
            }
          }
        });

        return filtered;
      }

      function clearFilters() {
        document.getElementById('file-search').value = '';
        document.getElementById('file-type-filter').value = '';

        if (window.originalProjectStructure) {
          projectStructure = JSON.parse(JSON.stringify(window.originalProjectStructure));
          renderFileTree();
        }
      }

      async function copyCurrentFile() {
        const content = document.getElementById('code-content').textContent;
        if (!content || content === 'Select a file from the project structure to view its content...') {
          showNotification('No file content to copy', 'error');
          return;
        }

        try {
          await navigator.clipboard.writeText(content);
          showNotification('File content copied to clipboard', 'success');
        } catch (error) {
          showNotification('Failed to copy to clipboard', 'error');
        }
      }

      async function copyProjectStructure() {
        if (!projectStructure) {
          showNotification('No project structure loaded', 'error');
          return;
        }

        const structureText = generateStructureText(projectStructure, 0);

        try {
          await navigator.clipboard.writeText(structureText);
          showNotification('Project structure copied to clipboard', 'success');
        } catch (error) {
          showNotification('Failed to copy project structure', 'error');
        }
      }

      function generateStructureText(node, depth) {
        let text = '';
        const indent = '  '.repeat(depth);

        Object.keys(node)
          .sort((a, b) => {
            if (node[a].type !== node[b].type) {
              return node[a].type === 'folder' ? -1 : 1;
            }
            return a.localeCompare(b);
          })
          .forEach(key => {
            const item = node[key];
            const icon = item.type === 'folder' ? 'ðŸ“' : getFileIcon(key);
            text += `${indent}${icon} ${key}\n`;

            if (item.type === 'folder' && Object.keys(item.children).length > 0) {
              text += generateStructureText(item.children, depth + 1);
            }
          });

        return text;
      }

      async function copyAllCodeToClipboard() {
        try {
          const response = await fetch('/api/backup/all-code');
          const data = await response.json();

          if (response.ok) {
            await navigator.clipboard.writeText(data.content);
            showNotification(`All code copied to clipboard (${data.files} files, ${data.lines} lines)`, 'success');
          } else {
            showNotification(`Failed to get all code: ${data.error}`, 'error');
          }
        } catch (error) {
          showNotification('Failed to copy code to clipboard', 'error');
        }
      }

      async function downloadCodebaseZip() {
        try {
          showNotification('Generating codebase ZIP...', 'info');

          const response = await fetch('/api/backup/code');

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.style.display = 'none';
          a.href = url;

          // Generate filename with timestamp
          const now = new Date();
          const timestamp = now.toISOString().slice(0, 19).replace(/[T:]/g, '-');
          a.download = `codebase-backup-${timestamp}.zip`;

          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);

          showNotification('Codebase ZIP downloaded successfully!', 'success');
        } catch (error) {
          console.error('Error downloading codebase ZIP:', error);
          showNotification('Failed to download codebase ZIP: ' + error.message, 'error');
        }
      }

      async function generateCodeBackup() {
        const button = document.querySelector('button[onclick="generateCodeBackup()"]');
        const statusDiv = document.getElementById('code-backup-status');

        button.disabled = true;
        statusDiv.innerHTML = '<div class="backup-status loading">Generating code backup...</div>';

        try {
          const response = await fetch('/api/backup/generate-code', {
            method: 'POST',
          });
          const data = await response.json();

          if (response.ok) {
            statusDiv.innerHTML = `<div class="backup-status success">Code backup generated successfully!</div>`;
            addDownloadLink(data.filename, data.size, '/api/backup/download/' + data.filename);
          } else {
            statusDiv.innerHTML = `<div class="backup-status error">Failed to generate backup: ${data.error}</div>`;
          }
        } catch (error) {
          statusDiv.innerHTML = `<div class="backup-status error">Error: ${error.message}</div>`;
        } finally {
          button.disabled = false;
        }
      }

      async function generateDataBackup() {
        const button = document.querySelector('button[onclick="generateDataBackup()"]');
        const statusDiv = document.getElementById('data-backup-status');

        button.disabled = true;
        statusDiv.innerHTML = '<div class="backup-status loading">Generating data backup...</div>';

        try {
          const response = await fetch('/api/backup/generate-data', {
            method: 'POST',
          });
          const data = await response.json();

          if (response.ok) {
            statusDiv.innerHTML = `<div class="backup-status success">Data backup generated successfully!</div>`;
            addDownloadLink(data.filename, data.size, '/api/backup/download/' + data.filename);
          } else {
            statusDiv.innerHTML = `<div class="backup-status error">Failed to generate backup: ${data.error}</div>`;
          }
        } catch (error) {
          statusDiv.innerHTML = `<div class="backup-status error">Error: ${error.message}</div>`;
        } finally {
          button.disabled = false;
        }
      }

      function addDownloadLink(filename, size, downloadUrl) {
        const historyDiv = document.getElementById('download-links');
        const linkDiv = document.createElement('div');
        linkDiv.className = 'download-link';
        linkDiv.innerHTML = `
                <div class="download-info">
                    <div class="filename">${filename}</div>
                    <div class="filesize">${formatFileSize(size)}</div>
                </div>
                <button class="download-btn" onclick="window.open('${downloadUrl}', '_blank')">Download</button>
            `;

        // Clear the "No backups generated yet..." message if it exists
        if (historyDiv.textContent.includes('No backups generated yet')) {
          historyDiv.innerHTML = '';
        }

        // Add to the top of the history
        const firstChild = historyDiv.querySelector('.download-link');
        if (firstChild) {
          historyDiv.insertBefore(linkDiv, firstChild);
        } else {
          historyDiv.appendChild(linkDiv);
        }
      }

      function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
      }

      // Actions functionality
      async function loadActions() {
        try {
          const response = await fetch('/api/actions');
          const data = await response.json();

          if (response.ok) {
            displayActions(data);
          } else {
            console.error('Failed to load actions:', data.error);
            document.getElementById('actions-grid').innerHTML =
              '<p style="text-align: center; color: #f56565;">Failed to load actions</p>';
          }
        } catch (error) {
          console.error('Error loading actions:', error);
          document.getElementById('actions-grid').innerHTML =
            '<p style="text-align: center; color: #f56565;">Error loading actions</p>';
        }
      }

      function displayActions(manifest) {
        const actionsGrid = document.getElementById('actions-grid');

        if (!manifest.agents || Object.keys(manifest.agents).length === 0) {
          actionsGrid.innerHTML = '<p style="text-align: center; color: #718096;">No actions available</p>';
          return;
        }

        let html = '';

        Object.entries(manifest.agents).forEach(([agentName, agent]) => {
          if (agent.actions && Object.keys(agent.actions).length > 0) {
            Object.entries(agent.actions).forEach(([actionName, action]) => {
              html += `
                            <div class="action-card" onclick="executeAction('${agentName}', '${actionName}')">
                                <div class="action-header">
                                    <h4>${action.name || actionName}</h4>
                                    <span class="action-category">${action.category || 'General'}</span>
                                </div>
                                <div class="action-description">
                                    ${action.description || 'No description available'}
                                </div>
                                <div class="action-meta">
                                    <span class="action-agent">Agent: ${agentName}</span>
                                    <span class="action-auth ${
                                      action.requires_auth ? 'auth-required' : 'auth-not-required'
                                    }">
                                        ${action.requires_auth ? 'ðŸ”’ Auth Required' : 'ðŸ”“ No Auth'}
                                    </span>
                                </div>
                            </div>
                        `;
            });
          }
        });

        if (html === '') {
          actionsGrid.innerHTML = '<p style="text-align: center; color: #718096;">No actions available</p>';
        } else {
          actionsGrid.innerHTML = html;
        }
      }

      async function executeAction(agent, action) {
        try {
          showNotification(`Executing ${action} on ${agent}...`, 'info');

          const response = await fetch(`/api/action/${agent}/${action}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({}),
          });

          const data = await response.json();

          if (response.ok) {
            showNotification(`Action completed successfully!`, 'success');
            console.log('Action result:', data);
          } else {
            showNotification(`Action failed: ${data.error}`, 'error');
          }
        } catch (error) {
          showNotification(`Error executing action: ${error.message}`, 'error');
          console.error('Action execution error:', error);
        }
      }

      // Initialize dashboard
      document.addEventListener('DOMContentLoaded', function () {
        // Set default active module
        switchModule('agent-center');

        // Load available actions
        loadActions();

        // Start auto-refresh
        refreshDashboard();
        startAutoRefresh();
      });

      // Handle page visibility changes
      document.addEventListener('visibilitychange', function () {
        if (document.hidden) {
          stopAutoRefresh();
        } else {
          startAutoRefresh();
        }
      });

      // Report Center Functions
      let currentReports = [];
      let currentSortField = 'created_at';
      let currentSortDirection = 'desc';
      let currentViewingReport = null;

      async function generateReport() {
        const reportType = document.getElementById('report-type-select').value;
        const startDate = document.getElementById('date-range-start').value;
        const endDate = document.getElementById('date-range-end').value;

        if (!startDate || !endDate) {
          showNotification('Please select both start and end dates', 'error');
          return;
        }

        if (new Date(startDate) > new Date(endDate)) {
          showNotification('Start date must be before end date', 'error');
          return;
        }

        const statusDiv = document.getElementById('generation-status');
        statusDiv.style.display = 'block';

        try {
          const response = await fetch('/api/report-center/generate', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              report_type: reportType,
              date_range_start: startDate,
              date_range_end: endDate,
            }),
          });

          const data = await response.json();

          if (response.ok) {
            showNotification('Report generated successfully!', 'success');
            statusDiv.style.display = 'none';
            loadReports(); // Refresh the reports list
          } else {
            showNotification(`Failed to generate report: ${data.error}`, 'error');
            statusDiv.style.display = 'none';
          }
        } catch (error) {
          showNotification(`Error generating report: ${error.message}`, 'error');
          statusDiv.style.display = 'none';
        }
      }

      async function loadReports() {
        try {
          const response = await fetch('/api/report-center/reports');
          const data = await response.json();

          if (response.ok) {
            currentReports = data.reports;
            displayReports(currentReports);
          } else {
            showNotification(`Failed to load reports: ${data.error}`, 'error');
          }
        } catch (error) {
          showNotification(`Error loading reports: ${error.message}`, 'error');
        }
      }

      function displayReports(reports) {
        const tbody = document.getElementById('reports-table-body');

        if (reports.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="5" style="text-align: center; color: #718096;">No reports found</td></tr>';
          return;
        }

        tbody.innerHTML = reports
          .map(report => {
            const createdDate = new Date(report.created_at).toLocaleDateString();
            const dateRange = `${new Date(report.date_range_start).toLocaleDateString()} - ${new Date(report.date_range_end).toLocaleDateString()}`;
            const badgeClass = getBadgeClass(report.report_type);

            return `
                    <tr>
                        <td>${createdDate}</td>
                        <td><span class="report-type-badge ${badgeClass}">${formatReportType(report.report_type)}</span></td>
                        <td>${dateRange}</td>
                        <td>${report.key_headline || 'No headline available'}</td>
                        <td class="report-actions">
                            <button class="btn btn-sm btn-info" onclick="viewReport(${report.id})">ðŸ‘ï¸ View</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteReport(${report.id})">ðŸ—‘ï¸ Delete</button>
                        </td>
                    </tr>
                `;
          })
          .join('');
      }

      function getBadgeClass(reportType) {
        const badgeMap = {
          'daily-performance': 'badge-daily',
          'weekly-growth': 'badge-weekly',
          'quarterly-strategic': 'badge-quarterly',
          'affiliate-performance': 'badge-affiliate',
          'content-analysis': 'badge-content',
          'audience-insights': 'badge-audience',
        };
        return badgeMap[reportType] || 'badge-daily';
      }

      function formatReportType(reportType) {
        return reportType
          .split('-')
          .map(word => word.charAt(0).toUpperCase() + word.slice(1))
          .join(' ');
      }

      async function viewReport(reportId) {
        try {
          const response = await fetch(`/api/report-center/reports/${reportId}`);
          const data = await response.json();

          if (response.ok) {
            currentViewingReport = data.report;
            displayReportViewer(data.report);
          } else {
            showNotification(`Failed to load report: ${data.error}`, 'error');
          }
        } catch (error) {
          showNotification(`Error loading report: ${error.message}`, 'error');
        }
      }

      function displayReportViewer(report) {
        const archivePanel = document.querySelector('.report-archive-table').closest('.panel');
        const viewerPanel = document.getElementById('report-viewer-panel');
        const contentDiv = document.getElementById('report-content');

        // Hide archive, show viewer
        archivePanel.style.display = 'none';
        viewerPanel.style.display = 'block';

        // Convert markdown to HTML (basic conversion)
        const htmlContent = markdownToHtml(report.content);
        contentDiv.innerHTML = htmlContent;
      }

      function markdownToHtml(markdown) {
        // Basic markdown to HTML conversion
        let html = markdown
          .replace(/^# (.*$)/gim, '<h1>$1</h1>')
          .replace(/^## (.*$)/gim, '<h2>$1</h2>')
          .replace(/^### (.*$)/gim, '<h3>$1</h3>')
          .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
          .replace(/\*(.*?)\*/g, '<em>$1</em>')
          .replace(/^- (.*$)/gim, '<li>$1</li>')
          .replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>')
          .replace(/\n/g, '<br>');

        return html;
      }

      function closeReportViewer() {
        const archivePanel = document.querySelector('.report-archive-table').closest('.panel');
        const viewerPanel = document.getElementById('report-viewer-panel');

        // Show archive, hide viewer
        archivePanel.style.display = 'block';
        viewerPanel.style.display = 'none';
        currentViewingReport = null;
      }

      async function deleteReport(reportId) {
        if (!confirm('Are you sure you want to delete this report?')) {
          return;
        }

        try {
          const response = await fetch(`/api/report-center/reports/${reportId}`, {
            method: 'DELETE',
          });

          const data = await response.json();

          if (response.ok) {
            showNotification('Report deleted successfully', 'success');
            loadReports(); // Refresh the reports list
          } else {
            showNotification(`Failed to delete report: ${data.error}`, 'error');
          }
        } catch (error) {
          showNotification(`Error deleting report: ${error.message}`, 'error');
        }
      }

      function filterReports() {
        const searchTerm = document.getElementById('report-search').value.toLowerCase();
        const typeFilter = document.getElementById('report-type-filter').value;

        let filteredReports = currentReports.filter(report => {
          const matchesSearch =
            !searchTerm ||
            report.title.toLowerCase().includes(searchTerm) ||
            report.key_headline.toLowerCase().includes(searchTerm) ||
            report.report_type.toLowerCase().includes(searchTerm);

          const matchesType = !typeFilter || report.report_type === typeFilter;

          return matchesSearch && matchesType;
        });

        displayReports(filteredReports);
      }

      function sortReports(field) {
        if (currentSortField === field) {
          currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
        } else {
          currentSortField = field;
          currentSortDirection = 'desc';
        }

        const sortedReports = [...currentReports].sort((a, b) => {
          let aVal = a[field];
          let bVal = b[field];

          if (field.includes('date')) {
            aVal = new Date(aVal);
            bVal = new Date(bVal);
          }

          if (currentSortDirection === 'asc') {
            return aVal > bVal ? 1 : -1;
          } else {
            return aVal < bVal ? 1 : -1;
          }
        });

        displayReports(sortedReports);
      }

      function downloadCurrentReport() {
        if (!currentViewingReport) {
          showNotification('No report currently being viewed', 'error');
          return;
        }

        const blob = new Blob([currentViewingReport.content], { type: 'text/markdown' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${currentViewingReport.title.replace(/[^a-z0-9]/gi, '_')}.md`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      // Load reports when Report Center module is activated
      const originalSwitchModule = switchModule;
      switchModule = function (moduleId) {
        originalSwitchModule(moduleId);
        if (moduleId === 'report-center') {
          loadReports();
          // Set default date range (last 30 days)
          const endDate = new Date();
          const startDate = new Date();
          startDate.setDate(startDate.getDate() - 30);

          document.getElementById('date-range-start').value = startDate.toISOString().split('T')[0];
          document.getElementById('date-range-end').value = endDate.toISOString().split('T')[0];
        } else if (moduleId === 'configuration') {
          loadConfiguration();
        }
      };

      // Configuration Management Functions
      async function loadConfiguration() {
        const loadingDiv = document.getElementById('config-loading');
        const formDiv = document.getElementById('config-form');
        const statusDiv = document.getElementById('config-status');

        try {
          loadingDiv.style.display = 'block';
          formDiv.style.display = 'none';
          statusDiv.innerHTML = '';

          const response = await fetch('/api/config');
          const config = await response.json();

          if (response.ok) {
            // Populate form with current configuration
            Object.keys(config).forEach(key => {
              const checkbox = document.getElementById(key);
              if (checkbox) {
                checkbox.checked = config[key];
              }
            });

            loadingDiv.style.display = 'none';
            formDiv.style.display = 'block';
          } else {
            throw new Error(config.error || 'Failed to load configuration');
          }
        } catch (error) {
          console.error('Error loading configuration:', error);
          loadingDiv.innerHTML = `<p style="color: #e53e3e;">Error loading configuration: ${error.message}</p>`;
        }
      }

      async function saveConfiguration() {
        const form = document.getElementById('configuration-form');
        const statusDiv = document.getElementById('config-status');
        const saveButton = document.querySelector('button[onclick="saveConfiguration()"]');

        try {
          saveButton.disabled = true;
          statusDiv.innerHTML = '<div class="config-status loading">Saving configuration...</div>';

          // Collect form data
          const formData = new FormData(form);
          const config = {};

          // Get all checkboxes and set their values
          const checkboxes = form.querySelectorAll('input[type="checkbox"]');
          checkboxes.forEach(checkbox => {
            config[checkbox.name] = checkbox.checked;
          });

          const response = await fetch('/api/config/update', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(config),
          });

          const result = await response.json();

          if (response.ok) {
            statusDiv.innerHTML = '<div class="config-status success">Configuration saved successfully!</div>';
            setTimeout(() => {
              statusDiv.innerHTML = '';
            }, 3000);
          } else {
            throw new Error(result.error || 'Failed to save configuration');
          }
        } catch (error) {
          console.error('Error saving configuration:', error);
          statusDiv.innerHTML = `<div class="config-status error">Error saving configuration: ${error.message}</div>`;
        } finally {
          saveButton.disabled = false;
        }
      }

      async function resetConfiguration() {
        const statusDiv = document.getElementById('config-status');
        const resetButton = document.querySelector('button[onclick="resetConfiguration()"]');

        if (!confirm('Are you sure you want to reset all configuration settings to their default values?')) {
          return;
        }

        try {
          resetButton.disabled = true;
          statusDiv.innerHTML = '<div class="config-status loading">Resetting configuration...</div>';

          // Reset all checkboxes to unchecked (default state)
          const checkboxes = document.querySelectorAll('#configuration-form input[type="checkbox"]');
          checkboxes.forEach(checkbox => {
            checkbox.checked = false;
          });

          // Save the reset configuration
          await saveConfiguration();

          statusDiv.innerHTML = '<div class="config-status success">Configuration reset to defaults!</div>';
          setTimeout(() => {
            statusDiv.innerHTML = '';
          }, 3000);
        } catch (error) {
          console.error('Error resetting configuration:', error);
          statusDiv.innerHTML = `<div class="config-status error">Error resetting configuration: ${error.message}</div>`;
        } finally {
          resetButton.disabled = false;
        }
      }

      // Continue to Next Phase Function
      function continueToNextPhase() {
        // Show confirmation dialog
        const confirmed = confirm(
          'Ready to advance to Phase 2? This will unlock advanced automation features and growth strategies.'
        );

        if (confirmed) {
          // Show loading state
          const button = document.querySelector('.btn-continue');
          const originalText = button.textContent;
          button.textContent = 'Initializing Phase 2...';
          button.disabled = true;

          // Simulate phase transition (in real implementation, this would call backend API)
          setTimeout(() => {
            alert('ðŸŽ‰ Phase 2 Activated! Advanced features are now available in your dashboard.');
            button.textContent = 'Phase 2 Active âœ“';
            button.style.background = '#38a169';
            button.style.color = 'white';

            // Optionally redirect to advanced dashboard or reload with new features
            // window.location.reload();
          }, 2000);
        }
      }

      // SocketIO Real-time Integration
      let socket = null;

      function initializeSocketIO() {
        // Replace existing socket connection with this:
        const socket = io(window.location.origin, {
          path: '/socket.io',
          transports: ['websocket', 'polling'],
          reconnection: true,
          reconnectionAttempts: 5,
          reconnectionDelay: 1000,
          timeout: 20000,
          forceNew: true,
        });

        window.socket = socket;

        socket.on('connect', () => {
          console.log('âœ… Socket.IO connected:', socket.id);
          updateConnectionStatus(true);

          // Join the dashboard room for real-time updates
          socket.emit('join_room', { room: 'dashboard' });
        });

        socket.on('disconnect', function () {
          console.log('âŒ Socket.IO disconnected');
          updateConnectionStatus(false);
        });

        socket.on('error', err => console.error('[socket] error', err));

        // Real-time data handlers
        socket.on('agent_status_update', function (data) {
          updateConnectionStatus(true); // Defensive: mark connection as live on data receipt
          updateAgentStatus(data);
        });

        socket.on('system_stats_update', function (data) {
          updateConnectionStatus(true); // Defensive: mark connection as live on data receipt
          updateSystemStats(data);
        });

        socket.on('project_status_update', function (data) {
          updateConnectionStatus(true); // Defensive: mark connection as live on data receipt
          updateProjectStatus(data);
        });

        // Error handling
        socket.on('connect_error', function (error) {
          console.error('SocketIO connection error:', error);
          updateConnectionStatus(false);
        });
      }

      function updateConnectionStatus(connected) {
        const statusIndicator = document.getElementById('connection-status');
        if (statusIndicator) {
          statusIndicator.textContent = connected ? 'ðŸŸ¢ Live' : 'ðŸ”´ Offline';
          statusIndicator.style.color = connected ? '#38a169' : '#e53e3e';
        }
      }

      function updateAgentStatus(data) {
        // Update agent status displays in real-time
        const agentElements = document.querySelectorAll('[data-agent-id]');
        agentElements.forEach(element => {
          const agentId = element.getAttribute('data-agent-id');
          if (data.agents && data.agents[agentId]) {
            const agent = data.agents[agentId];
            const statusElement = element.querySelector('.agent-status');
            if (statusElement) {
              statusElement.textContent = agent.status;
              statusElement.className = `agent-status ${agent.status.toLowerCase()}`;
            }
          }
        });
      }

      function updateSystemStats(data) {
        // Update system statistics in real-time
        if (data.memory_usage) {
          const memoryElement = document.getElementById('memory-usage');
          if (memoryElement) {
            memoryElement.textContent = `${data.memory_usage.toFixed(1)}%`;
          }
        }

        if (data.uptime) {
          const uptimeElement = document.getElementById('uptime');
          if (uptimeElement) {
            uptimeElement.textContent = data.uptime;
          }
        }

        if (data.database_health !== undefined) {
          const dbElement = document.getElementById('database-health');
          if (dbElement) {
            dbElement.textContent = data.database_health ? 'ðŸŸ¢ Healthy' : 'ðŸ”´ Issues';
          }
        }
      }

      function updateProjectStatus(data) {
        // Update project status displays in real-time
        const projectElements = document.querySelectorAll('[data-project-id]');
        projectElements.forEach(element => {
          const projectId = element.getAttribute('data-project-id');
          if (data.projects && data.projects[projectId]) {
            const project = data.projects[projectId];
            const statusElement = element.querySelector('.project-status');
            if (statusElement) {
              statusElement.textContent = project.status;
              statusElement.className = `project-status ${project.status.toLowerCase()}`;
            }
          }
        });
      }

      function requestAgentStatus() {
        if (socket && socket.connected) {
          socket.emit('request_agent_status');
        }
      }

      function requestSystemStats() {
        if (socket && socket.connected) {
          socket.emit('request_system_stats');
        }
      }

      // Command Center API Functions
      async function refreshAPIStatus() {
        try {
          const response = await fetch('/api/services');
          const data = await response.json();

          // Update API KPIs
          const apis = data.apis || [];
          const healthyApis = apis.filter(api => api.last_health_status === 'healthy').length;

          document.getElementById('total-apis').textContent = apis.length;
          document.getElementById('healthy-apis').textContent = healthyApis;

          // Update API registry table
          displayAPIRegistry(apis);
          showNotification('API status refreshed successfully', 'success');
        } catch (error) {
          console.error('Error refreshing API status:', error);
          showNotification('Failed to refresh API status', 'error');
        }
      }

      async function runHealthCheck() {
        try {
          // Trigger health check via system agent
          const response = await fetch('/api/agents/system/health-check', {
            method: 'POST',
          });
          const data = await response.json();
          showNotification('Health check initiated', 'success');

          // Refresh status after a short delay
          setTimeout(() => {
            refreshAPIStatus();
          }, 2000);
        } catch (error) {
          console.error('Error running health check:', error);
          showNotification('Failed to run health check', 'error');
        }
      }

      async function findNewOpportunities() {
        try {
          const response = await fetch('/api/discovery/trigger', {
            method: 'POST',
          });
          const data = await response.json();
          showNotification('Opportunity discovery initiated', 'success');

          // Refresh opportunities after a delay
          setTimeout(() => {
            loadAPIOpportunities();
            loadAffiliateOpportunities();
          }, 3000);
        } catch (error) {
          console.error('Error triggering opportunity discovery:', error);
          showNotification('Failed to trigger opportunity discovery', 'error');
        }
      }

      async function addNewService() {
        const name = prompt('Enter service name:');
        const type = prompt('Enter service type (api/affiliate):');
        const capability = prompt('Enter capability/category:');
        const signupUrl = prompt('Enter signup URL:');

        if (!name || !type || !capability) {
          showNotification('All fields are required', 'error');
          return;
        }

        try {
          const response = await fetch('/api/services/add', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              name,
              type,
              capability,
              signup_url: signupUrl,
            }),
          });

          const data = await response.json();
          if (data.success) {
            showNotification('Service added successfully', 'success');
            refreshAPIStatus();
          } else {
            showNotification(data.error || 'Failed to add service', 'error');
          }
        } catch (error) {
          console.error('Error adding service:', error);
          showNotification('Failed to add service', 'error');
        }
      }

      async function updateServiceSecret(serviceId, serviceName) {
        const newSecret = prompt(`Enter new API key/secret for ${serviceName}:`);
        if (!newSecret) return;

        try {
          const response = await fetch('/api/services/update_secret', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              service_id: serviceId,
              secret: newSecret,
            }),
          });

          const data = await response.json();
          if (data.success) {
            showNotification('Service secret updated successfully', 'success');
            refreshAPIStatus();
          } else {
            showNotification(data.error || 'Failed to update secret', 'error');
          }
        } catch (error) {
          console.error('Error updating service secret:', error);
          showNotification('Failed to update service secret', 'error');
        }
      }

      async function toggleServiceActive(serviceId, currentStatus) {
        try {
          const response = await fetch('/api/services/toggle_active', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              service_id: serviceId,
            }),
          });

          const data = await response.json();
          if (data.success) {
            showNotification(`Service ${currentStatus ? 'deactivated' : 'activated'} successfully`, 'success');
            refreshAPIStatus();
          } else {
            showNotification(data.error || 'Failed to toggle service status', 'error');
          }
        } catch (error) {
          console.error('Error toggling service status:', error);
          showNotification('Failed to toggle service status', 'error');
        }
      }

      // Initialize SocketIO when page loads
      document.addEventListener('DOMContentLoaded', function () {
        // Add connection status indicator to header if it doesn't exist
        const header = document.querySelector('.header');
        if (header && !document.getElementById('connection-status')) {
          const statusDiv = document.createElement('div');
          statusDiv.innerHTML = '<span id="connection-status">ðŸ”´ Connecting...</span>';
          statusDiv.style.position = 'absolute';
          statusDiv.style.top = '20px';
          statusDiv.style.right = '20px';
          statusDiv.style.fontSize = '14px';
          statusDiv.style.fontWeight = 'bold';
          header.style.position = 'relative';
          header.appendChild(statusDiv);
        }

        // Initialize SocketIO connection
        initializeSocketIO();

        // Request initial data
        setTimeout(() => {
          requestAgentStatus();
          requestSystemStats();
        }, 1000);
      });

      // Smoke Test Functions
      let smokeTestRunning = false;
      let smokeTestSocket = null;

      async function runSmokeTest() {
        if (smokeTestRunning) {
          showNotification('Smoke test is already running', 'warning');
          return;
        }

        smokeTestRunning = true;
        updateSmokeTestUI('running', 'Running system-wide smoke test...');

        // Clear previous results
        const resultsDiv = document.getElementById('test-results');
        resultsDiv.innerHTML = '';

        // Hide summary
        document.getElementById('test-summary').style.display = 'none';

        try {
          // Start the smoke test
          const response = await fetch('/api/smoke-test/run', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              test_type: 'full',
            }),
          });

          const result = await response.json();

          if (response.ok) {
            // Connect to WebSocket for real-time updates
            connectSmokeTestSocket(result.test_id);
            showNotification('Smoke test started successfully', 'success');
          } else {
            throw new Error(result.error || 'Failed to start smoke test');
          }
        } catch (error) {
          updateSmokeTestUI('error', 'Failed to start smoke test');
          addLogEntry('ERROR', error.message);
          smokeTestRunning = false;
          showNotification(`Error: ${error.message}`, 'error');
        }
      }

      function connectSmokeTestSocket(testId) {
        if (smokeTestSocket) {
          smokeTestSocket.disconnect();
        }

        // Use fallback connector for smoke test socket
        const PATH = '/socket.io';
        const candidates = [window.location.origin, 'http://localhost:5000', 'http://127.0.0.1:5000'];
        let ix = 0;

        function tryConnectSmokeTest() {
          if (ix >= candidates.length) {
            console.error('[smoke-test socket] all origins failed');
            return;
          }
          const base = candidates[ix++];
          console.log('[smoke-test socket] trying', base);
          smokeTestSocket = io(base + '/smoke-test', {
            path: PATH,
            transports: ['websocket', 'polling'],
            reconnection: true,
            reconnectionAttempts: 10,
            timeout: 8000,
          });

          smokeTestSocket.once('connect', () => {
            console.log('[smoke-test socket] connected', base, smokeTestSocket.id);
            smokeTestSocket.emit('join_test', { test_id: testId });
          });

          smokeTestSocket.once('connect_error', err => {
            console.warn('[smoke-test socket] connect_error on', base, err?.message || err);
            try {
              smokeTestSocket.close();
            } catch {}
            tryConnectSmokeTest();
          });

          smokeTestSocket.on('error', err => console.error('[smoke-test socket] error', err));
        }

        tryConnectSmokeTest();

        smokeTestSocket.on('test_log', data => {
          addLogEntry(data.level, data.message, data.timestamp);
        });

        smokeTestSocket.on('test_progress', data => {
          updateSmokeTestUI('running', `${data.current_step}: ${data.message}`);
        });

        smokeTestSocket.on('test_completed', data => {
          smokeTestRunning = false;
          if (data.success) {
            updateSmokeTestUI('success', 'âœ… ALL TESTS PASSED. The TRAE.AI system is 100% live and fully operational.');
            showTestSummary(true, data.summary);
          } else {
            updateSmokeTestUI('error', 'âŒ Smoke test failed. System is not ready for production.');
            showTestSummary(false, data.summary);
          }
          smokeTestSocket.disconnect();
          smokeTestSocket = null;
        });

        smokeTestSocket.on('test_error', data => {
          smokeTestRunning = false;
          updateSmokeTestUI('error', 'Smoke test encountered an error');
          addLogEntry('ERROR', data.message);
          smokeTestSocket.disconnect();
          smokeTestSocket = null;
        });
      }

      async function stopSmokeTest() {
        if (!smokeTestRunning) {
          return;
        }

        try {
          const response = await fetch('/api/smoke-test/stop', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
          });

          if (response.ok) {
            smokeTestRunning = false;
            updateSmokeTestUI('ready', 'Smoke test stopped by user');
            addLogEntry('INFO', 'Test stopped by user request');

            if (smokeTestSocket) {
              smokeTestSocket.disconnect();
              smokeTestSocket = null;
            }

            showNotification('Smoke test stopped', 'info');
          } else {
            throw new Error('Failed to stop smoke test');
          }
        } catch (error) {
          showNotification(`Error stopping test: ${error.message}`, 'error');
        }
      }

      function updateSmokeTestUI(status, message) {
        const statusDot = document.getElementById('status-dot');
        const statusText = document.getElementById('status-text');
        const runBtn = document.getElementById('run-smoke-test-btn');
        const stopBtn = document.getElementById('stop-smoke-test-btn');

        // Remove all status classes
        statusDot.className = 'status-dot';

        // Add appropriate status class
        statusDot.classList.add(status);
        statusText.textContent = message;

        // Update button states
        if (status === 'running') {
          runBtn.disabled = true;
          runBtn.style.display = 'none';
          stopBtn.style.display = 'inline-block';
        } else {
          runBtn.disabled = false;
          runBtn.style.display = 'inline-block';
          stopBtn.style.display = 'none';
        }
      }

      function addLogEntry(level, message, timestamp = null) {
        const resultsDiv = document.getElementById('test-results');

        // Remove placeholder if it exists
        const placeholder = resultsDiv.querySelector('.log-placeholder');
        if (placeholder) {
          placeholder.remove();
        }

        const logEntry = document.createElement('div');
        logEntry.className = 'log-entry';

        const time = timestamp || new Date().toLocaleTimeString();

        logEntry.innerHTML = `
                <span class="log-timestamp">${time}</span>
                <span class="log-level log-${level.toLowerCase()}">${level}</span>
                <span class="log-message">${message}</span>
            `;

        resultsDiv.appendChild(logEntry);
        resultsDiv.scrollTop = resultsDiv.scrollHeight;
      }

      function showTestSummary(success, summary) {
        const summaryDiv = document.getElementById('test-summary');
        const summaryContent = document.getElementById('summary-content');

        summaryDiv.className = 'test-summary ' + (success ? 'success' : 'error');

        let summaryHtml = '';
        if (success) {
          summaryHtml = `
                    <div class="success-message">âœ… ALL TESTS PASSED</div>
                    <p>The TRAE.AI system is 100% live and fully operational.</p>
                `;
        } else {
          summaryHtml = `
                    <div class="error-message">âŒ TESTS FAILED</div>
                    <p>The system is not ready for production. Please review the test results above.</p>
                `;
        }

        if (summary && summary.details) {
          summaryHtml += `<div style="margin-top: 15px;"><strong>Details:</strong><br>${summary.details}</div>`;
        }

        summaryContent.innerHTML = summaryHtml;
        summaryDiv.style.display = 'block';
      }

      // Runtime Review Functions
      async function runRuntimeReviewArchive() {
        const reviewBtn = document.getElementById('runtime-review-archive-btn');
        reviewBtn.disabled = true;
        reviewBtn.innerHTML = 'â³ Running Review + Archive...';

        // Clear previous results
        let reviewResults = document.getElementById('runtime-review-results');
        if (!reviewResults) {
          reviewResults = document.createElement('div');
          reviewResults.id = 'runtime-review-results';
          reviewResults.className = 'runtime-review-results';
          reviewResults.style.cssText =
            'margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #007bff;';
          document.querySelector('.smoke-test-section').appendChild(reviewResults);
        }

        reviewResults.innerHTML =
          '<h3>ðŸ” Runtime Review + Archive in Progress...</h3><div class="review-progress">Running comprehensive audit and creating evidence bundle...</div>';

        try {
          // Run the runtime review with archive
          const response = await fetch('/api/audit/runtime-review', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              timestamp: new Date().toISOString(),
              triggered_by: 'dashboard',
            }),
          });

          const result = await response.json();

          if (result.success) {
            displayRuntimeReviewResults(result.audit_results);

            // Show evidence list
            await displayEvidenceList();

            showNotification('Runtime Review + Archive completed successfully!', 'success');
          } else {
            reviewResults.innerHTML = `<h3>âŒ Runtime Review Failed</h3><p style="color: #dc3545;">Error: ${result.error}</p>`;
            showNotification('Runtime Review failed: ' + result.error, 'error');
          }
        } catch (error) {
          reviewResults.innerHTML = `<h3>âŒ Runtime Review Failed</h3><p style="color: #dc3545;">Error: ${error.message}</p>`;
          showNotification('Runtime Review error: ' + error.message, 'error');
        } finally {
          reviewBtn.disabled = false;
          reviewBtn.innerHTML = 'ðŸ“‹ Run Runtime Review + Archive';
        }
      }

      function displayRuntimeReviewResults(results) {
        const reviewResults = document.getElementById('runtime-review-results');

        let html = '<h3>ðŸ“‹ Runtime Review Results</h3>';

        // Rule-1 Scanner Results
        html += `<div class="audit-section">
                <h4>ðŸ” Rule-1 Content Scanner</h4>
                <div class="audit-result ${results.rule1_scan.violations > 0 ? 'warning' : 'success'}">
                    <strong>Status:</strong> ${results.rule1_scan.violations > 0 ? 'âš ï¸ Violations Found' : 'âœ… Clean'}<br>
                    <strong>Files Scanned:</strong> ${results.rule1_scan.files_scanned}<br>
                    <strong>Violations:</strong> ${results.rule1_scan.violations}
                </div>
            </div>`;

        // No-Delete Protection
        html += `<div class="audit-section">
                <h4>ðŸ›¡ï¸ No-Delete Protection</h4>
                <div class="audit-result ${results.deletion_protection.protected ? 'success' : 'error'}">
                    <strong>Status:</strong> ${results.deletion_protection.protected ? 'âœ… Protected' : 'âŒ Vulnerable'}<br>
                    <strong>Critical Files:</strong> ${results.deletion_protection.critical_files_count}<br>
                    <strong>Protection Level:</strong> ${results.deletion_protection.protection_level}
                </div>
            </div>`;

        // Async Architecture
        html += `<div class="audit-section">
                <h4>âš¡ Async Architecture</h4>
                <div class="audit-result ${results.async_architecture.compliant ? 'success' : 'warning'}">
                    <strong>Status:</strong> ${results.async_architecture.compliant ? 'âœ… Compliant' : 'âš ï¸ Issues Found'}<br>
                    <strong>Event Loop:</strong> ${results.async_architecture.event_loop_status}<br>
                    <strong>Async Components:</strong> ${results.async_architecture.async_components}
                </div>
            </div>`;

        // Database Integrity
        html += `<div class="audit-section">
                <h4>ðŸ—„ï¸ Database Integrity</h4>
                <div class="audit-result ${results.database_integrity.healthy ? 'success' : 'error'}">
                    <strong>Status:</strong> ${results.database_integrity.healthy ? 'âœ… Healthy' : 'âŒ Issues Found'}<br>
                    <strong>Tables:</strong> ${results.database_integrity.table_count}<br>
                    <strong>Schema Version:</strong> ${results.database_integrity.schema_version}
                </div>
            </div>`;

        reviewResults.innerHTML = html;
      }

      async function displayEvidenceList() {
        try {
          const response = await fetch('/api/audit/evidence-list');
          const evidenceData = await response.json();

          if (evidenceData.success && evidenceData.evidence_files.length > 0) {
            const reviewResults = document.getElementById('runtime-review-results');

            let evidenceHtml =
              '<div class="evidence-section" style="margin-top: 20px; padding: 15px; background: #e8f5e8; border-radius: 8px;">';
            evidenceHtml += '<h4>ðŸ“¦ Evidence Bundle</h4>';
            evidenceHtml += '<p>The following evidence files have been generated and archived:</p>';
            evidenceHtml += '<ul style="margin: 10px 0;">';

            evidenceData.evidence_files.forEach(file => {
              evidenceHtml += `<li style="margin: 5px 0;">
                            <strong>${file.filename}</strong> (${file.size})
                            <button class="btn btn-sm btn-outline-primary" onclick="downloadEvidence('${file.filename}')" style="margin-left: 10px; padding: 2px 8px; font-size: 0.8rem;">
                                ðŸ“¥ Download
                            </button>
                        </li>`;
            });

            evidenceHtml += '</ul>';
            evidenceHtml += `<p><strong>Total Evidence Files:</strong> ${evidenceData.evidence_files.length}</p>`;
            evidenceHtml += '</div>';

            reviewResults.innerHTML += evidenceHtml;
          }
        } catch (error) {
          console.error('Failed to load evidence list:', error);
        }
      }

      function downloadEvidence(filename) {
        window.open(`/api/audit/evidence-download/${encodeURIComponent(filename)}`, '_blank');
      }

      function addDownloadButton(bundlePath) {
        const reviewResults = document.getElementById('runtime-review-results');
        const downloadSection = document.createElement('div');
        downloadSection.className = 'download-section';
        downloadSection.style.cssText =
          'margin-top: 20px; padding: 15px; background: #e8f5e8; border-radius: 8px; text-align: center;';
        downloadSection.innerHTML = `
                <h4>ðŸ“¦ Evidence Bundle Ready</h4>
                <p>Complete audit report and evidence package generated.</p>
                <button class="btn btn-success" onclick="downloadBundle('${bundlePath}')" style="margin-top: 10px;">
                    ðŸ“¥ Download Evidence Bundle
                </button>
            `;
        reviewResults.appendChild(downloadSection);
      }

      function downloadBundle(bundlePath) {
        window.open(`/api/audit/download-bundle?path=${encodeURIComponent(bundlePath)}`, '_blank');
      }

      // SSE Auto-Reconnect for Verdict Stream
      class VerdictStreamManager {
        constructor() {
          this.eventSource = null;
          this.reconnectAttempts = 0;
          this.maxReconnectAttempts = 10;
          this.baseDelay = 1000; // 1 second
          this.maxDelay = 30000; // 30 seconds
          this.isConnected = false;
          this.shouldReconnect = true;
        }

        connect() {
          if (this.eventSource) {
            this.eventSource.close();
          }

          try {
            console.log('Creating EventSource connection to /api/audit/verdict/stream');
            this.eventSource = new EventSource('/api/audit/verdict/stream');

            this.eventSource.onopen = () => {
              console.log('Verdict stream connected successfully');
              this.isConnected = true;
              this.reconnectAttempts = 0;
              this.updateConnectionBadge('connected');
            };

            this.eventSource.onmessage = event => {
              try {
                const data = JSON.parse(event.data);
                console.log('Received verdict data:', data);
                this.updateVerdictBadge(data);
              } catch (e) {
                console.error('Error parsing verdict data:', e);
              }
            };

            this.eventSource.onerror = error => {
              console.error('Verdict stream error:', error);
              console.log('EventSource readyState:', this.eventSource.readyState);
              this.isConnected = false;
              this.updateConnectionBadge('disconnected');
              this.scheduleReconnect();
            };
          } catch (error) {
            console.error('Failed to create EventSource:', error);
            this.scheduleReconnect();
          }
        }

        scheduleReconnect() {
          if (!this.shouldReconnect || this.reconnectAttempts >= this.maxReconnectAttempts) {
            console.log('Max reconnect attempts reached or reconnect disabled');
            return;
          }

          this.reconnectAttempts++;
          const delay = Math.min(this.baseDelay * Math.pow(2, this.reconnectAttempts - 1), this.maxDelay);

          console.log(`Reconnecting in ${delay}ms (attempt ${this.reconnectAttempts})`);
          setTimeout(() => this.connect(), delay);
        }

        updateVerdictBadge(data) {
          // Update live badge with verdict data
          const liveBadge = document.querySelector('.live-badge, #live-status');
          if (liveBadge) {
            liveBadge.textContent = `ðŸŸ¢ LIVE - ${data.verdict.toUpperCase()}`;
            liveBadge.className = `live-badge ${data.system_health === 'green' ? 'status-good' : 'status-warning'}`;
          }

          // Update system metrics if elements exist
          const uptimeElement = document.getElementById('system-uptime');
          if (uptimeElement && data.uptime) {
            const hours = Math.floor(data.uptime / 3600);
            const minutes = Math.floor((data.uptime % 3600) / 60);
            uptimeElement.textContent = `${hours}h ${minutes}m`;
          }

          const activeTasksElement = document.getElementById('active-tasks');
          if (activeTasksElement) {
            activeTasksElement.textContent = data.active_tasks || 0;
          }
        }

        updateConnectionBadge(status) {
          const connectionBadge = document.querySelector('.connection-status');
          if (connectionBadge) {
            connectionBadge.textContent = status === 'connected' ? 'ðŸŸ¢ Connected' : 'ðŸ”´ Reconnecting...';
            connectionBadge.className = `connection-status ${status}`;
          }
        }

        disconnect() {
          this.shouldReconnect = false;
          if (this.eventSource) {
            this.eventSource.close();
            this.eventSource = null;
          }
          this.isConnected = false;
        }
      }

      // Input dialog function to replace prompt()
      function showInputDialog(message, title = 'Input') {
        return new Promise(resolve => {
          // Create modal overlay
          const overlay = document.createElement('div');
          overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                `;

          // Create dialog
          const dialog = document.createElement('div');
          dialog.style.cssText = `
                    background: #1a1a1a;
                    border: 1px solid #333;
                    border-radius: 8px;
                    padding: 20px;
                    min-width: 300px;
                    color: #fff;
                `;

          dialog.innerHTML = `
                    <h3 style="margin: 0 0 15px 0; color: #fff;">${title}</h3>
                    <p style="margin: 0 0 15px 0; color: #ccc;">${message}</p>
                    <input type="text" id="dialog-input" style="
                        width: 100%;
                        padding: 8px;
                        border: 1px solid #555;
                        border-radius: 4px;
                        background: #2a2a2a;
                        color: #fff;
                        margin-bottom: 15px;
                    " />
                    <div style="text-align: right;">
                        <button id="dialog-cancel" style="
                            background: #555;
                            color: #fff;
                            border: none;
                            padding: 8px 16px;
                            border-radius: 4px;
                            margin-right: 10px;
                            cursor: pointer;
                        ">Cancel</button>
                        <button id="dialog-ok" style="
                            background: #007acc;
                            color: #fff;
                            border: none;
                            padding: 8px 16px;
                            border-radius: 4px;
                            cursor: pointer;
                        ">OK</button>
                    </div>
                `;

          overlay.appendChild(dialog);
          document.body.appendChild(overlay);

          const input = dialog.querySelector('#dialog-input');
          const okBtn = dialog.querySelector('#dialog-ok');
          const cancelBtn = dialog.querySelector('#dialog-cancel');

          input.focus();

          const cleanup = () => {
            document.body.removeChild(overlay);
          };

          okBtn.onclick = () => {
            const value = input.value.trim();
            cleanup();
            resolve(value || null);
          };

          cancelBtn.onclick = () => {
            cleanup();
            resolve(null);
          };

          input.onkeydown = e => {
            if (e.key === 'Enter') {
              okBtn.click();
            } else if (e.key === 'Escape') {
              cancelBtn.click();
            }
          };

          // Close on overlay click
          overlay.onclick = e => {
            if (e.target === overlay) {
              cancelBtn.click();
            }
          };
        });
      }

      // Initialize verdict stream manager
      let verdictStream = null;

      // Mini Locator Functions
      function openFullLocator() {
        window.open('/api/places/locator', '_blank');
      }

      function refreshLocator() {
        const iframe = document.querySelector('.mini-locator-container iframe');
        if (iframe) {
          iframe.src = iframe.src;
        }
      }

      // Initialize smoke test UI on page load
      document.addEventListener('DOMContentLoaded', function () {
        if (document.getElementById('status-dot')) {
          updateSmokeTestUI('ready', 'Ready to run smoke test');
        }

        // Start verdict stream
        verdictStream = new VerdictStreamManager();
        verdictStream.connect();
      });

      // Handle page visibility changes to manage connections
      document.addEventListener('visibilitychange', function () {
        if (verdictStream) {
          if (document.hidden) {
            // Page is hidden, optionally pause reconnection
            console.log('Page hidden, verdict stream continues');
          } else {
            // Page is visible, ensure connection
            if (!verdictStream.isConnected) {
              verdictStream.connect();
            }
          }
        }
      });

      // Cleanup on page unload
      window.addEventListener('beforeunload', function () {
        if (verdictStream) {
          verdictStream.disconnect();
        }
      });
    </script>
  </body>
</html>
