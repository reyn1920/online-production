<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Management - TRAE.AI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .card-hover {
            transition: transform 0.2s;
        }
        .card-hover:hover {
            transform: translateY(-5px);
        }
        .status-badge {
            font-size: 0.8rem;
        }
        .metric-card {
            border-left: 4px solid #28a745;
        }
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
        }
        .progress-container {
            margin: 10px 0;
        }
        .job-item {
            border-left: 3px solid #007bff;
            margin-bottom: 10px;
        }
        .nav-pills .nav-link.active {
            background-color: #667eea;
        }
        .form-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <div class="row gradient-bg py-4 mb-4">
            <div class="col">
                <h1><i class="fas fa-chart-line me-2"></i>Financial Management</h1>
                <p class="mb-0">Autonomous financial analysis, resource allocation, and ROI optimization</p>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <ul class="nav nav-pills mb-4" id="financialTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="dashboard-tab" data-bs-toggle="pill" data-bs-target="#dashboard" type="button" role="tab">
                    <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="analysis-tab" data-bs-toggle="pill" data-bs-target="#analysis" type="button" role="tab">
                    <i class="fas fa-analytics me-2"></i>Profitability Analysis
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="allocation-tab" data-bs-toggle="pill" data-bs-target="#allocation" type="button" role="tab">
                    <i class="fas fa-balance-scale me-2"></i>Resource Allocation
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="optimization-tab" data-bs-toggle="pill" data-bs-target="#optimization" type="button" role="tab">
                    <i class="fas fa-rocket me-2"></i>ROI Optimization
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="reports-tab" data-bs-toggle="pill" data-bs-target="#reports" type="button" role="tab">
                    <i class="fas fa-file-alt me-2"></i>Reports
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="jobs-tab" data-bs-toggle="pill" data-bs-target="#jobs" type="button" role="tab">
                    <i class="fas fa-tasks me-2"></i>Jobs
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="financialTabContent">
            <!-- Dashboard Tab -->
            <div class="tab-pane fade show active" id="dashboard" role="tabpanel">
                <div class="row">
                    <!-- Financial Metrics -->
                    <div class="col-md-3 mb-4">
                        <div class="card metric-card card-hover">
                            <div class="card-body">
                                <h6 class="card-title text-muted">Total Revenue</h6>
                                <div class="metric-value text-success" id="totalRevenue">$0</div>
                                <small class="text-muted">This month</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-4">
                        <div class="card metric-card card-hover">
                            <div class="card-body">
                                <h6 class="card-title text-muted">Total Costs</h6>
                                <div class="metric-value text-danger" id="totalCosts">$0</div>
                                <small class="text-muted">This month</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-4">
                        <div class="card metric-card card-hover">
                            <div class="card-body">
                                <h6 class="card-title text-muted">Net Profit</h6>
                                <div class="metric-value text-primary" id="netProfit">$0</div>
                                <small class="text-muted">This month</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-4">
                        <div class="card metric-card card-hover">
                            <div class="card-body">
                                <h6 class="card-title text-muted">ROI</h6>
                                <div class="metric-value text-info" id="roi">0%</div>
                                <small class="text-muted">Return on Investment</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Service Status -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-heartbeat me-2"></i>Service Status</h5>
                            </div>
                            <div class="card-body">
                                <div id="serviceStatus">
                                    <div class="d-flex align-items-center">
                                        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                        <span>Checking service status...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profitability Analysis Tab -->
            <div class="tab-pane fade" id="analysis" role="tabpanel">
                <div class="form-section">
                    <h4><i class="fas fa-chart-bar me-2"></i>Channel Profitability Analysis</h4>
                    <form id="analysisForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="channelId" class="form-label">Channel ID</label>
                                    <input type="text" class="form-control" id="channelId" required>
                                </div>
                                <div class="mb-3">
                                    <label for="revenue" class="form-label">Revenue ($)</label>
                                    <input type="number" class="form-control" id="revenue" step="0.01" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="costs" class="form-label">Costs ($)</label>
                                    <input type="number" class="form-control" id="costs" step="0.01" required>
                                </div>
                                <div class="mb-3">
                                    <label for="timePeriod" class="form-label">Time Period</label>
                                    <select class="form-select" id="timePeriod">
                                        <option value="monthly">Monthly</option>
                                        <option value="weekly">Weekly</option>
                                        <option value="daily">Daily</option>
                                        <option value="quarterly">Quarterly</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="includeForecast">
                                <label class="form-check-label" for="includeForecast">
                                    Include forecast analysis
                                </label>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-play me-2"></i>Start Analysis
                        </button>
                    </form>
                </div>

                <div id="analysisResults" class="mt-4" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-chart-pie me-2"></i>Analysis Results</h5>
                        </div>
                        <div class="card-body" id="analysisResultsContent">
                            <!-- Results will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Resource Allocation Tab -->
            <div class="tab-pane fade" id="allocation" role="tabpanel">
                <div class="form-section">
                    <h4><i class="fas fa-balance-scale me-2"></i>Resource Allocation Optimization</h4>
                    <form id="allocationForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="totalBudget" class="form-label">Total Budget ($)</label>
                                    <input type="number" class="form-control" id="totalBudget" step="0.01" required>
                                </div>
                                <div class="mb-3">
                                    <label for="channels" class="form-label">Channels (comma-separated)</label>
                                    <input type="text" class="form-control" id="channels" placeholder="youtube,tiktok,instagram" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="strategy" class="form-label">Allocation Strategy</label>
                                    <select class="form-select" id="strategy">
                                        <option value="profit_maximization">Profit Maximization</option>
                                        <option value="risk_balanced">Risk Balanced</option>
                                        <option value="growth_focused">Growth Focused</option>
                                        <option value="conservative">Conservative</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="riskTolerance" class="form-label">Risk Tolerance</label>
                                    <input type="range" class="form-range" id="riskTolerance" min="0" max="1" step="0.1" value="0.3">
                                    <div class="d-flex justify-content-between">
                                        <small>Conservative</small>
                                        <small id="riskValue">30%</small>
                                        <small>Aggressive</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-cogs me-2"></i>Optimize Allocation
                        </button>
                    </form>
                </div>

                <div id="allocationResults" class="mt-4" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-pie-chart me-2"></i>Allocation Results</h5>
                        </div>
                        <div class="card-body" id="allocationResultsContent">
                            <!-- Results will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- ROI Optimization Tab -->
            <div class="tab-pane fade" id="optimization" role="tabpanel">
                <div class="form-section">
                    <h4><i class="fas fa-rocket me-2"></i>ROI Optimization</h4>
                    <form id="optimizationForm">
                        <div class="mb-3">
                            <label for="currentAllocations" class="form-label">Current Allocations (JSON)</label>
                            <textarea class="form-control" id="currentAllocations" rows="4" placeholder='{"youtube": 5000, "tiktok": 3000, "instagram": 2000}' required></textarea>
                            <div class="form-text">Enter current resource allocations as JSON</div>
                        </div>
                        <div class="mb-3">
                            <label for="performanceData" class="form-label">Performance Data (JSON)</label>
                            <textarea class="form-control" id="performanceData" rows="4" placeholder='{"youtube": {"roi": 15.5, "engagement": 0.8}, "tiktok": {"roi": 12.3, "engagement": 0.9}}' required></textarea>
                            <div class="form-text">Enter performance metrics as JSON</div>
                        </div>
                        <div class="mb-3">
                            <label for="optimizationTarget" class="form-label">Optimization Target</label>
                            <select class="form-select" id="optimizationTarget">
                                <option value="roi">ROI</option>
                                <option value="revenue">Revenue</option>
                                <option value="profit">Profit</option>
                                <option value="engagement">Engagement</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-warning">
                            <i class="fas fa-magic me-2"></i>Optimize ROI
                        </button>
                    </form>
                </div>

                <div id="optimizationResults" class="mt-4" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-chart-line me-2"></i>Optimization Results</h5>
                        </div>
                        <div class="card-body" id="optimizationResultsContent">
                            <!-- Results will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports Tab -->
            <div class="tab-pane fade" id="reports" role="tabpanel">
                <div class="form-section">
                    <h4><i class="fas fa-file-alt me-2"></i>Financial Report Generation</h4>
                    <form id="reportForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="startDate" class="form-label">Start Date</label>
                                    <input type="date" class="form-control" id="startDate" required>
                                </div>
                                <div class="mb-3">
                                    <label for="endDate" class="form-label">End Date</label>
                                    <input type="date" class="form-control" id="endDate" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="reportChannels" class="form-label">Channels (optional)</label>
                                    <input type="text" class="form-control" id="reportChannels" placeholder="youtube,tiktok,instagram">
                                    <div class="form-text">Leave empty for all channels</div>
                                </div>
                                <div class="mb-3">
                                    <label for="reportType" class="form-label">Report Type</label>
                                    <select class="form-select" id="reportType">
                                        <option value="comprehensive">Comprehensive</option>
                                        <option value="summary">Summary</option>
                                        <option value="detailed">Detailed</option>
                                        <option value="executive">Executive</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-info">
                            <i class="fas fa-file-download me-2"></i>Generate Report
                        </button>
                    </form>
                </div>

                <div id="reportResults" class="mt-4" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-chart-area me-2"></i>Financial Report</h5>
                        </div>
                        <div class="card-body" id="reportResultsContent">
                            <!-- Results will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Jobs Tab -->
            <div class="tab-pane fade" id="jobs" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4><i class="fas fa-tasks me-2"></i>Financial Jobs</h4>
                    <button class="btn btn-outline-primary" onclick="refreshJobs()">
                        <i class="fas fa-sync-alt me-2"></i>Refresh
                    </button>
                </div>
                <div id="jobsList">
                    <div class="text-center py-4">
                        <div class="spinner-border" role="status"></div>
                        <p class="mt-2">Loading jobs...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Global variables
        let activeJobs = new Set();
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboard();
            loadJobs();
            
            // Set default dates
            const today = new Date();
            const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
            document.getElementById('startDate').value = lastMonth.toISOString().split('T')[0];
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
            
            // Risk tolerance slider
            const riskSlider = document.getElementById('riskTolerance');
            const riskValue = document.getElementById('riskValue');
            riskSlider.addEventListener('input', function() {
                riskValue.textContent = Math.round(this.value * 100) + '%';
            });
        });
        
        // Load dashboard data
        async function loadDashboard() {
            try {
                // Load service status
                const healthResponse = await fetch('/api/financial/health');
                const healthData = await healthResponse.json();
                
                const statusDiv = document.getElementById('serviceStatus');
                if (healthData.status === 'healthy') {
                    statusDiv.innerHTML = `
                        <div class="d-flex align-items-center text-success">
                            <i class="fas fa-check-circle me-2"></i>
                            <span>Financial Agent is running and healthy</span>
                        </div>
                    `;
                } else {
                    statusDiv.innerHTML = `
                        <div class="d-flex align-items-center text-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <span>Financial Agent is not available</span>
                        </div>
                    `;
                }
                
                // Load financial metrics
                const metricsResponse = await fetch('/api/financial/metrics');
                const metricsData = await metricsResponse.json();
                
                document.getElementById('totalRevenue').textContent = '$' + metricsData.total_revenue.toLocaleString();
                document.getElementById('totalCosts').textContent = '$' + metricsData.total_costs.toLocaleString();
                document.getElementById('netProfit').textContent = '$' + metricsData.net_profit.toLocaleString();
                document.getElementById('roi').textContent = metricsData.roi.toFixed(1) + '%';
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
                document.getElementById('serviceStatus').innerHTML = `
                    <div class="d-flex align-items-center text-danger">
                        <i class="fas fa-times-circle me-2"></i>
                        <span>Error loading service status</span>
                    </div>
                `;
            }
        }
        
        // Form handlers
        document.getElementById('analysisForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                channel_id: document.getElementById('channelId').value,
                revenue: parseFloat(document.getElementById('revenue').value),
                costs: parseFloat(document.getElementById('costs').value),
                time_period: document.getElementById('timePeriod').value,
                include_forecast: document.getElementById('includeForecast').checked
            };
            
            try {
                const response = await fetch('/api/financial/analyze', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                if (result.success) {
                    activeJobs.add(result.job_id);
                    showAlert('Analysis started successfully!', 'success');
                    monitorJob(result.job_id, 'analysisResults', 'analysisResultsContent');
                } else {
                    showAlert('Failed to start analysis: ' + result.message, 'danger');
                }
            } catch (error) {
                showAlert('Error starting analysis: ' + error.message, 'danger');
            }
        });
        
        document.getElementById('allocationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const channels = document.getElementById('channels').value.split(',').map(c => c.trim());
            const formData = {
                total_budget: parseFloat(document.getElementById('totalBudget').value),
                channels: channels,
                strategy: document.getElementById('strategy').value,
                risk_tolerance: parseFloat(document.getElementById('riskTolerance').value)
            };
            
            try {
                const response = await fetch('/api/financial/allocate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                if (result.success) {
                    activeJobs.add(result.job_id);
                    showAlert('Resource allocation optimization started!', 'success');
                    monitorJob(result.job_id, 'allocationResults', 'allocationResultsContent');
                } else {
                    showAlert('Failed to start allocation: ' + result.message, 'danger');
                }
            } catch (error) {
                showAlert('Error starting allocation: ' + error.message, 'danger');
            }
        });
        
        document.getElementById('optimizationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                const currentAllocations = JSON.parse(document.getElementById('currentAllocations').value);
                const performanceData = JSON.parse(document.getElementById('performanceData').value);
                
                const formData = {
                    current_allocations: currentAllocations,
                    performance_data: performanceData,
                    optimization_target: document.getElementById('optimizationTarget').value
                };
                
                const response = await fetch('/api/financial/optimize-roi', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                if (result.success) {
                    activeJobs.add(result.job_id);
                    showAlert('ROI optimization started!', 'success');
                    monitorJob(result.job_id, 'optimizationResults', 'optimizationResultsContent');
                } else {
                    showAlert('Failed to start optimization: ' + result.message, 'danger');
                }
            } catch (error) {
                showAlert('Error: ' + error.message, 'danger');
            }
        });
        
        document.getElementById('reportForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const channels = document.getElementById('reportChannels').value;
            const formData = {
                start_date: document.getElementById('startDate').value + 'T00:00:00',
                end_date: document.getElementById('endDate').value + 'T23:59:59',
                channels: channels ? channels.split(',').map(c => c.trim()) : null,
                report_type: document.getElementById('reportType').value
            };
            
            try {
                const response = await fetch('/api/financial/report', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                if (result.success) {
                    activeJobs.add(result.job_id);
                    showAlert('Report generation started!', 'success');
                    monitorJob(result.job_id, 'reportResults', 'reportResultsContent');
                } else {
                    showAlert('Failed to start report generation: ' + result.message, 'danger');
                }
            } catch (error) {
                showAlert('Error starting report: ' + error.message, 'danger');
            }
        });
        
        // Job monitoring
        async function monitorJob(jobId, resultsDiv, contentDiv) {
            const checkStatus = async () => {
                try {
                    const response = await fetch(`/api/financial/status/${jobId}`);
                    const status = await response.json();
                    
                    if (status.status === 'completed') {
                        activeJobs.delete(jobId);
                        document.getElementById(resultsDiv).style.display = 'block';
                        displayResults(status.result, contentDiv);
                        loadJobs(); // Refresh jobs list
                    } else if (status.status === 'failed') {
                        activeJobs.delete(jobId);
                        showAlert('Job failed: ' + status.error, 'danger');
                        loadJobs(); // Refresh jobs list
                    } else {
                        // Still processing, check again
                        setTimeout(checkStatus, 2000);
                    }
                } catch (error) {
                    console.error('Error checking job status:', error);
                    activeJobs.delete(jobId);
                }
            };
            
            checkStatus();
        }
        
        // Display results
        function displayResults(result, contentDiv) {
            const container = document.getElementById(contentDiv);
            
            if (result.channel_id) {
                // Profitability analysis results
                container.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Channel: ${result.channel_id}</h6>
                            <p><strong>Revenue:</strong> $${result.revenue.toLocaleString()}</p>
                            <p><strong>Costs:</strong> $${result.costs.toLocaleString()}</p>
                            <p><strong>Profit:</strong> $${result.profit.toLocaleString()}</p>
                        </div>
                        <div class="col-md-6">
                            <h6>Performance Metrics</h6>
                            <p><strong>ROI:</strong> ${result.roi_percentage.toFixed(2)}%</p>
                            <p><strong>Profitability Score:</strong> ${result.profitability_score}/100</p>
                        </div>
                    </div>
                    <div class="mt-3">
                        <h6>Recommendations</h6>
                        <ul>
                            ${result.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                        </ul>
                    </div>
                `;
            } else if (result.allocations) {
                // Resource allocation results
                const allocationsHtml = Object.entries(result.allocations)
                    .map(([channel, amount]) => `<li>${channel}: $${amount.toLocaleString()}</li>`)
                    .join('');
                
                container.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Allocation Strategy: ${result.strategy}</h6>
                            <p><strong>Total Budget:</strong> $${result.total_budget.toLocaleString()}</p>
                            <p><strong>Expected ROI:</strong> ${result.expected_roi}%</p>
                            <p><strong>Risk Score:</strong> ${result.risk_score}/100</p>
                        </div>
                        <div class="col-md-6">
                            <h6>Channel Allocations</h6>
                            <ul>${allocationsHtml}</ul>
                        </div>
                    </div>
                `;
            } else if (result.optimized_allocations) {
                // ROI optimization results
                const currentHtml = Object.entries(result.current_allocations)
                    .map(([channel, amount]) => `<li>${channel}: $${amount.toLocaleString()}</li>`)
                    .join('');
                const optimizedHtml = Object.entries(result.optimized_allocations)
                    .map(([channel, amount]) => `<li>${channel}: $${amount.toLocaleString()}</li>`)
                    .join('');
                
                container.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Current Allocations</h6>
                            <ul>${currentHtml}</ul>
                        </div>
                        <div class="col-md-6">
                            <h6>Optimized Allocations</h6>
                            <ul>${optimizedHtml}</ul>
                        </div>
                    </div>
                    <div class="mt-3">
                        <p><strong>Expected ROI Improvement:</strong> ${result.expected_roi_improvement}%</p>
                        <p><strong>Optimization Confidence:</strong> ${result.optimization_confidence}%</p>
                        <h6>Recommendations</h6>
                        <ul>
                            ${result.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                        </ul>
                    </div>
                `;
            } else if (result.summary) {
                // Financial report results
                const channelHtml = Object.entries(result.channel_performance)
                    .map(([channel, data]) => `
                        <tr>
                            <td>${channel}</td>
                            <td>$${data.revenue.toLocaleString()}</td>
                            <td>$${data.costs.toLocaleString()}</td>
                            <td>${data.roi}%</td>
                        </tr>
                    `).join('');
                
                container.innerHTML = `
                    <div class="mb-4">
                        <h6>Report Period: ${result.report_period}</h6>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h5 class="text-success">$${result.summary.total_revenue.toLocaleString()}</h5>
                                        <small>Total Revenue</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h5 class="text-danger">$${result.summary.total_costs.toLocaleString()}</h5>
                                        <small>Total Costs</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h5 class="text-primary">$${result.summary.net_profit.toLocaleString()}</h5>
                                        <small>Net Profit</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h5 class="text-info">${result.summary.roi_percentage}%</h5>
                                        <small>ROI</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-4">
                        <h6>Channel Performance</h6>
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Channel</th>
                                    <th>Revenue</th>
                                    <th>Costs</th>
                                    <th>ROI</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${channelHtml}
                            </tbody>
                        </table>
                    </div>
                    <div>
                        <h6>Key Trends</h6>
                        <ul>
                            ${result.trends.map(trend => `<li>${trend}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
        }
        
        // Load jobs
        async function loadJobs() {
            try {
                const response = await fetch('/api/financial/jobs');
                const data = await response.json();
                
                const jobsList = document.getElementById('jobsList');
                
                if (data.jobs.length === 0) {
                    jobsList.innerHTML = `
                        <div class="text-center py-4 text-muted">
                            <i class="fas fa-inbox fa-3x mb-3"></i>
                            <p>No financial jobs found</p>
                        </div>
                    `;
                    return;
                }
                
                const jobsHtml = data.jobs.map(job => {
                    const statusColor = {
                        'completed': 'success',
                        'failed': 'danger',
                        'processing': 'primary'
                    }[job.status] || 'secondary';
                    
                    return `
                        <div class="card job-item mb-3">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="card-title">${job.type.replace('_', ' ').toUpperCase()}</h6>
                                        <p class="card-text text-muted mb-1">Job ID: ${job.job_id}</p>
                                        <small class="text-muted">Created: ${new Date(job.created_at).toLocaleString()}</small>
                                    </div>
                                    <div class="text-end">
                                        <span class="badge bg-${statusColor} status-badge">${job.status.toUpperCase()}</span>
                                        <div class="progress mt-2" style="width: 100px;">
                                            <div class="progress-bar" role="progressbar" style="width: ${job.progress}%"></div>
                                        </div>
                                        <small class="text-muted">${job.progress.toFixed(1)}%</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                jobsList.innerHTML = jobsHtml;
                
            } catch (error) {
                console.error('Error loading jobs:', error);
                document.getElementById('jobsList').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error loading jobs: ${error.message}
                    </div>
                `;
            }
        }
        
        // Refresh jobs
        function refreshJobs() {
            loadJobs();
        }
        
        // Show alert
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.insertBefore(alertDiv, document.body.firstChild);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }
        
        // Auto-refresh jobs every 30 seconds
        setInterval(() => {
            if (activeJobs.size > 0) {
                loadJobs();
            }
        }, 30000);
    </script>
</body>
</html>