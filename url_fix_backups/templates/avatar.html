<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} - AI Avatar Generation</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .progress-bar {
            transition: width 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav class="gradient-bg shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="/" class="text-white text-xl font-bold">
                        <i class="fas fa-robot mr-2"></i>AI Production Suite
                    </a>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/" class="text-white hover:text-gray-200 px-3 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-home mr-1"></i>Home
                    </a>
                    <a href="/chat" class="text-white hover:text-gray-200 px-3 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-comments mr-1"></i>Chat
                    </a>
                    <a href="/places" class="text-white hover:text-gray-200 px-3 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-map-marker-alt mr-1"></i>Places
                    </a>
                    <a href="/paste" class="text-white hover:text-gray-200 px-3 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-clipboard mr-1"></i>Paste
                    </a>
                    <a href="/avatar" class="bg-white bg-opacity-20 text-white px-3 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-user-circle mr-1"></i>Avatar
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900 mb-4">
                <i class="fas fa-magic text-purple-600 mr-3"></i>
                AI Avatar Generation
            </h1>
            <p class="text-xl text-gray-600 max-w-3xl mx-auto">
                Create stunning AI-powered avatars with voice synthesis and 3D character generation
            </p>
        </div>

        <!-- Engine Status -->
        <div class="mb-8">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">
                    <i class="fas fa-cogs text-blue-600 mr-2"></i>
                    Available Engines
                </h2>
                <div id="engine-status" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Engine status will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Generation Forms -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Standard Avatar Generation -->
            <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">
                    <i class="fas fa-video text-green-600 mr-2"></i>
                    Standard Avatar
                </h2>
                <form id="avatar-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Text to Speak</label>
                        <textarea id="avatar-text" name="text" rows="4" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                placeholder="Enter the text you want your avatar to speak..."
                                required></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Avatar Engine</label>
                        <select id="avatar-engine" name="engine" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <option value="linly-talker">Linly-Talker</option>
                            <option value="talking-heads">Talking Heads</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Gender</label>
                        <select id="avatar-gender" name="gender" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <option value="neutral">Neutral</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Source Image (Optional)</label>
                        <input type="file" id="source-image" name="source_image" accept="image/*"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    
                    <button type="submit" 
                            class="w-full bg-gradient-to-r from-purple-600 to-blue-600 text-white py-3 px-4 rounded-md hover:from-purple-700 hover:to-blue-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition duration-200">
                        <i class="fas fa-play mr-2"></i>
                        Generate Avatar
                    </button>
                </form>
            </div>

            <!-- 3D Avatar Generation -->
            <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">
                    <i class="fas fa-cube text-blue-600 mr-2"></i>
                    3D Avatar
                </h2>
                <form id="avatar-3d-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Character Description</label>
                        <textarea id="character-description" name="character_description" rows="3" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="Describe the 3D character you want to create..."
                                required></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Gender</label>
                        <select id="avatar-3d-gender" name="gender" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="neutral">Neutral</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Animation Type</label>
                        <select id="animation-type" name="animation_type" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="idle">Idle</option>
                            <option value="talking">Talking</option>
                            <option value="walking">Walking</option>
                            <option value="waving">Waving</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Voice Text (Optional)</label>
                        <textarea id="voice-text" name="voice_text" rows="2" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="Text for voice synthesis (optional)..."></textarea>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Export Format</label>
                            <select id="export-format" name="export_format" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="mp4">MP4 Video</option>
                                <option value="fbx">FBX Model</option>
                                <option value="obj">OBJ Model</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Quality</label>
                            <select id="quality" name="quality" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="medium">Medium</option>
                                <option value="low">Low</option>
                                <option value="high">High</option>
                            </select>
                        </div>
                    </div>
                    
                    <button type="submit" 
                            class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-3 px-4 rounded-md hover:from-blue-700 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200">
                        <i class="fas fa-cube mr-2"></i>
                        Generate 3D Avatar
                    </button>
                </form>
            </div>
        </div>

        <!-- Generation Status -->
        <div id="generation-status" class="mt-8 hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">
                    <i class="fas fa-tasks text-yellow-600 mr-2"></i>
                    Generation Status
                </h3>
                <div id="status-content">
                    <!-- Status content will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Recent Jobs -->
        <div class="mt-8">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">
                    <i class="fas fa-history text-gray-600 mr-2"></i>
                    Recent Jobs
                </h3>
                <div id="recent-jobs">
                    <!-- Recent jobs will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        let currentJobId = null;
        let statusInterval = null;

        // Load engine status on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadEngineStatus();
            loadRecentJobs();
        });

        // Load available engines
        async function loadEngineStatus() {
            try {
                const response = await fetch('/avatar/engines');
                const data = await response.json();
                
                const statusContainer = document.getElementById('engine-status');
                statusContainer.innerHTML = '';
                
                if (data.engines && data.engines.length > 0) {
                    data.engines.forEach(engine => {
                        const engineCard = document.createElement('div');
                        engineCard.className = `p-4 rounded-lg border-2 ${engine.healthy ? 'border-green-200 bg-green-50' : 'border-red-200 bg-red-50'}`;
                        engineCard.innerHTML = `
                            <div class="flex items-center justify-between">
                                <h4 class="font-semibold text-gray-800">${engine.name}</h4>
                                <span class="px-2 py-1 rounded-full text-xs font-medium ${
                                    engine.healthy ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                                }">
                                    ${engine.healthy ? 'Healthy' : 'Offline'}
                                </span>
                            </div>
                        `;
                        statusContainer.appendChild(engineCard);
                    });
                } else {
                    statusContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center">No engines available</p>';
                }
            } catch (error) {
                console.error('Error loading engine status:', error);
                document.getElementById('engine-status').innerHTML = '<p class="text-red-500 col-span-full text-center">Error loading engine status</p>';
            }
        }

        // Handle standard avatar form submission
        document.getElementById('avatar-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = {
                text: formData.get('text'),
                engine: formData.get('engine'),
                gender: formData.get('gender'),
                voice_settings: {},
                video_settings: {}
            };
            
            // Handle source image upload if provided
            const sourceImage = document.getElementById('source-image').files[0];
            if (sourceImage) {
                try {
                    const uploadResponse = await fetch('/avatar/upload-image', {
                        method: 'POST',
                        body: (() => {
                            const fd = new FormData();
                            fd.append('file', sourceImage);
                            return fd;
                        })()
                    });
                    const uploadData = await uploadResponse.json();
                    if (uploadData.success) {
                        data.source_image = uploadData.file_path;
                    }
                } catch (error) {
                    console.error('Error uploading image:', error);
                }
            }
            
            try {
                const response = await fetch('/avatar/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if (result.job_id) {
                    currentJobId = result.job_id;
                    showGenerationStatus(result.job_id);
                    startStatusPolling(result.job_id);
                }
            } catch (error) {
                console.error('Error generating avatar:', error);
                alert('Error generating avatar. Please try again.');
            }
        });

        // Handle 3D avatar form submission
        document.getElementById('avatar-3d-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = {
                character_description: formData.get('character_description'),
                gender: formData.get('gender'),
                animation_type: formData.get('animation_type'),
                voice_text: formData.get('voice_text'),
                export_format: formData.get('export_format'),
                quality: formData.get('quality')
            };
            
            try {
                const response = await fetch('/avatar/generate-3d', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if (result.job_id) {
                    currentJobId = result.job_id;
                    showGenerationStatus(result.job_id);
                    startStatusPolling(result.job_id);
                }
            } catch (error) {
                console.error('Error generating 3D avatar:', error);
                alert('Error generating 3D avatar. Please try again.');
            }
        });

        // Show generation status
        function showGenerationStatus(jobId) {
            const statusDiv = document.getElementById('generation-status');
            statusDiv.classList.remove('hidden');
            statusDiv.scrollIntoView({ behavior: 'smooth' });
        }

        // Start polling for status updates
        function startStatusPolling(jobId) {
            if (statusInterval) {
                clearInterval(statusInterval);
            }
            
            statusInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/avatar/status/${jobId}`);
                    const status = await response.json();
                    
                    updateStatusDisplay(status);
                    
                    if (status.status === 'completed' || status.status === 'failed') {
                        clearInterval(statusInterval);
                        loadRecentJobs(); // Refresh recent jobs
                    }
                } catch (error) {
                    console.error('Error checking status:', error);
                }
            }, 2000);
        }

        // Update status display
        function updateStatusDisplay(status) {
            const statusContent = document.getElementById('status-content');
            
            let progressBar = '';
            if (status.progress !== null) {
                progressBar = `
                    <div class="w-full bg-gray-200 rounded-full h-2 mb-4">
                        <div class="bg-blue-600 h-2 rounded-full progress-bar" style="width: ${status.progress}%"></div>
                    </div>
                `;
            }
            
            let actionButton = '';
            if (status.status === 'completed' && status.result_url) {
                actionButton = `
                    <a href="/avatar/download/${status.job_id}" 
                       class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition duration-200">
                        <i class="fas fa-download mr-2"></i>
                        Download Result
                    </a>
                `;
            }
            
            statusContent.innerHTML = `
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <p class="text-sm text-gray-600">Job ID: ${status.job_id}</p>
                        <p class="text-lg font-semibold text-gray-800">Status: 
                            <span class="px-2 py-1 rounded-full text-sm ${
                                status.status === 'completed' ? 'bg-green-100 text-green-800' :
                                status.status === 'failed' ? 'bg-red-100 text-red-800' :
                                'bg-yellow-100 text-yellow-800'
                            }">
                                ${status.status}
                            </span>
                        </p>
                    </div>
                    ${actionButton}
                </div>
                ${progressBar}
                ${status.error ? `<p class="text-red-600 mt-2">Error: ${status.error}</p>` : ''}
            `;
        }

        // Load recent jobs
        async function loadRecentJobs() {
            try {
                const response = await fetch('/avatar/jobs');
                const data = await response.json();
                
                const jobsContainer = document.getElementById('recent-jobs');
                
                if (data.jobs && data.jobs.length > 0) {
                    jobsContainer.innerHTML = data.jobs.slice(0, 5).map(job => `
                        <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg mb-2">
                            <div>
                                <p class="font-medium text-gray-800">${job.job_id.substring(0, 8)}...</p>
                                <p class="text-sm text-gray-600">${new Date(job.created_at).toLocaleString()}</p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="px-2 py-1 rounded-full text-xs font-medium ${
                                    job.status === 'completed' ? 'bg-green-100 text-green-800' :
                                    job.status === 'failed' ? 'bg-red-100 text-red-800' :
                                    'bg-yellow-100 text-yellow-800'
                                }">
                                    ${job.status}
                                </span>
                                ${job.status === 'completed' ? `
                                    <a href="/avatar/download/${job.job_id}" 
                                       class="text-blue-600 hover:text-blue-800">
                                        <i class="fas fa-download"></i>
                                    </a>
                                ` : ''}
                            </div>
                        </div>
                    `).join('');
                } else {
                    jobsContainer.innerHTML = '<p class="text-gray-500 text-center">No recent jobs</p>';
                }
            } catch (error) {
                console.error('Error loading recent jobs:', error);
                document.getElementById('recent-jobs').innerHTML = '<p class="text-red-500 text-center">Error loading recent jobs</p>';
            }
        }
    </script>
</body>
</html>