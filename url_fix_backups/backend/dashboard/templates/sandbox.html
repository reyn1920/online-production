<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Creative Sandbox - TRAE.AI</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: linear-gradient(135deg, #0f1419 0%, #1a1f2e 100%);
        color: #e6e6e6;
        min-height: 100vh;
      }

      .navbar {
        background: rgba(26, 31, 46, 0.95);
        backdrop-filter: blur(10px);
        padding: 1rem 2rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .navbar h1 {
        color: #00d4ff;
        font-size: 1.5rem;
        font-weight: 600;
      }

      .nav-tabs {
        display: flex;
        gap: 1rem;
      }

      .nav-tab {
        padding: 0.5rem 1rem;
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: #e6e6e6;
        text-decoration: none;
        border-radius: 6px;
        transition: all 0.3s ease;
      }

      .nav-tab:hover {
        background: rgba(0, 212, 255, 0.1);
        border-color: #00d4ff;
      }

      .nav-tab.active {
        background: #00d4ff;
        color: #0f1419;
        border-color: #00d4ff;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
      }

      .sandbox-header {
        text-align: center;
        margin-bottom: 2rem;
      }

      .sandbox-header h2 {
        font-size: 2.5rem;
        margin-bottom: 1rem;
        background: linear-gradient(135deg, #00d4ff, #0099cc);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .sandbox-header p {
        font-size: 1.1rem;
        opacity: 0.8;
        max-width: 600px;
        margin: 0 auto;
      }

      .controls-panel {
        background: rgba(26, 31, 46, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 2rem;
      }

      .form-group {
        margin-bottom: 1.5rem;
      }

      .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: #00d4ff;
      }

      .form-group select,
      .form-group input {
        width: 100%;
        padding: 0.75rem;
        background: rgba(15, 20, 25, 0.8);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 6px;
        color: #e6e6e6;
        font-size: 1rem;
      }

      .form-group select:focus,
      .form-group input:focus {
        outline: none;
        border-color: #00d4ff;
        box-shadow: 0 0 0 2px rgba(0, 212, 255, 0.2);
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
      }

      .run-button {
        background: linear-gradient(135deg, #00d4ff, #0099cc);
        color: #0f1419;
        border: none;
        padding: 1rem 2rem;
        border-radius: 8px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        width: 100%;
      }

      .run-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 212, 255, 0.3);
      }

      .run-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .status-panel {
        background: rgba(26, 31, 46, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
      }

      .status-indicator {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
      }

      .status-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #666;
      }

      .status-dot.idle {
        background: #666;
      }
      .status-dot.running {
        background: #00d4ff;
        animation: pulse 2s infinite;
      }
      .status-dot.success {
        background: #00ff88;
      }
      .status-dot.error {
        background: #ff4444;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .progress-bar {
        width: 100%;
        height: 6px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 3px;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #00d4ff, #0099cc);
        width: 0%;
        transition: width 0.3s ease;
      }

      .viewer-panel {
        background: rgba(26, 31, 46, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 2rem;
        min-height: 400px;
      }

      .viewer-panel h3 {
        margin-bottom: 1rem;
        color: #00d4ff;
      }

      .media-viewer {
        width: 100%;
        min-height: 300px;
        background: rgba(15, 20, 25, 0.8);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #666;
      }

      .media-viewer video,
      .media-viewer embed {
        width: 100%;
        height: auto;
        border-radius: 8px;
      }

      .log-output {
        background: rgba(15, 20, 25, 0.9);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 6px;
        padding: 1rem;
        font-family: 'Monaco', 'Menlo', monospace;
        font-size: 0.9rem;
        max-height: 200px;
        overflow-y: auto;
        margin-top: 1rem;
      }

      .autorun-notice {
        background: rgba(0, 212, 255, 0.1);
        border: 1px solid rgba(0, 212, 255, 0.3);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 2rem;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <nav class="navbar">
      <h1>🎨 TRAE.AI</h1>
      <div class="nav-tabs">
        <a href="/" class="nav-tab">Dashboard</a>
        <a href="/sandbox" class="nav-tab active">Creative Sandbox</a>
      </div>
    </nav>

    <div class="container">
      <div class="sandbox-header">
        <h2>Creative Sandbox</h2>
        <p>
          Generate and preview creative content using the "Run one channel" action. Select a channel and watch your
          content come to life in real-time.
        </p>
      </div>

      {% if autorun %}
      <div class="autorun-notice">
        <strong>🚀 Auto-running:</strong>
        {{ autorun_channel }} channel is being processed automatically.
      </div>
      {% endif %}

      <div class="controls-panel">
        <form id="sandboxForm">
          <div class="form-row">
            <div class="form-group">
              <label for="channel">Channel</label>
              <select id="channel" name="channel" required>
                <option value="">Select a channel...</option>
                {% for channel in channels %}
                <option
                  value="{{ channel.name }}"
                  {%
                  if
                  autorun
                  and
                  channel.name=""
                  ="autorun_channel"
                  %}selected{%
                  endif
                  %}
                >
                  {{ channel.name }} - {{ channel.description }}
                </option>
                {% endfor %}
              </select>
            </div>
            <div class="form-group">
              <label for="preview_duration">Preview Duration</label>
              <select id="preview_duration" name="preview_duration">
                <option value="60">1 minute</option>
                <option value="300">5 minutes</option>
                <option value="600">10 minutes</option>
                <option value="full">Full length</option>
              </select>
            </div>
          </div>

          <button type="submit" class="run-button" id="runButton">🎬 Generate Content</button>
        </form>
      </div>

      <div class="status-panel">
        <div class="status-indicator">
          <div class="status-dot" id="statusDot"></div>
          <span id="statusText">Ready to generate content</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="log-output" id="logOutput" style="display: none"></div>
      </div>

      <div class="viewer-panel">
        <h3>Generated Content</h3>
        <div class="media-viewer" id="mediaViewer">
          <p>Content will appear here after generation...</p>
        </div>
      </div>
    </div>

    <script>
      let currentTaskId = null;
      let pollInterval = null;

      // Auto-run functionality
      {% if autorun %}
      document.addEventListener('DOMContentLoaded', function() {
          setTimeout(function() {
              document.getElementById('sandboxForm').dispatchEvent(new Event('submit'));
          }, 1000);
      });
      {% endif %}

      document.getElementById('sandboxForm').addEventListener('submit', async function(e) {
          e.preventDefault();

          const formData = new FormData(this);
          const channel = formData.get('channel');
          const previewDuration = formData.get('preview_duration');

          if (!channel) {
              alert('Please select a channel');
              return;
          }

          setStatus('running', 'Generating content...');
          setProgress(10);

          try {
              const response = await fetch('/sandbox/run', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                      channel: channel,
                      preview_duration: previewDuration
                  })
              });

              const result = await response.json();

              if (result.ok) {
                  currentTaskId = result.task_id;
                  setProgress(25);
                  startPolling();
              } else {
                  setStatus('error', result.error || 'Failed to start generation');
                  showLog(result.error || 'Unknown error');
              }
          } catch (error) {
              setStatus('error', 'Network error: ' + error.message);
              showLog('Network error: ' + error.message);
          }
      });

      function startPolling() {
          if (pollInterval) clearInterval(pollInterval);

          pollInterval = setInterval(async function() {
              if (!currentTaskId) return;

              try {
                  const response = await fetch(`/sandbox/status/${currentTaskId}`);
                  const status = await response.json();

                  if (status.completed) {
                      clearInterval(pollInterval);

                      if (status.success) {
                          setStatus('success', 'Content generated successfully!');
                          setProgress(100);

                          if (status.output_path) {
                              displayMedia(status.output_path);
                          }
                      } else {
                          setStatus('error', status.error || 'Generation failed');
                          showLog(status.error || 'Unknown error');
                      }
                  } else {
                      // Update progress based on status
                      const progress = Math.min(90, 25 + (status.progress || 0) * 0.65);
                      setProgress(progress);

                      if (status.message) {
                          setStatus('running', status.message);
                      }
                  }
              } catch (error) {
                  console.error('Polling error:', error);
              }
          }, 2000);
      }

      function setStatus(type, message) {
          const dot = document.getElementById('statusDot');
          const text = document.getElementById('statusText');
          const button = document.getElementById('runButton');

          dot.className = `status-dot ${type}`;
          text.textContent = message;

          button.disabled = type === 'running';
          if (type === 'running') {
              button.textContent = '⏳ Generating...';
          } else {
              button.textContent = '🎬 Generate Content';
          }
      }

      function setProgress(percent) {
          document.getElementById('progressFill').style.width = percent + '%';
      }

      function showLog(message) {
          const logOutput = document.getElementById('logOutput');
          logOutput.style.display = 'block';
          logOutput.textContent = message;
      }

      function displayMedia(outputPath) {
          const viewer = document.getElementById('mediaViewer');
          const fileExt = outputPath.split('.').pop().toLowerCase();

          if (['mp4', 'webm', 'mov'].includes(fileExt)) {
              viewer.innerHTML = `
                  <video controls>
                      <source src="/sandbox/asset/${encodeURIComponent(outputPath)}" type="video/${fileExt}">
                      Your browser does not support the video tag.
                  </video>
              `;
          } else if (['pdf'].includes(fileExt)) {
              viewer.innerHTML = `
                  <embed src="/sandbox/asset/${encodeURIComponent(outputPath)}" type="application/pdf" width="100%" height="400px">
              `;
          } else {
              viewer.innerHTML = `
                  <p>Generated file: <a href="/sandbox/asset/${encodeURIComponent(outputPath)}" target="_blank">${outputPath}</a></p>
              `;
          }
      }
    </script>
  </body>
</html>
