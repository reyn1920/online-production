# TRAE.AI Test Environment Nginx Configuration
# Optimized for automated testing and CI/CD pipeline

events {
    worker_connections 1024;
    use epoll;
    multi_accept on;
}

http {
    include/etc/nginx/mime.types;
    default_type application/octet-stream;

    # Basic Settings
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    client_max_body_size 100M;

    # Logging (minimal for tests)
    access_log/var/log/nginx/access.log;
    error_log/var/log/nginx/error.log warn;

    # Gzip Compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/atom+xml
        image/svg+xml;

    # Test Environment Upstreams
    upstream content_agent_test {
        server content-agent-test:8000;
    }

    upstream marketing_agent_test {
        server marketing-agent-test:8000;
    }

    upstream monetization_bundle_test {
        server monetization-bundle-test:8000;
    }

    upstream analytics_dashboard_test {
        server analytics-dashboard-test:8000;
    }

    # Main Test Server
    server {
        listen 80;
        server_name localhost;

        # Security Headers (basic for testing)
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;

        # Health Check Endpoint
        location/health {
            access_log off;
            return 200 '{"status":"healthy","environment":"test","timestamp":"$time_iso8601"}';
            add_header Content-Type application/json;
        }

        # System Status for Tests
        location/test/status {
            access_log off;
            return 200 '{"services":{"content_agent":"http://content-agent-test:8000","marketing_agent":"http://marketing-agent-test:8000","monetization_bundle":"http://monetization-bundle-test:8000","analytics_dashboard":"http://analytics-dashboard-test:8000"},"environment":"test"}';
            add_header Content-Type application/json;
        }

        # Content Agent API
        location/api/content/{
            proxy_pass http://content_agent_test/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }

        # Marketing Agent API
        location/api/marketing/{
            proxy_pass http://marketing_agent_test/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }

        # Monetization Bundle API
        location/api/monetization/{
            proxy_pass http://monetization_bundle_test/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }

        # Analytics Dashboard API
        location/api/analytics/{
            proxy_pass http://analytics_dashboard_test/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }

        # Test File Uploads
        location/api/upload/{
            proxy_pass http://content_agent_test/upload/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            client_max_body_size 100M;
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # Static Test Files
        location/static/{
            alias/var/www/static/;
            expires 1h;
            add_header Cache-Control "public, immutable";
        }

        # Test Output Files
        location/test-output/{
            alias/var/www/static/;
            autoindex on;
            autoindex_exact_size off;
            autoindex_localtime on;
        }

        # API Documentation (Test Mode)
        location/docs {
            proxy_pass http://content_agent_test/docs;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # OpenAPI Schema
        location/openapi.json {
            proxy_pass http://content_agent_test/openapi.json;
            proxy_set_header Host $host;
            add_header Cache-Control "no-cache";
        }

        # Test Metrics Endpoint
        location/metrics {
            proxy_pass http://analytics_dashboard_test/metrics;
            proxy_set_header Host $host;
            access_log off;
        }

        # Default Test Page
        location/{
            return 200 '<!DOCTYPE html><html><head><title>TRAE.AI Test Environment</title></head><body><h1>ðŸ§ª TRAE.AI Test Environment</h1><p>All systems operational for testing.</p><ul><li><a href="/health">Health Check</a></li><li><a href="/test/status">System Status</a></li><li><a href="/docs">API Documentation</a></li><li><a href="/test-output/">Test Output Files</a></li></ul></body></html>';
            add_header Content-Type text/html;
        }

        # Error Pages
        error_page 404/404.html;
        error_page 500 502 503 504/50x.html;

        location =/404.html {
            return 404 '{"error":"Not Found","environment":"test"}';
            add_header Content-Type application/json;
        }

        location =/50x.html {
            return 500 '{"error":"Internal Server Error","environment":"test"}';
            add_header Content-Type application/json;
        }
    }
}
