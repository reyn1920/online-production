<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>No‑Code Editor — TRAE.AI</title>
  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system; margin: 0; background: #0b0b0c; color: #f2f2f2; }
    header { padding: 16px 20px; background: #121214; border-bottom: 1px solid #222; }
    h1 { margin: 0; font-size: 18px; }
    main { display: grid; grid-template-columns: 280px 1fr; gap: 16px; padding: 16px; }
    .panel { background: #141418; border: 1px solid #1f1f24; border-radius: 12px; padding: 12px; }
    .btn { display: inline-block; border: 1px solid #333; padding: 8px 10px; border-radius: 8px; background: #1a1a1f; cursor: pointer; margin: 4px 2px; }
    .btn:hover { background: #23232a; }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    textarea, input { width: 100%; background: #0f0f13; color: #eaeaea; border: 1px solid #2a2a31; border-radius: 8px; padding: 8px; }
    .log { white-space: pre-wrap; background: #0e0e11; border: 1px solid #222; border-radius: 8px; padding: 8px; height: 280px; overflow: auto; }
    .step { border: 1px dashed #333; border-radius: 10px; padding: 8px; margin: 6px 0; }
    .muted { color: #a2a2aa; font-size: 12px; }
  </style>
</head>
<body>
  <header><h1>TRAE.AI — No‑Code Editor (local‑first)</h1></header>
  <main>
    <section class="panel">
      <h3>Actions</h3>
      <div class="row">
        <button class="btn" onclick="run('quick')">Quick sweep</button>
        <button class="btn" onclick="run('ci')">Full sweep</button>
        <button class="btn" onclick="run('rca')">RCA → patch</button>
        <button class="btn" onclick="run('upr')">UPR gate</button>
      </div>
      <h3>Write file</h3>
      <input id="relPath" placeholder="path/to/file.ext" />
      <textarea id="fileContent" rows="6" placeholder="content"></textarea>
      <button class="btn" onclick="writeFile()">Save</button>
      <h3>LLM generate → file</h3>
      <textarea id="llmPrompt" rows="6" placeholder="prompt"></textarea>
      <input id="genPath" placeholder="output/path.ext" />
      <button class="btn" onclick="llmGen()">Generate</button>
      <p class="muted">Uses local Ollama model. Set OLLAMA_MODEL env var to change model.</p>
    </section>
    <section class="panel">
      <h3>Flow builder</h3>
      <div id="steps"></div>
      <div class="row">
        <button class="btn" onclick="addRun()">+ Run</button>
        <button class="btn" onclick="addWrite()">+ Write</button>
        <button class="btn" onclick="addLLM()">+ LLM</button>
        <button class="btn" onclick="sendFlow()">Run Flow</button>
      </div>
      <h3>Log</h3>
      <div id="log" class="log"></div>
    </section>
  </main>
  <script>
    const api = (path, body) => fetch(path, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(body||{}) }).then(r => r.json());
    const logEl = document.getElementById("log");
    function append(text){ logEl.textContent += text + "\n"; logEl.scrollTop = logEl.scrollHeight; }

    async function run(action){
      append("Running: " + action);
      const res = await api("http://localhost:4455/run", { action });
      append((res.ok?"OK ":"ERR ") + (res.stdout || res.error || "") + (res.stderr? "\n" + res.stderr : ""));
    }
    async function writeFile(){
      const relPath = document.getElementById("relPath").value;
      const content = document.getElementById("fileContent").value;
      const res = await api("http://localhost:4455/write", { relPath, content });
      append(res.ok ? "Saved: " + res.path : "ERR " + (res.error||""));
    }
    async function llmGen(){
      const prompt = document.getElementById("llmPrompt").value;
      const relPath = document.getElementById("genPath").value;
      const res = await api("http://localhost:4455/llm-generate", { prompt, relPath });
      append(res.ok ? "Generated: " + res.path + " (" + res.bytes + " bytes)" : "ERR " + (res.error||""));
    }

    function addRun(){
      const box = document.createElement("div"); box.className = "step";
      box.innerHTML = '<b>Run</b><br/><input placeholder="shell command" class="cmd" />';
      document.getElementById("steps").appendChild(box);
    }
    function addWrite(){
      const box = document.createElement("div"); box.className = "step";
      box.innerHTML = '<b>Write</b><br/><input placeholder="path" class="path" /><br/><textarea rows="4" class="content" placeholder="content"></textarea>';
      document.getElementById("steps").appendChild(box);
    }
    function addLLM(){
      const box = document.createElement("div"); box.className = "step";
      box.innerHTML = '<b>LLM</b><br/><textarea rows="4" class="prompt" placeholder="prompt"></textarea>';
      document.getElementById("steps").appendChild(box);
    }
    async function sendFlow(){
      const children = [...document.querySelectorAll("#steps .step")];
      const steps = children.map(el => {
        if (el.innerHTML.startsWith("<b>Run</b>")) return { kind:"run", cmd: el.querySelector(".cmd").value };
        if (el.innerHTML.startsWith("<b>Write</b>")) return { kind:"write", relPath: el.querySelector(".path").value, content: el.querySelector(".content").value };
        if (el.innerHTML.startsWith("<b>LLM</b>")) return { kind:"llm", prompt: el.querySelector(".prompt").value };
        return { kind:"unknown" };
      });
      const res = await api("http://localhost:4455/flow", { steps });
      append(JSON.stringify(res, null, 2));
    }
  </script>
</body>
</html>
